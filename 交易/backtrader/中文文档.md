# ä¸€. backtraderä»‹ç»

1. åˆ¶å®šç­–ç•¥

- 1.1 ç¡®å®šæ½œåœ¨çš„å¯è°ƒå‚æ•°
- 1.2 å®ä¾‹åŒ–æ‚¨åœ¨ç­–ç•¥ä¸­éœ€è¦çš„æŒ‡æ ‡
- 1.3 å†™ä¸‹è¿›å…¥/é€€å‡ºå¸‚åœºçš„é€»è¾‘

2. åˆ›å»ºCerebroå¼•æ“ï¼ˆè¥¿ç­ç‰™è¯­å¤§è„‘çš„æ„æ€ï¼‰

- 2.1 æ³¨å…¥ç­–ç•¥
- 2.2 ä½¿ç”¨cerebro.adddataåŠ è½½å›æµ‹æ•°æ®
- 2.3 æ‰§è¡Œcerebro.run
- 2.4 ä½¿ç”¨cerebro.plotç»˜åˆ¶å¯è§†åŒ–å›¾è¡¨

backtraderæ˜¯é«˜åº¦å¯é…ç½®çš„ï¼Œå¸Œæœ›å¤§å®¶å‘ç°å…¶ä¸­çš„ä¹è¶£ã€‚
# äºŒ. backtraderå®‰è£…

åŸºæœ¬è¦æ±‚æ˜¯ï¼š Python 2.7 Python 3.2 / 3.3 / 3.4 / 3.5 å¦‚æœ‰ç»˜å›¾éœ€æ±‚ï¼Œåˆ™è¦æ±‚ Matplotlib> = 1.4.1

```python
!pip install backtrader -i https://mirrors.cloud.tencent.com/pypi/simple
```

```
Looking in indexes: https://mirrors.cloud.tencent.com/pypi/simple
Requirement already satisfied: backtrader in /opt/conda/lib/python3.6/site-packages (1.9.76.123)
[33mWARNING: You are using pip version 20.3.3; however, version 21.3.1 is available.
You should consider upgrading via the '/opt/conda/bin/python -m pip install --upgrade pip' command.[0m
```

# ä¸‰. backtraderå¿«é€Ÿå¼€å§‹

## 3.1 æŠ˜çº¿

äº¤æ˜“æ•°æ®ï¼ˆData Feedsï¼‰ã€æŠ€æœ¯æŒ‡æ ‡ï¼ˆIndicatorsï¼‰å’Œç­–ç•¥ï¼ˆStrategiesï¼‰éƒ½æ˜¯æŠ˜çº¿ï¼ˆLineï¼‰ã€‚ æŠ˜çº¿ï¼ˆLineï¼‰æ˜¯ç”±ä¸€ç³»åˆ—çš„ç‚¹ç»„æˆçš„ã€‚

é€šå¸¸äº¤æ˜“æ•°æ®ï¼ˆData Feedsï¼‰åŒ…å«ä»¥ä¸‹å‡ ä¸ªç»„æˆéƒ¨åˆ†ï¼š å¼€ç›˜ä»·ï¼ˆ Openï¼‰ã€æœ€é«˜ä»·ï¼ˆHighï¼‰ã€æœ€ä½ä»·ï¼ˆLowï¼‰ã€æ”¶ç›˜ä»·ï¼ˆCloseï¼‰ã€æˆäº¤é‡ï¼ˆVolumeï¼‰ã€æŒä»“é‡ï¼ˆOpenInterestï¼‰ç­‰ã€‚ æ¯”å¦‚ï¼šæ‰€æœ‰çš„å¼€ç›˜ä»·ï¼ˆ Openï¼‰æŒ‰æ—¶é—´ç»„æˆä¸€æ¡æŠ˜çº¿ï¼ˆLineï¼‰ï¼Œé‚£ä¹ˆä¸€ç»„äº¤æ˜“æ•°æ®ï¼ˆData Feedsï¼‰å°±Â åº”è¯¥åŒ…å«äº†6æ¡æŠ˜çº¿ï¼ˆLineï¼‰ã€‚

å†åŠ ä¸Šæ—¶é—´ï¼ˆDateTimeï¼‰ä¸€å…±æœ‰7æ¡æŠ˜çº¿ï¼ˆLineï¼‰ã€‚æ—¶é—´ï¼Œä¸€èˆ¬ç”¨ä½œä¸€ç»„äº¤æ˜“æ•°æ®çš„ä¸»é”®ã€‚

## 3.2 ç´¢å¼•ä»0å¼€å§‹

å½“è®¿é—®ä¸€æ¡æŠ˜çº¿ï¼ˆLineï¼‰çš„æ•°æ®æ—¶ï¼Œä¼šé»˜è®¤ä»ä¸‹æ ‡ä¸º0çš„ä½ç½®å¼€å§‹ï¼Œæœ€åä¸€ä¸ªæ•°æ®é€šè¿‡ä¸‹æ ‡-1æ¥è·å–ã€‚è¿™æ ·çš„è®¾è®¡å’ŒPythonçš„è¿­ä»£å™¨æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æŠ˜çº¿ï¼ˆLineï¼‰æ˜¯å¯ä»¥è¿­ä»£éå†çš„ã€‚

ä¾‹å¦‚ï¼šåˆ›å»ºä¸€ä¸ªç®€å•ç§»åŠ¨å¹³å‡å€¼çš„ç­–ç•¥ï¼ˆå‡å€¼ç­–ç•¥ï¼‰ï¼š self.sma = SimpleMovingAverage(.....)
è®¿é—®æ­¤ç§»åŠ¨å¹³å‡çº¿çš„å½“å‰å€¼çš„æœ€ç®€å•æ–¹æ³•ï¼šav = self.sma[0]
æ‰€ä»¥åœ¨å›æµ‹è¿‡ç¨‹ä¸­ï¼Œæ— éœ€çŸ¥é“å·²ç»å¤„ç†äº†å¤šå°‘æ¡/åˆ†é’Ÿ/å¤©/æœˆï¼Œâ€œ0â€ä¸€ç›´æŒ‡å‘å½“å‰å€¼ã€‚

æŒ‰ç…§Pythonéå†æ•°ç»„çš„æ–¹å¼ï¼Œç”¨ä¸‹æ ‡-1æ¥è®¿é—®æœ€åä¸€ä¸ªå€¼ï¼š previous_value = self.sma[-1] åŒç†ï¼š-2ã€-3ä¸‹æ ‡ä¹Ÿæ˜¯å¯ä»¥ç…§å¸¸ä½¿ç”¨ã€‚

## 3.3 ä»0åˆ°100

å…ˆè·‘ä¸€ä¸ªåŸºæœ¬æ¡†æ¶

```python
import backtrader as bt
import time
```

```python
# åˆ›å»ºCerebroå¼•æ“Â Â 
cerebro = bt.Cerebro() 
#Cerebroå¼•æ“åœ¨åå°åˆ›å»ºbroker(ç»çºªäºº)ï¼Œç³»ç»Ÿé»˜è®¤èµ„é‡‘é‡ä¸º10000 
# å¼•æ“è¿è¡Œå‰æ‰“å°æœŸå‡ºèµ„é‡‘Â Â 
print('ç»„åˆæœŸåˆèµ„é‡‘: %.2f' % cerebro.broker.getvalue()) 
cerebro.run() 
# å¼•æ“è¿è¡Œåæ‰“æœŸæœ«èµ„é‡‘Â Â 
print('ç»„åˆæœŸæœ«èµ„é‡‘: %.2f' % cerebro.broker.getvalue())
```

```
ç»„åˆæœŸåˆèµ„é‡‘: 10000.00
ç»„åˆæœŸæœ«èµ„é‡‘: 10000.00
```

## 3.4 è®¾å®šç°é‡‘

åœ¨é‡‘èä¸–ç•Œä¸­ï¼Œå¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œåªæœ‰Losseræ‰ä»¥1ä¸‡å¼€å§‹ã€‚è®©æˆ‘ä»¬æ›´æ”¹ç°é‡‘å¹¶å†æ¬¡è¿è¡Œè¯¥ç¤ºä¾‹ã€‚

```python
#å¯¼å…¥backtraderæ¡†æ¶Â Â 
import backtrader as bt 
# åˆ›å»ºCerebroå¼•æ“Â Â 
cerebro = bt.Cerebro() 
# Cerebroå¼•æ“åœ¨åå°åˆ›å»ºbroker(ç»çºªäºº)ï¼Œç³»ç»Ÿé»˜è®¤èµ„é‡‘é‡ä¸º10000 
# è®¾ç½®æŠ•èµ„é‡‘é¢100000.0 
cerebro.broker.setcash(100000.0) 
# å¼•æ“è¿è¡Œå‰æ‰“å°æœŸå‡ºèµ„é‡‘Â Â 
print('ç»„åˆæœŸåˆèµ„é‡‘: %.2f' % cerebro.broker.getvalue()) 
cerebro.run() 
# å¼•æ“è¿è¡Œåæ‰“æœŸæœ«èµ„é‡‘Â Â 
print('ç»„åˆæœŸæœ«èµ„é‡‘: %.2f' % cerebro.broker.getvalue())
```

```
ç»„åˆæœŸåˆèµ„é‡‘: 100000.00
ç»„åˆæœŸæœ«èµ„é‡‘: 100000.00
```

## 3.5 åŠ å…¥äº¤æ˜“æ•°æ®

æ‹¥æœ‰ç°é‡‘æ˜¯ä¸€ä»¶å¿«ä¹çš„äº‹ï¼Œè¿™ä¸€åˆ‡èƒŒåæœ€ç»ˆçš„ç›®çš„å°±æ˜¯: ä¸åŠ¨ä¸€æ ¹æ‰‹æŒ‡ï¼Œå°±èƒ½è®©è‡ªåŠ¨åŒ–ç­–ç•¥é€šè¿‡æ“ä½œèµ„äº§çš„äº¤æ˜“æ•°æ®æ¥å¢åŠ ç°é‡‘ã€‚ æ— æ•°æ®ï¼Œä¸å¿«ä¹ï¼Œè®©æˆ‘ä»¬ç»§ç»­åŠ å…¥äº¤æ˜“æ•°æ®ã€‚

```python
import datetime # 
import os.path # è·¯å¾„ç®¡ç†Â Â 
import sys # è·å–å½“å‰è¿è¡Œè„šæœ¬çš„è·¯å¾„ (in argv[0]) 
#å¯¼å…¥backtraderæ¡†æ¶Â Â 
import backtrader as bt 
 
# åˆ›å»ºCerebroå¼•æ“Â Â 
cerebro = bt.Cerebro() 
# Cerebroå¼•æ“åœ¨åå°åˆ›å»ºbroker(ç»çºªäºº)ï¼Œç³»ç»Ÿé»˜è®¤èµ„é‡‘é‡ä¸º10000 

# è·å–å½“å‰è¿è¡Œè„šæœ¬æ‰€åœ¨ç›®å½•Â Â 
modpath = os.path.dirname(os.path.abspath(sys.argv[0])) 
# æ‹¼æ¥åŠ è½½è·¯å¾„Â Â 
datapath = os.path.join(modpath, '/home/mw/input/backtrader7822/orcl-1995-2014.txt') 

# åˆ›å»ºäº¤æ˜“æ•°æ®é›†Â Â 
data = bt.feeds.YahooFinanceCSVData( 
    dataname=datapath, 
    # æ•°æ®å¿…é¡»å¤§äºfromdate 
    fromdate=datetime.datetime(2000, 1, 1), 
    # æ•°æ®å¿…é¡»å°äºtodate 
    todate=datetime.datetime(2000, 12, 31),
    reverse=False) 
# åŠ è½½äº¤æ˜“æ•°æ®Â Â 
cerebro.adddata(data) 

# è®¾ç½®æŠ•èµ„é‡‘é¢100000.0 
cerebro.broker.setcash(100000.0) 
# å¼•æ“è¿è¡Œå‰æ‰“å°æœŸå‡ºèµ„é‡‘Â Â 
print('ç»„åˆæœŸåˆèµ„é‡‘: %.2f' % cerebro.broker.getvalue()) 
cerebro.run() 
# å¼•æ“è¿è¡Œåæ‰“æœŸæœ«èµ„é‡‘Â Â 
print('ç»„åˆæœŸæœ«èµ„é‡‘: %.2f' % cerebro.broker.getvalue())
```

```
ç»„åˆæœŸåˆèµ„é‡‘: 100000.00
ç»„åˆæœŸæœ«èµ„é‡‘: 100000.00
```

ä»£ç é‡ç•¥æœ‰å¢åŠ ï¼Œå› ä¸ºæˆ‘ä»¬æ·»åŠ äº†ï¼šæ‰¾å‡ºæ•°æ®æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„é€šè¿‡datetimeå¯¹è±¡è¿‡æ»¤æˆ‘ä»¬æƒ³è¦æ“ä½œçš„æ•°æ®

æ³¨æ„: Yahooçš„ä»·æ ¼æ•°æ®æœ‰ç‚¹éä¸»æµï¼Œå®ƒæ˜¯ä»¥æ—¶é—´å€’åºæ’åˆ—çš„ã€‚datetime.datetime()ä¸­çš„reversed=Trueå‚æ•°æ˜¯å°†é¡ºåºåè½¬ä¸€æ¬¡ï¼Œè¿™æ ·å°±å¾—åˆ°äº†æˆ‘ä»¬æƒ³è¦çš„æ­£åºæ•°æ®ã€‚

## 3.6 ç¬¬ä¸€ä¸ªç­–ç•¥

èµ„é‡‘å’Œäº¤æ˜“æ•°æ®éƒ½æœ‰äº†ï¼Œæ¢é™©å³å°†å¼€å§‹ã€‚è®©æˆ‘ä»¬ç»™ç­–ç•¥åŠ ç‚¹ä»£ç ï¼Œæ‰“å°å‡ºæ¯å¤©çš„â€æ”¶ç›˜ä»·â€ã€‚ DataSeriesï¼ˆäº¤æ˜“æ•°æ®çš„åŸºç±»ï¼‰å¯¹è±¡ï¼Œå¯ä»¥ç›´æ¥è®¿é—®åˆ° OHLC (å¼€ç›˜ä»·ã€æœ€é«˜ä»·ã€æœ€ä½ä»·ã€æ”¶ç›˜ä»·)ç­‰æ•°æ®ã€‚è¿™ä½¿æˆ‘ä»¬æ‰“å°æ•°æ®å¾ˆæ–¹ä¾¿ã€‚

```python
import datetime # 
import os.path # è·¯å¾„ç®¡ç†Â Â 
import sys # è·å–å½“å‰è¿è¡Œè„šæœ¬çš„è·¯å¾„ (in argv[0]) 
#å¯¼å…¥backtraderæ¡†æ¶Â Â 
import backtrader as bt 

# åˆ›å»ºç­–ç•¥ç»§æ‰¿bt.Strategy 
class TestStrategy(bt.Strategy): 

    def log(self, txt, dt=None): 
        # è®°å½•ç­–ç•¥çš„æ‰§è¡Œæ—¥å¿—Â Â 
        dt = dt or self.datas[0].datetime.date(0) 
        print('%s, %s' % (dt.isoformat(), txt)) 

    def __init__(self): 
        # ä¿å­˜æ”¶ç›˜ä»·çš„å¼•ç”¨Â Â 
        self.dataclose = self.datas[0].close 

    def next(self): 
        # è®°å½•æ”¶ç›˜ä»·Â Â 
        self.log('Close, %.2f' % self.dataclose[0]) 
        
# åˆ›å»ºCerebroå¼•æ“Â Â 
cerebro = bt.Cerebro() 
# Cerebroå¼•æ“åœ¨åå°åˆ›å»ºbroker(ç»çºªäºº)ï¼Œç³»ç»Ÿé»˜è®¤èµ„é‡‘é‡ä¸º10000 
# ä¸ºCerebroå¼•æ“æ·»åŠ ç­–ç•¥Â Â 
cerebro.addstrategy(TestStrategy) 
# è·å–å½“å‰è¿è¡Œè„šæœ¬æ‰€åœ¨ç›®å½•
modpath = os.path.dirname(os.path.abspath(sys.argv[0])) 
# æ‹¼æ¥åŠ è½½è·¯å¾„Â Â 
datapath = os.path.join(modpath, '/home/mw/input/backtrader7822/orcl-1995-2014.txt') 
# åˆ›å»ºäº¤æ˜“æ•°æ®é›†Â Â 
data = bt.feeds.YahooFinanceCSVData( dataname=datapath, 
                                    # æ•°æ®å¿…é¡»å¤§äºfromdate 
                                    fromdate=datetime.datetime(2000, 1, 1), 
                                    # æ•°æ®å¿…é¡»å°äºtodate 
                                    todate=datetime.datetime(2000, 12, 31), 
                                    reverse=False) 
                                    # åŠ è½½äº¤æ˜“æ•°æ®Â Â 

cerebro.adddata(data)
# è®¾ç½®æŠ•èµ„é‡‘é¢100000.0 
cerebro.broker.setcash(100000.0) 
# å¼•æ“è¿è¡Œå‰æ‰“å°æœŸå‡ºèµ„é‡‘Â Â 
print('ç»„åˆæœŸåˆèµ„é‡‘: %.2f' % cerebro.broker.getvalue()) 
cerebro.run() 
# å¼•æ“è¿è¡Œåæ‰“æœŸæœ«èµ„é‡‘Â Â 
print('ç»„åˆæœŸæœ«èµ„é‡‘: %.2f' % cerebro.broker.getvalue())
```

```
ç»„åˆæœŸåˆèµ„é‡‘: 100000.00
2000-01-03, Close, 26.27
2000-01-04, Close, 23.95
2000-01-05, Close, 22.68
2000-01-06, Close, 21.35
2000-01-07, Close, 22.99
2000-01-10, Close, 25.74
2000-01-11, Close, 24.99
2000-01-12, Close, 23.49
2000-01-13, Close, 23.36
2000-01-14, Close, 23.75
2000-01-18, Close, 24.74
2000-01-19, Close, 25.41
2000-01-20, Close, 26.35
2000-01-21, Close, 26.55
2000-01-24, Close, 24.10
2000-01-25, Close, 25.10
2000-01-26, Close, 24.49
2000-01-27, Close, 23.04
2000-01-28, Close, 21.07
2000-01-31, Close, 22.22
2000-02-01, Close, 24.02
2000-02-02, Close, 24.16
2000-02-03, Close, 25.21
2000-02-04, Close, 25.71
2000-02-07, Close, 26.66
2000-02-08, Close, 26.49
2000-02-09, Close, 26.66
2000-02-10, Close, 27.71
2000-02-11, Close, 26.55
2000-02-14, Close, 27.66
2000-02-15, Close, 27.30
2000-02-16, Close, 27.24
2000-02-17, Close, 27.41
2000-02-18, Close, 26.05
2000-02-22, Close, 26.38
2000-02-23, Close, 28.05
2000-02-24, Close, 27.55
2000-02-25, Close, 31.41
2000-02-28, Close, 30.52
2000-02-29, Close, 33.02
2000-03-01, Close, 31.80
2000-03-02, Close, 30.47
2000-03-03, Close, 33.36
2000-03-06, Close, 33.69
2000-03-07, Close, 33.33
2000-03-08, Close, 36.97
2000-03-09, Close, 37.36
2000-03-10, Close, 36.30
2000-03-13, Close, 35.02
2000-03-14, Close, 34.25
2000-03-15, Close, 34.97
2000-03-16, Close, 36.44
2000-03-17, Close, 35.50
2000-03-20, Close, 34.75
2000-03-21, Close, 35.89
2000-03-22, Close, 37.39
2000-03-23, Close, 38.64
2000-03-24, Close, 38.69
2000-03-27, Close, 39.33
2000-03-28, Close, 38.50
2000-03-29, Close, 36.69
2000-03-30, Close, 34.88
2000-03-31, Close, 34.72
2000-04-03, Close, 34.19
2000-04-04, Close, 33.77
2000-04-05, Close, 34.80
2000-04-06, Close, 36.55
2000-04-07, Close, 38.75
2000-04-10, Close, 36.69
2000-04-11, Close, 34.41
2000-04-12, Close, 32.52
2000-04-13, Close, 31.99
2000-04-14, Close, 27.80
2000-04-17, Close, 33.27
2000-04-18, Close, 35.11
2000-04-19, Close, 33.16
2000-04-20, Close, 31.49
2000-04-24, Close, 32.22
2000-04-25, Close, 33.61
2000-04-26, Close, 32.11
2000-04-27, Close, 34.38
2000-04-28, Close, 35.55
2000-05-01, Close, 35.44
2000-05-02, Close, 34.61
2000-05-03, Close, 33.72
2000-05-04, Close, 33.02
2000-05-05, Close, 34.16
2000-05-08, Close, 32.16
2000-05-09, Close, 32.02
2000-05-10, Close, 30.08
2000-05-11, Close, 32.19
2000-05-12, Close, 32.99
2000-05-15, Close, 34.25
2000-05-16, Close, 35.22
2000-05-17, Close, 34.77
2000-05-18, Close, 32.49
2000-05-19, Close, 31.16
2000-05-22, Close, 30.16
2000-05-23, Close, 27.85
2000-05-24, Close, 28.57
2000-05-25, Close, 29.55
2000-05-26, Close, 29.80
2000-05-30, Close, 32.99
2000-05-31, Close, 31.97
2000-06-01, Close, 34.63
2000-06-02, Close, 35.66
2000-06-05, Close, 36.00
2000-06-06, Close, 34.27
2000-06-07, Close, 35.58
2000-06-08, Close, 36.64
2000-06-09, Close, 36.77
2000-06-12, Close, 35.83
2000-06-13, Close, 36.33
2000-06-14, Close, 35.13
2000-06-15, Close, 36.69
2000-06-16, Close, 36.41
2000-06-19, Close, 38.25
2000-06-20, Close, 38.27
2000-06-21, Close, 38.33
2000-06-22, Close, 36.25
2000-06-23, Close, 35.36
2000-06-26, Close, 36.77
2000-06-27, Close, 36.58
2000-06-28, Close, 36.89
2000-06-29, Close, 35.97
2000-06-30, Close, 37.39
2000-07-03, Close, 35.66
2000-07-05, Close, 32.16
2000-07-06, Close, 33.63
2000-07-07, Close, 33.75
2000-07-10, Close, 32.97
2000-07-11, Close, 32.16
2000-07-12, Close, 33.22
2000-07-13, Close, 33.69
2000-07-14, Close, 33.86
2000-07-17, Close, 33.86
2000-07-18, Close, 32.99
2000-07-19, Close, 32.80
2000-07-20, Close, 34.75
2000-07-21, Close, 33.55
2000-07-24, Close, 33.36
2000-07-25, Close, 33.80
2000-07-26, Close, 34.13
2000-07-27, Close, 33.38
2000-07-28, Close, 32.19
2000-07-31, Close, 33.44
2000-08-01, Close, 32.52
2000-08-02, Close, 32.52
2000-08-03, Close, 34.44
2000-08-04, Close, 36.27
2000-08-07, Close, 36.41
2000-08-08, Close, 36.91
2000-08-09, Close, 36.19
2000-08-10, Close, 35.61
2000-08-11, Close, 36.08
2000-08-14, Close, 36.64
2000-08-15, Close, 36.14
2000-08-16, Close, 36.11
2000-08-17, Close, 37.33
2000-08-18, Close, 36.16
2000-08-21, Close, 37.00
2000-08-22, Close, 37.16
2000-08-23, Close, 36.86
2000-08-24, Close, 37.66
2000-08-25, Close, 37.64
2000-08-28, Close, 38.58
2000-08-29, Close, 39.03
2000-08-30, Close, 39.25
2000-08-31, Close, 40.44
2000-09-01, Close, 41.19
2000-09-05, Close, 40.50
2000-09-06, Close, 39.69
2000-09-07, Close, 40.56
2000-09-08, Close, 38.50
2000-09-11, Close, 37.11
2000-09-12, Close, 35.30
2000-09-13, Close, 36.39
2000-09-14, Close, 37.78
2000-09-15, Close, 34.83
2000-09-18, Close, 34.01
2000-09-19, Close, 35.27
2000-09-20, Close, 35.55
2000-09-21, Close, 35.11
2000-09-22, Close, 35.91
2000-09-25, Close, 35.02
2000-09-26, Close, 35.33
2000-09-27, Close, 35.52
2000-09-28, Close, 36.24
2000-09-29, Close, 35.02
2000-10-02, Close, 35.02
2000-10-03, Close, 30.91
2000-10-04, Close, 30.30
2000-10-05, Close, 30.38
2000-10-06, Close, 30.08
2000-10-09, Close, 29.69
2000-10-10, Close, 28.74
2000-10-11, Close, 27.69
2000-10-12, Close, 28.02
2000-10-13, Close, 31.69
2000-10-16, Close, 30.74
2000-10-17, Close, 29.96
2000-10-18, Close, 29.85
2000-10-19, Close, 32.36
2000-10-20, Close, 31.35
2000-10-23, Close, 30.30
2000-10-24, Close, 31.85
2000-10-25, Close, 30.58
2000-10-26, Close, 30.30
2000-10-27, Close, 30.41
2000-10-30, Close, 28.13
2000-10-31, Close, 29.35
2000-11-01, Close, 27.91
2000-11-02, Close, 26.30
2000-11-03, Close, 26.96
2000-11-06, Close, 24.85
2000-11-07, Close, 23.63
2000-11-08, Close, 22.07
2000-11-09, Close, 24.18
2000-11-10, Close, 22.63
2000-11-13, Close, 22.01
2000-11-14, Close, 25.24
2000-11-15, Close, 25.68
2000-11-16, Close, 24.35
2000-11-17, Close, 25.63
2000-11-20, Close, 22.01
2000-11-21, Close, 21.24
2000-11-22, Close, 19.85
2000-11-24, Close, 21.46
2000-11-27, Close, 20.57
2000-11-28, Close, 20.15
2000-11-29, Close, 20.35
2000-11-30, Close, 23.57
2000-12-01, Close, 23.52
2000-12-04, Close, 25.07
2000-12-05, Close, 28.02
2000-12-06, Close, 26.85
2000-12-07, Close, 25.18
2000-12-08, Close, 26.74
2000-12-11, Close, 28.41
2000-12-12, Close, 27.35
2000-12-13, Close, 25.24
2000-12-14, Close, 24.46
2000-12-15, Close, 25.41
2000-12-18, Close, 28.46
2000-12-19, Close, 27.24
2000-12-20, Close, 25.35
2000-12-21, Close, 26.24
2000-12-22, Close, 28.35
2000-12-26, Close, 27.52
2000-12-27, Close, 27.30
2000-12-28, Close, 27.63
2000-12-29, Close, 25.85
ç»„åˆæœŸæœ«èµ„é‡‘: 100000.00
```

æœ‰äººè¯´è‚¡å¸‚æœ‰é£é™©ï¼Œçœ‹èµ·æ¥ä¸åƒå•Šã€‚ ä¸€äº›è§£é‡Šè¯´æ˜ï¼šÂ Â 
æ¡†æ¶åœ¨è°ƒç”¨initæ—¶ï¼Œè¯¥ç­–ç•¥å·²ç»å…·æœ‰ä¸€ä¸ªæ•°æ®åˆ—è¡¨datasï¼Œè¿™æ˜¯æ ‡å‡†çš„Pythonåˆ—è¡¨ï¼Œå¯ä»¥æŒ‰æ’å…¥é¡ºåºè®¿é—®æ•°æ®ã€‚ åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæ•°æ® self.datas[0]æ˜¯ç”¨äºäº¤æ˜“æ“ä½œï¼Œå¹¶ä¸”ç­–ç•¥ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯ç”±æ¡†æ¶çš„ç³»ç»Ÿæ—¶é’Ÿè¿›è¡ŒåŒæ­¥çš„ã€‚ ç”±äºåªéœ€è®¿é—®æ”¶ç›˜ä»·æ•°æ®ï¼Œäºæ˜¯ä½¿ç”¨ self.dataclose = self.datas[0].closeå°†ç¬¬ä¸€æ¡ä»·æ ¼æ•°æ®çš„æ”¶ç›˜ä»·èµ‹å€¼ç»™æ–°å˜é‡ã€‚ ç³»ç»Ÿæ—¶é’Ÿå½“ç»è¿‡ä¸€ä¸ª Kçº¿æŸ±çš„æ—¶å€™ï¼Œç­–ç•¥çš„next()æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚è¿™ä¸€è¿‡ç¨‹Â Â å°†ä¸€ç›´å¾ªç¯ï¼Œç›´åˆ°å…¶ä»–æŒ‡æ ‡ä¿¡å·å‡ºç°ä¸ºæ­¢ã€‚æ­¤æ—¶ï¼Œä¾¿ä¼šè¾“å‡ºæœ€ç»ˆç»“æœã€‚å…³äºè¿™äº›ï¼Œåç»§å†…å®¹ä¼šè®²åˆ°ã€‚

## 3.7 ç»™ç­–ç•¥åŠ ç‚¹é€»è¾‘

å¦‚æœKçº¿æ”¶ç›˜ä»·å‡ºç°ä¸‰è¿è·Œï¼Œåˆ™ä¹°å…¥ã€‚

```python
import datetime # 
import os.path # è·¯å¾„ç®¡ç†Â Â 
import sys # è·å–å½“å‰è¿è¡Œè„šæœ¬çš„è·¯å¾„ (in argv[0]) 
#å¯¼å…¥backtraderæ¡†æ¶Â Â 
import backtrader as bt 
# åˆ›å»ºç­–ç•¥ç»§æ‰¿bt.Strategy

class TestStrategy(bt.Strategy): 
    def log(self, txt, dt=None): 
        # è®°å½•ç­–ç•¥çš„æ‰§è¡Œæ—¥å¿—Â Â 
        dt = dt or self.datas[0].datetime.date(0) 
        print('%s, %s' % (dt.isoformat(), txt))

    def __init__(self): 
        # ä¿å­˜æ”¶ç›˜ä»·çš„å¼•ç”¨Â Â 
        self.dataclose = self.datas[0].close

    def next(self):
        # è®°å½•æ”¶ç›˜ä»·Â Â 
        self.log('Close, %.2f' % self.dataclose[0]) 
        # ä»Šå¤©çš„æ”¶ç›˜ä»· < æ˜¨å¤©æ”¶ç›˜ä»·Â Â 
        if self.dataclose[0] < self.dataclose[-1]: 
            # æ˜¨å¤©æ”¶ç›˜ä»· < å‰å¤©çš„æ”¶ç›˜ä»·Â Â 
            if self.dataclose[-1] < self.dataclose[-2]:
                # ä¹°å…¥Â Â 
                self.log('ä¹°å…¥, %.2f' % self.dataclose[0])
                self.buy()
```

```python
# åˆ›å»ºCerebroå¼•æ“Â Â 
cerebro = bt.Cerebro() 
# Cerebroå¼•æ“åœ¨åå°åˆ›å»ºbroker(ç»çºªäºº)ï¼Œç³»ç»Ÿé»˜è®¤èµ„é‡‘é‡ä¸º10000 
# ä¸ºCerebroå¼•æ“æ·»åŠ ç­–ç•¥Â Â 
cerebro.addstrategy(TestStrategy) 
# è·å–å½“å‰è¿è¡Œè„šæœ¬æ‰€åœ¨ç›®å½•Â Â 
modpath = os.path.dirname(os.path.abspath(sys.argv[0])) 
# æ‹¼æ¥åŠ è½½è·¯å¾„Â Â 
datapath = os.path.join(modpath, '/home/mw/input/backtrader7822/orcl-1995-2014.txt') 
# åˆ›å»ºäº¤æ˜“æ•°æ®é›†Â Â 
data = bt.feeds.YahooFinanceCSVData( 
                                dataname=datapath,
                                # æ•°æ®å¿…é¡»å¤§äºfromdate 
                                fromdate=datetime.datetime(2000, 1, 1),  
                                # æ•°æ®å¿…é¡»å°äºtodate 
                                todate=datetime.datetime(2000, 12, 31), 
                                reverse=False) 
# åŠ è½½äº¤æ˜“æ•°æ®Â Â 
cerebro.adddata(data) 
# è®¾ç½®æŠ•èµ„é‡‘é¢100000.0 
cerebro.broker.setcash(100000.0) 
# å¼•æ“è¿è¡Œå‰æ‰“å°æœŸå‡ºèµ„é‡‘Â Â 
print('ç»„åˆæœŸåˆèµ„é‡‘: %.2f' % cerebro.broker.getvalue()) 
cerebro.run() 
# å¼•æ“è¿è¡Œåæ‰“æœŸæœ«èµ„é‡‘Â Â 
print('ç»„åˆæœŸæœ«èµ„é‡‘: %.2f' % cerebro.broker.getvalue())
```

```
ç»„åˆæœŸåˆèµ„é‡‘: 100000.00
2000-01-03, Close, 26.27
2000-01-04, Close, 23.95
2000-01-05, Close, 22.68
2000-01-05, ä¹°å…¥, 22.68
2000-01-06, Close, 21.35
2000-01-06, ä¹°å…¥, 21.35
2000-01-07, Close, 22.99
2000-01-10, Close, 25.74
2000-01-11, Close, 24.99
2000-01-12, Close, 23.49
2000-01-12, ä¹°å…¥, 23.49
2000-01-13, Close, 23.36
2000-01-13, ä¹°å…¥, 23.36
2000-01-14, Close, 23.75
2000-01-18, Close, 24.74
2000-01-19, Close, 25.41
2000-01-20, Close, 26.35
2000-01-21, Close, 26.55
2000-01-24, Close, 24.10
2000-01-25, Close, 25.10
2000-01-26, Close, 24.49
2000-01-27, Close, 23.04
2000-01-27, ä¹°å…¥, 23.04
2000-01-28, Close, 21.07
2000-01-28, ä¹°å…¥, 21.07
2000-01-31, Close, 22.22
2000-02-01, Close, 24.02
2000-02-02, Close, 24.16
2000-02-03, Close, 25.21
2000-02-04, Close, 25.71
2000-02-07, Close, 26.66
2000-02-08, Close, 26.49
2000-02-09, Close, 26.66
2000-02-10, Close, 27.71
2000-02-11, Close, 26.55
2000-02-14, Close, 27.66
2000-02-15, Close, 27.30
2000-02-16, Close, 27.24
2000-02-16, ä¹°å…¥, 27.24
2000-02-17, Close, 27.41
2000-02-18, Close, 26.05
2000-02-22, Close, 26.38
2000-02-23, Close, 28.05
2000-02-24, Close, 27.55
2000-02-25, Close, 31.41
2000-02-28, Close, 30.52
2000-02-29, Close, 33.02
2000-03-01, Close, 31.80
2000-03-02, Close, 30.47
2000-03-02, ä¹°å…¥, 30.47
2000-03-03, Close, 33.36
2000-03-06, Close, 33.69
2000-03-07, Close, 33.33
2000-03-08, Close, 36.97
2000-03-09, Close, 37.36
2000-03-10, Close, 36.30
2000-03-13, Close, 35.02
2000-03-13, ä¹°å…¥, 35.02
2000-03-14, Close, 34.25
2000-03-14, ä¹°å…¥, 34.25
2000-03-15, Close, 34.97
2000-03-16, Close, 36.44
2000-03-17, Close, 35.50
2000-03-20, Close, 34.75
2000-03-20, ä¹°å…¥, 34.75
2000-03-21, Close, 35.89
2000-03-22, Close, 37.39
2000-03-23, Close, 38.64
2000-03-24, Close, 38.69
2000-03-27, Close, 39.33
2000-03-28, Close, 38.50
2000-03-29, Close, 36.69
2000-03-29, ä¹°å…¥, 36.69
2000-03-30, Close, 34.88
2000-03-30, ä¹°å…¥, 34.88
2000-03-31, Close, 34.72
2000-03-31, ä¹°å…¥, 34.72
2000-04-03, Close, 34.19
2000-04-03, ä¹°å…¥, 34.19
2000-04-04, Close, 33.77
2000-04-04, ä¹°å…¥, 33.77
2000-04-05, Close, 34.80
2000-04-06, Close, 36.55
2000-04-07, Close, 38.75
2000-04-10, Close, 36.69
2000-04-11, Close, 34.41
2000-04-11, ä¹°å…¥, 34.41
2000-04-12, Close, 32.52
2000-04-12, ä¹°å…¥, 32.52
2000-04-13, Close, 31.99
2000-04-13, ä¹°å…¥, 31.99
2000-04-14, Close, 27.80
2000-04-14, ä¹°å…¥, 27.80
2000-04-17, Close, 33.27
2000-04-18, Close, 35.11
2000-04-19, Close, 33.16
2000-04-20, Close, 31.49
2000-04-20, ä¹°å…¥, 31.49
2000-04-24, Close, 32.22
2000-04-25, Close, 33.61
2000-04-26, Close, 32.11
2000-04-27, Close, 34.38
2000-04-28, Close, 35.55
2000-05-01, Close, 35.44
2000-05-02, Close, 34.61
2000-05-02, ä¹°å…¥, 34.61
2000-05-03, Close, 33.72
2000-05-03, ä¹°å…¥, 33.72
2000-05-04, Close, 33.02
2000-05-04, ä¹°å…¥, 33.02
2000-05-05, Close, 34.16
2000-05-08, Close, 32.16
2000-05-09, Close, 32.02
2000-05-09, ä¹°å…¥, 32.02
2000-05-10, Close, 30.08
2000-05-10, ä¹°å…¥, 30.08
2000-05-11, Close, 32.19
2000-05-12, Close, 32.99
2000-05-15, Close, 34.25
2000-05-16, Close, 35.22
2000-05-17, Close, 34.77
2000-05-18, Close, 32.49
2000-05-18, ä¹°å…¥, 32.49
2000-05-19, Close, 31.16
2000-05-19, ä¹°å…¥, 31.16
2000-05-22, Close, 30.16
2000-05-22, ä¹°å…¥, 30.16
2000-05-23, Close, 27.85
2000-05-23, ä¹°å…¥, 27.85
2000-05-24, Close, 28.57
2000-05-25, Close, 29.55
2000-05-26, Close, 29.80
2000-05-30, Close, 32.99
2000-05-31, Close, 31.97
2000-06-01, Close, 34.63
2000-06-02, Close, 35.66
2000-06-05, Close, 36.00
2000-06-06, Close, 34.27
2000-06-07, Close, 35.58
2000-06-08, Close, 36.64
2000-06-09, Close, 36.77
2000-06-12, Close, 35.83
2000-06-13, Close, 36.33
2000-06-14, Close, 35.13
2000-06-15, Close, 36.69
2000-06-16, Close, 36.41
2000-06-19, Close, 38.25
2000-06-20, Close, 38.27
2000-06-21, Close, 38.33
2000-06-22, Close, 36.25
2000-06-23, Close, 35.36
2000-06-23, ä¹°å…¥, 35.36
2000-06-26, Close, 36.77
2000-06-27, Close, 36.58
2000-06-28, Close, 36.89
2000-06-29, Close, 35.97
2000-06-30, Close, 37.39
2000-07-03, Close, 35.66
2000-07-05, Close, 32.16
2000-07-05, ä¹°å…¥, 32.16
2000-07-06, Close, 33.63
2000-07-07, Close, 33.75
2000-07-10, Close, 32.97
2000-07-11, Close, 32.16
2000-07-11, ä¹°å…¥, 32.16
2000-07-12, Close, 33.22
2000-07-13, Close, 33.69
2000-07-14, Close, 33.86
2000-07-17, Close, 33.86
2000-07-18, Close, 32.99
2000-07-19, Close, 32.80
2000-07-19, ä¹°å…¥, 32.80
2000-07-20, Close, 34.75
2000-07-21, Close, 33.55
2000-07-24, Close, 33.36
2000-07-24, ä¹°å…¥, 33.36
2000-07-25, Close, 33.80
2000-07-26, Close, 34.13
2000-07-27, Close, 33.38
2000-07-28, Close, 32.19
2000-07-28, ä¹°å…¥, 32.19
2000-07-31, Close, 33.44
2000-08-01, Close, 32.52
2000-08-02, Close, 32.52
2000-08-03, Close, 34.44
2000-08-04, Close, 36.27
2000-08-07, Close, 36.41
2000-08-08, Close, 36.91
2000-08-09, Close, 36.19
2000-08-10, Close, 35.61
2000-08-10, ä¹°å…¥, 35.61
2000-08-11, Close, 36.08
2000-08-14, Close, 36.64
2000-08-15, Close, 36.14
2000-08-16, Close, 36.11
2000-08-16, ä¹°å…¥, 36.11
2000-08-17, Close, 37.33
2000-08-18, Close, 36.16
2000-08-21, Close, 37.00
2000-08-22, Close, 37.16
2000-08-23, Close, 36.86
2000-08-24, Close, 37.66
2000-08-25, Close, 37.64
2000-08-28, Close, 38.58
2000-08-29, Close, 39.03
2000-08-30, Close, 39.25
2000-08-31, Close, 40.44
2000-09-01, Close, 41.19
2000-09-05, Close, 40.50
2000-09-06, Close, 39.69
2000-09-06, ä¹°å…¥, 39.69
2000-09-07, Close, 40.56
2000-09-08, Close, 38.50
2000-09-11, Close, 37.11
2000-09-11, ä¹°å…¥, 37.11
2000-09-12, Close, 35.30
2000-09-12, ä¹°å…¥, 35.30
2000-09-13, Close, 36.39
2000-09-14, Close, 37.78
2000-09-15, Close, 34.83
2000-09-18, Close, 34.01
2000-09-18, ä¹°å…¥, 34.01
2000-09-19, Close, 35.27
2000-09-20, Close, 35.55
2000-09-21, Close, 35.11
2000-09-22, Close, 35.91
2000-09-25, Close, 35.02
2000-09-26, Close, 35.33
2000-09-27, Close, 35.52
2000-09-28, Close, 36.24
2000-09-29, Close, 35.02
2000-10-02, Close, 35.02
2000-10-03, Close, 30.91
2000-10-04, Close, 30.30
2000-10-04, ä¹°å…¥, 30.30
2000-10-05, Close, 30.38
2000-10-06, Close, 30.08
2000-10-09, Close, 29.69
2000-10-09, ä¹°å…¥, 29.69
2000-10-10, Close, 28.74
2000-10-10, ä¹°å…¥, 28.74
2000-10-11, Close, 27.69
2000-10-11, ä¹°å…¥, 27.69
2000-10-12, Close, 28.02
2000-10-13, Close, 31.69
2000-10-16, Close, 30.74
2000-10-17, Close, 29.96
2000-10-17, ä¹°å…¥, 29.96
2000-10-18, Close, 29.85
2000-10-18, ä¹°å…¥, 29.85
2000-10-19, Close, 32.36
2000-10-20, Close, 31.35
2000-10-23, Close, 30.30
2000-10-23, ä¹°å…¥, 30.30
2000-10-24, Close, 31.85
2000-10-25, Close, 30.58
2000-10-26, Close, 30.30
2000-10-26, ä¹°å…¥, 30.30
2000-10-27, Close, 30.41
2000-10-30, Close, 28.13
2000-10-31, Close, 29.35
2000-11-01, Close, 27.91
2000-11-02, Close, 26.30
2000-11-02, ä¹°å…¥, 26.30
2000-11-03, Close, 26.96
2000-11-06, Close, 24.85
2000-11-07, Close, 23.63
2000-11-07, ä¹°å…¥, 23.63
2000-11-08, Close, 22.07
2000-11-08, ä¹°å…¥, 22.07
2000-11-09, Close, 24.18
2000-11-10, Close, 22.63
2000-11-13, Close, 22.01
2000-11-13, ä¹°å…¥, 22.01
2000-11-14, Close, 25.24
2000-11-15, Close, 25.68
2000-11-16, Close, 24.35
2000-11-17, Close, 25.63
2000-11-20, Close, 22.01
2000-11-21, Close, 21.24
2000-11-21, ä¹°å…¥, 21.24
2000-11-22, Close, 19.85
2000-11-22, ä¹°å…¥, 19.85
2000-11-24, Close, 21.46
2000-11-27, Close, 20.57
2000-11-28, Close, 20.15
2000-11-28, ä¹°å…¥, 20.15
2000-11-29, Close, 20.35
2000-11-30, Close, 23.57
2000-12-01, Close, 23.52
2000-12-04, Close, 25.07
2000-12-05, Close, 28.02
2000-12-06, Close, 26.85
2000-12-07, Close, 25.18
2000-12-07, ä¹°å…¥, 25.18
2000-12-08, Close, 26.74
2000-12-11, Close, 28.41
2000-12-12, Close, 27.35
2000-12-13, Close, 25.24
2000-12-13, ä¹°å…¥, 25.24
2000-12-14, Close, 24.46
2000-12-14, ä¹°å…¥, 24.46
2000-12-15, Close, 25.41
2000-12-18, Close, 28.46
2000-12-19, Close, 27.24
2000-12-20, Close, 25.35
2000-12-20, ä¹°å…¥, 25.35
2000-12-21, Close, 26.24
2000-12-22, Close, 28.35
2000-12-26, Close, 27.52
2000-12-27, Close, 27.30
2000-12-27, ä¹°å…¥, 27.30
2000-12-28, Close, 27.63
2000-12-29, Close, 25.85
ç»„åˆæœŸæœ«èµ„é‡‘: 99740.45
```

è‹¥å¹²ä¸ªä¹°å…¥æ“ä½œè¢«æ‰§è¡Œï¼Œæ‰€ä»¥ä½™é¢åœ¨å‡å°‘ã€‚ ç»†å¿ƒçš„æœ‹å‹å¯èƒ½ä¼šé—®ï¼Œä¹°äº†å¤šå°‘ï¼Ÿä¹°çš„ä»€ä¹ˆï¼Ÿè®¢å•æ€ä¹ˆè¢«æ‰§è¡Œçš„?BackTraderæ¡†æ¶æ›¿æˆ‘ä»¬åšäº†è¿™äº›äº‹ï¼š å¦‚æœæ²¡æœ‰æŒ‡å®šçš„è¯ï¼Œ self.datas[0]å³æ˜¯æ ‡çš„ç‰©å½“å‰äº¤æ˜“æ•°æ®ã€‚ äº¤æ˜“æ•°é‡ =ä»“ä½æ•°é‡ï¼Œé»˜è®¤å€¼ç­‰äº1ï¼Œåé¢ä¾‹å­æˆ‘ä»¬ä¼šä¿®æ”¹æ­¤å‚æ•°ã€‚

è®¢å•è¢«ä»¥â€å¸‚ä»·â€æˆäº¤äº†ã€‚ Brokerï¼ˆç»çºªäººï¼Œä¹‹å‰æåˆ°è¿‡ï¼‰ä½¿ç”¨äº†ä¸‹ä¸€ä¸ªäº¤æ˜“æ—¥çš„å¼€ç›˜ä»·ï¼Œå› ä¸ºæ˜¯brokeråœ¨å½“å‰çš„äº¤æ—¥æ˜“æ”¶ç›˜åå¤©æäº¤çš„è®¢å•ï¼Œä¸‹ä¸€ä¸ªäº¤æ˜“æ—¥å¼€ç›˜ä»·æ˜¯ä»–æ¥è§¦åˆ°çš„ç¬¬ä¸€ä¸ªä»·æ ¼ã€‚ è¿™é‡Œæ²¡æœ‰ä¸ºè®¢å•è®¾ç½®ä½£é‡‘è´¹ï¼Œåè¾¹ä¼šåŠ ä¸Šã€‚

## 3.8 ä¸å…‰æœ‰ä¹°å…¥ï¼Œè¿˜å¾—æœ‰å–å‡º

åœ¨çŸ¥é“å¦‚ä½•ä¹°å…¥ï¼ˆåšå¤šï¼‰ä¹‹åï¼Œéœ€è¦çŸ¥é“å¦‚ä½•å–å‡ºï¼Œå¹¶ä¸”è¿˜éœ€è¦äº†è§£è¯¥ç­–ç•¥æ˜¯å¦åœ¨å¸‚åœºä¸­ã€‚ Strategyç±»æœ‰ä¸€ä¸ªå˜é‡positionä¿å­˜å½“å‰æŒæœ‰çš„èµ„äº§æ•°é‡ï¼ˆå¯ä»¥ç†è§£ä¸ºé‡‘èæœ¯è¯­ä¸­çš„å¤´å¯¸ï¼‰ï¼Œ buy()å’Œsell()ä¼šè¿”å›è¢«åˆ›å»ºçš„è®¢å•(å°šæœªæ‰§è¡Œçš„)ï¼Œ è®¢å•çŠ¶æ€çš„æ›´æ”¹å°†é€šè¿‡ notifyæ–¹æ³•é€šçŸ¥ç»™ç­–ç•¥Strategyã€‚

å–å‡ºé€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼š 5ä¸ªKçº¿æŸ±åï¼ˆç¬¬6ä¸ªKçº¿æŸ±ï¼‰ä¸ç®¡æ¶¨è·Œéƒ½å–ã€‚ è¯·æ³¨æ„ï¼Œè¿™é‡Œæ²¡æœ‰æŒ‡å®šå…·ä½“æ—¶é—´ï¼Œè€Œæ˜¯æŒ‡å®šçš„æŸ±çš„æ•°é‡ã€‚ä¸€ä¸ªæŸ±å¯èƒ½ä»£è¡¨ 1åˆ†é’Ÿã€1å°æ—¶ã€1å¤©ã€1æ˜ŸæœŸç­‰ç­‰ï¼Œè¿™å–å†³äºä½ ä»·æ ¼æ•°æ®æ–‡ä»¶é‡Œä¸€æ¡æ•°æ®ä»£è¡¨çš„å‘¨æœŸã€‚ è™½ç„¶æˆ‘ä»¬çŸ¥é“æ¯ä¸ªæŸ±ä»£è¡¨ä¸€å¤©ï¼Œä½†ç­–ç•¥å¹¶ä¸çŸ¥é“ã€‚

å› ä¸ºä¹°å…¥çš„æ—¶å€™ï¼Œç”¨çš„æ˜¯äº¤æ˜“æ—¥ï¼Œæ‰€ä»¥è¿™é‡Œåº”ç¿»è¯‘ä¸ºï¼š5ä¸ªäº¤æ˜“æ—¥ï¼ˆç¬¬6ä¸ªäº¤æ˜“æ—¥ï¼‰ä¸ç®¡æ¶¨è·Œéƒ½å–ã€‚

å¦å¤–ï¼Œå½“è¿˜æœ‰å¤´å¯¸çš„æ—¶å€™ï¼Œå°±ä¸å†ä¹°å…¥äº†ã€‚

> æ³¨æ„ï¼š æ²¡æœ‰å°†æŸ±çš„ä¸‹æ ‡ä¼ ç»™ next()æ–¹æ³•ï¼Œæ€ä¹ˆçŸ¥é“å·²ç»ç»è¿‡äº†5ä¸ªæŸ±äº†å‘¢ï¼Ÿ è¿™é‡Œç”¨äº† Pythonçš„len()æ–¹æ³•è·å–å®ƒLineæ•°æ®çš„é•¿åº¦ã€‚ äº¤æ˜“å‘ç”Ÿæ—¶è®°ä¸‹å®ƒçš„é•¿åº¦ï¼Œåè¾¹æ¯”è¾ƒå¤§å°ï¼Œçœ‹æ˜¯å¦ç»è¿‡äº†5ä¸ªæŸ±ã€‚


```python
import datetime # 
import os.path # è·¯å¾„ç®¡ç†Â Â 
import sys # è·å–å½“å‰è¿è¡Œè„šæœ¬çš„è·¯å¾„ (in argv[0]) 
#å¯¼å…¥backtraderæ¡†æ¶Â Â 
import backtrader as bt 
# åˆ›å»ºç­–ç•¥ç»§æ‰¿bt.Strategy 
class TestStrategy(bt.Strategy): 
    def log(self, txt, dt=None): 
        # è®°å½•ç­–ç•¥çš„æ‰§è¡Œæ—¥å¿—Â Â 
        dt = dt or self.datas[0].datetime.date(0) 
        print('%s, %s' % (dt.isoformat(), txt))

    def __init__(self): 
    # ä¿å­˜æ”¶ç›˜ä»·çš„å¼•ç”¨Â Â 
        self.dataclose = self.datas[0].close 
        # è·Ÿè¸ªæŒ‚å•Â Â 
        self.order = None 

    def notify_order(self, order): 
        if order.status in [order.Submitted, order.Accepted]: 
            # broker æäº¤/æ¥å—äº†ï¼Œä¹°/å–è®¢å•åˆ™ä»€ä¹ˆéƒ½ä¸åšÂ Â 
            return
        # æ£€æŸ¥ä¸€ä¸ªè®¢å•æ˜¯å¦å®ŒæˆÂ Â 
        # æ³¨æ„: å½“èµ„é‡‘ä¸è¶³æ—¶ï¼Œbrokerä¼šæ‹’ç»è®¢å•Â Â 
        if order.status in [order.Completed]: 
            if order.isbuy(): 
                self.log('å·²ä¹°å…¥, %.2f' % order.executed.price) 
            elif order.issell(): 
                self.log('å·²å–å‡º, %.2f' % order.executed.price) 

            # è®°å½•å½“å‰äº¤æ˜“æ•°é‡Â Â 
            self.bar_executed = len(self) 

        elif order.status in [order.Canceled, order.Margin, order.Rejected]: 
            self.log('è®¢å•å–æ¶ˆ/ä¿è¯é‡‘ä¸è¶³/æ‹’ç»') 
            
        # å…¶ä»–çŠ¶æ€è®°å½•ä¸ºï¼šæ— æŒ‚èµ·è®¢å•Â Â 
        self.order = None 


    def next(self): 
        # è®°å½•æ”¶ç›˜ä»·Â Â 
        self.log('Close, %.2f' % self.dataclose[0]) 

        # å¦‚æœæœ‰è®¢å•æ­£åœ¨æŒ‚èµ·ï¼Œä¸æ“ä½œÂ Â 
        if self.order: 
            return 

        # å¦‚æœæ²¡æœ‰æŒä»“åˆ™ä¹°å…¥Â Â 
        if not self.position: 
            # ä»Šå¤©çš„æ”¶ç›˜ä»· < æ˜¨å¤©æ”¶ç›˜ä»·Â Â 
            if self.dataclose[0] < self.dataclose[-1]: 
                # æ˜¨å¤©æ”¶ç›˜ä»· < å‰å¤©çš„æ”¶ç›˜ä»·Â Â 
                if self.dataclose[-1] < self.dataclose[-2]: 
                    # ä¹°å…¥Â Â 
                    self.log('ä¹°å…¥, %.2f' % self.dataclose[0]) 
                    # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                    self.order = self.buy() 
        else: 
            # å¦‚æœå·²ç»æŒä»“ï¼Œä¸”å½“å‰äº¤æ˜“æ•°æ®é‡åœ¨ä¹°å…¥å5ä¸ªå•ä½åÂ Â 
            if len(self) >= (self.bar_executed + 5): 
                # å…¨éƒ¨å–å‡ºÂ Â 
                self.log('å–å‡º, %.2f' % self.dataclose[0]) 
                # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                self.order = self.sell() 

# åˆ›å»ºCerebroå¼•æ“Â Â 
cerebro = bt.Cerebro() 
# Cerebroå¼•æ“åœ¨åå°åˆ›å»ºbroker(ç»çºªäºº)ï¼Œç³»ç»Ÿé»˜è®¤èµ„é‡‘é‡ä¸º10000 
# ä¸ºCerebroå¼•æ“æ·»åŠ ç­–ç•¥Â Â 
cerebro.addstrategy(TestStrategy) 
# è·å–å½“å‰è¿è¡Œè„šæœ¬æ‰€åœ¨ç›®å½•Â Â 
modpath = os.path.dirname(os.path.abspath(sys.argv[0])) 
# æ‹¼æ¥åŠ è½½è·¯å¾„Â Â 
datapath = os.path.join(modpath, '/home/mw/input/backtrader7822/orcl-1995-2014.txt') 
# åˆ›å»ºäº¤æ˜“æ•°æ®é›†Â Â 
data = bt.feeds.YahooFinanceCSVData( 
                                dataname=datapath, 
                                # æ•°æ®å¿…é¡»å¤§äºfromdate 
                                fromdate=datetime.datetime(2000, 1, 1), 
                                # æ•°æ®å¿…é¡»å°äºtodate 
                                todate=datetime.datetime(2000, 12, 31), 
                                reverse=False) 
# åŠ è½½äº¤æ˜“æ•°æ®Â Â 
cerebro.adddata(data) 
# è®¾ç½®æŠ•èµ„é‡‘é¢100000.0 
cerebro.broker.setcash(100000.0) 
# å¼•æ“è¿è¡Œå‰æ‰“å°æœŸå‡ºèµ„é‡‘Â Â 
print('ç»„åˆæœŸåˆèµ„é‡‘: %.2f' % cerebro.broker.getvalue()) 
cerebro.run() 
# å¼•æ“è¿è¡Œåæ‰“æœŸæœ«èµ„é‡‘Â Â 
print('ç»„åˆæœŸæœ«èµ„é‡‘: %.2f' % cerebro.broker.getvalue())
```

```
ç»„åˆæœŸåˆèµ„é‡‘: 100000.00
2000-01-03, Close, 26.27
2000-01-04, Close, 23.95
2000-01-05, Close, 22.68
2000-01-05, ä¹°å…¥, 22.68
2000-01-06, å·²ä¹°å…¥, 22.27
2000-01-06, Close, 21.35
2000-01-07, Close, 22.99
2000-01-10, Close, 25.74
2000-01-11, Close, 24.99
2000-01-12, Close, 23.49
2000-01-13, Close, 23.36
2000-01-13, å–å‡º, 23.36
2000-01-14, å·²å–å‡º, 24.24
2000-01-14, Close, 23.75
2000-01-18, Close, 24.74
2000-01-19, Close, 25.41
2000-01-20, Close, 26.35
2000-01-21, Close, 26.55
2000-01-24, Close, 24.10
2000-01-25, Close, 25.10
2000-01-26, Close, 24.49
2000-01-27, Close, 23.04
2000-01-27, ä¹°å…¥, 23.04
2000-01-28, å·²ä¹°å…¥, 22.90
2000-01-28, Close, 21.07
2000-01-31, Close, 22.22
2000-02-01, Close, 24.02
2000-02-02, Close, 24.16
2000-02-03, Close, 25.21
2000-02-04, Close, 25.71
2000-02-04, å–å‡º, 25.71
2000-02-07, å·²å–å‡º, 26.38
2000-02-07, Close, 26.66
2000-02-08, Close, 26.49
2000-02-09, Close, 26.66
2000-02-10, Close, 27.71
2000-02-11, Close, 26.55
2000-02-14, Close, 27.66
2000-02-15, Close, 27.30
2000-02-16, Close, 27.24
2000-02-16, ä¹°å…¥, 27.24
2000-02-17, å·²ä¹°å…¥, 27.46
2000-02-17, Close, 27.41
2000-02-18, Close, 26.05
2000-02-22, Close, 26.38
2000-02-23, Close, 28.05
2000-02-24, Close, 27.55
2000-02-25, Close, 31.41
2000-02-25, å–å‡º, 31.41
2000-02-28, å·²å–å‡º, 31.69
2000-02-28, Close, 30.52
2000-02-29, Close, 33.02
2000-03-01, Close, 31.80
2000-03-02, Close, 30.47
2000-03-02, ä¹°å…¥, 30.47
2000-03-03, å·²ä¹°å…¥, 31.63
2000-03-03, Close, 33.36
2000-03-06, Close, 33.69
2000-03-07, Close, 33.33
2000-03-08, Close, 36.97
2000-03-09, Close, 37.36
2000-03-10, Close, 36.30
2000-03-10, å–å‡º, 36.30
2000-03-13, å·²å–å‡º, 34.91
2000-03-13, Close, 35.02
2000-03-13, ä¹°å…¥, 35.02
2000-03-14, å·²ä¹°å…¥, 36.41
2000-03-14, Close, 34.25
2000-03-15, Close, 34.97
2000-03-16, Close, 36.44
2000-03-17, Close, 35.50
2000-03-20, Close, 34.75
2000-03-21, Close, 35.89
2000-03-21, å–å‡º, 35.89
2000-03-22, å·²å–å‡º, 36.02
2000-03-22, Close, 37.39
2000-03-23, Close, 38.64
2000-03-24, Close, 38.69
2000-03-27, Close, 39.33
2000-03-28, Close, 38.50
2000-03-29, Close, 36.69
2000-03-29, ä¹°å…¥, 36.69
2000-03-30, å·²ä¹°å…¥, 34.91
2000-03-30, Close, 34.88
2000-03-31, Close, 34.72
2000-04-03, Close, 34.19
2000-04-04, Close, 33.77
2000-04-05, Close, 34.80
2000-04-06, Close, 36.55
2000-04-06, å–å‡º, 36.55
2000-04-07, å·²å–å‡º, 37.22
2000-04-07, Close, 38.75
2000-04-10, Close, 36.69
2000-04-11, Close, 34.41
2000-04-11, ä¹°å…¥, 34.41
2000-04-12, å·²ä¹°å…¥, 34.66
2000-04-12, Close, 32.52
2000-04-13, Close, 31.99
2000-04-14, Close, 27.80
2000-04-17, Close, 33.27
2000-04-18, Close, 35.11
2000-04-19, Close, 33.16
2000-04-19, å–å‡º, 33.16
2000-04-20, å·²å–å‡º, 32.83
2000-04-20, Close, 31.49
2000-04-20, ä¹°å…¥, 31.49
2000-04-24, å·²ä¹°å…¥, 29.96
2000-04-24, Close, 32.22
2000-04-25, Close, 33.61
2000-04-26, Close, 32.11
2000-04-27, Close, 34.38
2000-04-28, Close, 35.55
2000-05-01, Close, 35.44
2000-05-01, å–å‡º, 35.44
2000-05-02, å·²å–å‡º, 35.11
2000-05-02, Close, 34.61
2000-05-02, ä¹°å…¥, 34.61
2000-05-03, å·²ä¹°å…¥, 34.19
2000-05-03, Close, 33.72
2000-05-04, Close, 33.02
2000-05-05, Close, 34.16
2000-05-08, Close, 32.16
2000-05-09, Close, 32.02
2000-05-10, Close, 30.08
2000-05-10, å–å‡º, 30.08
2000-05-11, å·²å–å‡º, 30.66
2000-05-11, Close, 32.19
2000-05-12, Close, 32.99
2000-05-15, Close, 34.25
2000-05-16, Close, 35.22
2000-05-17, Close, 34.77
2000-05-18, Close, 32.49
2000-05-18, ä¹°å…¥, 32.49
2000-05-19, å·²ä¹°å…¥, 32.02
2000-05-19, Close, 31.16
2000-05-22, Close, 30.16
2000-05-23, Close, 27.85
2000-05-24, Close, 28.57
2000-05-25, Close, 29.55
2000-05-26, Close, 29.80
2000-05-26, å–å‡º, 29.80
2000-05-30, å·²å–å‡º, 30.63
2000-05-30, Close, 32.99
2000-05-31, Close, 31.97
2000-06-01, Close, 34.63
2000-06-02, Close, 35.66
2000-06-05, Close, 36.00
2000-06-06, Close, 34.27
2000-06-07, Close, 35.58
2000-06-08, Close, 36.64
2000-06-09, Close, 36.77
2000-06-12, Close, 35.83
2000-06-13, Close, 36.33
2000-06-14, Close, 35.13
2000-06-15, Close, 36.69
2000-06-16, Close, 36.41
2000-06-19, Close, 38.25
2000-06-20, Close, 38.27
2000-06-21, Close, 38.33
2000-06-22, Close, 36.25
2000-06-23, Close, 35.36
2000-06-23, ä¹°å…¥, 35.36
2000-06-26, å·²ä¹°å…¥, 35.69
2000-06-26, Close, 36.77
2000-06-27, Close, 36.58
2000-06-28, Close, 36.89
2000-06-29, Close, 35.97
2000-06-30, Close, 37.39
2000-07-03, Close, 35.66
2000-07-03, å–å‡º, 35.66
2000-07-05, å·²å–å‡º, 34.16
2000-07-05, Close, 32.16
2000-07-05, ä¹°å…¥, 32.16
2000-07-06, å·²ä¹°å…¥, 31.91
2000-07-06, Close, 33.63
2000-07-07, Close, 33.75
2000-07-10, Close, 32.97
2000-07-11, Close, 32.16
2000-07-12, Close, 33.22
2000-07-13, Close, 33.69
2000-07-13, å–å‡º, 33.69
2000-07-14, å·²å–å‡º, 33.88
2000-07-14, Close, 33.86
2000-07-17, Close, 33.86
2000-07-18, Close, 32.99
2000-07-19, Close, 32.80
2000-07-19, ä¹°å…¥, 32.80
2000-07-20, å·²ä¹°å…¥, 33.27
2000-07-20, Close, 34.75
2000-07-21, Close, 33.55
2000-07-24, Close, 33.36
2000-07-25, Close, 33.80
2000-07-26, Close, 34.13
2000-07-27, Close, 33.38
2000-07-27, å–å‡º, 33.38
2000-07-28, å·²å–å‡º, 33.41
2000-07-28, Close, 32.19
2000-07-28, ä¹°å…¥, 32.19
2000-07-31, å·²ä¹°å…¥, 31.91
2000-07-31, Close, 33.44
2000-08-01, Close, 32.52
2000-08-02, Close, 32.52
2000-08-03, Close, 34.44
2000-08-04, Close, 36.27
2000-08-07, Close, 36.41
2000-08-07, å–å‡º, 36.41
2000-08-08, å·²å–å‡º, 36.02
2000-08-08, Close, 36.91
2000-08-09, Close, 36.19
2000-08-10, Close, 35.61
2000-08-10, ä¹°å…¥, 35.61
2000-08-11, å·²ä¹°å…¥, 35.55
2000-08-11, Close, 36.08
2000-08-14, Close, 36.64
2000-08-15, Close, 36.14
2000-08-16, Close, 36.11
2000-08-17, Close, 37.33
2000-08-18, Close, 36.16
2000-08-18, å–å‡º, 36.16
2000-08-21, å·²å–å‡º, 36.52
2000-08-21, Close, 37.00
2000-08-22, Close, 37.16
2000-08-23, Close, 36.86
2000-08-24, Close, 37.66
2000-08-25, Close, 37.64
2000-08-28, Close, 38.58
2000-08-29, Close, 39.03
2000-08-30, Close, 39.25
2000-08-31, Close, 40.44
2000-09-01, Close, 41.19
2000-09-05, Close, 40.50
2000-09-06, Close, 39.69
2000-09-06, ä¹°å…¥, 39.69
2000-09-07, å·²ä¹°å…¥, 40.08
2000-09-07, Close, 40.56
2000-09-08, Close, 38.50
2000-09-11, Close, 37.11
2000-09-12, Close, 35.30
2000-09-13, Close, 36.39
2000-09-14, Close, 37.78
2000-09-14, å–å‡º, 37.78
2000-09-15, å·²å–å‡º, 36.08
2000-09-15, Close, 34.83
2000-09-18, Close, 34.01
2000-09-18, ä¹°å…¥, 34.01
2000-09-19, å·²ä¹°å…¥, 34.44
2000-09-19, Close, 35.27
2000-09-20, Close, 35.55
2000-09-21, Close, 35.11
2000-09-22, Close, 35.91
2000-09-25, Close, 35.02
2000-09-26, Close, 35.33
2000-09-26, å–å‡º, 35.33
2000-09-27, å·²å–å‡º, 35.66
2000-09-27, Close, 35.52
2000-09-28, Close, 36.24
2000-09-29, Close, 35.02
2000-10-02, Close, 35.02
2000-10-03, Close, 30.91
2000-10-04, Close, 30.30
2000-10-04, ä¹°å…¥, 30.30
2000-10-05, å·²ä¹°å…¥, 30.38
2000-10-05, Close, 30.38
2000-10-06, Close, 30.08
2000-10-09, Close, 29.69
2000-10-10, Close, 28.74
2000-10-11, Close, 27.69
2000-10-12, Close, 28.02
2000-10-12, å–å‡º, 28.02
2000-10-13, å·²å–å‡º, 27.57
2000-10-13, Close, 31.69
2000-10-16, Close, 30.74
2000-10-17, Close, 29.96
2000-10-17, ä¹°å…¥, 29.96
2000-10-18, å·²ä¹°å…¥, 28.07
2000-10-18, Close, 29.85
2000-10-19, Close, 32.36
2000-10-20, Close, 31.35
2000-10-23, Close, 30.30
2000-10-24, Close, 31.85
2000-10-25, Close, 30.58
2000-10-25, å–å‡º, 30.58
2000-10-26, å·²å–å‡º, 30.91
2000-10-26, Close, 30.30
2000-10-26, ä¹°å…¥, 30.30
2000-10-27, å·²ä¹°å…¥, 30.69
2000-10-27, Close, 30.41
2000-10-30, Close, 28.13
2000-10-31, Close, 29.35
2000-11-01, Close, 27.91
2000-11-02, Close, 26.30
2000-11-03, Close, 26.96
2000-11-03, å–å‡º, 26.96
2000-11-06, å·²å–å‡º, 27.30
2000-11-06, Close, 24.85
2000-11-07, Close, 23.63
2000-11-07, ä¹°å…¥, 23.63
2000-11-08, å·²ä¹°å…¥, 24.35
2000-11-08, Close, 22.07
2000-11-09, Close, 24.18
2000-11-10, Close, 22.63
2000-11-13, Close, 22.01
2000-11-14, Close, 25.24
2000-11-15, Close, 25.68
2000-11-15, å–å‡º, 25.68
2000-11-16, å·²å–å‡º, 25.57
2000-11-16, Close, 24.35
2000-11-17, Close, 25.63
2000-11-20, Close, 22.01
2000-11-21, Close, 21.24
2000-11-21, ä¹°å…¥, 21.24
2000-11-22, å·²ä¹°å…¥, 21.01
2000-11-22, Close, 19.85
2000-11-24, Close, 21.46
2000-11-27, Close, 20.57
2000-11-28, Close, 20.15
2000-11-29, Close, 20.35
2000-11-30, Close, 23.57
2000-11-30, å–å‡º, 23.57
2000-12-01, å·²å–å‡º, 23.46
2000-12-01, Close, 23.52
2000-12-04, Close, 25.07
2000-12-05, Close, 28.02
2000-12-06, Close, 26.85
2000-12-07, Close, 25.18
2000-12-07, ä¹°å…¥, 25.18
2000-12-08, å·²ä¹°å…¥, 26.74
2000-12-08, Close, 26.74
2000-12-11, Close, 28.41
2000-12-12, Close, 27.35
2000-12-13, Close, 25.24
2000-12-14, Close, 24.46
2000-12-15, Close, 25.41
2000-12-15, å–å‡º, 25.41
2000-12-18, å·²å–å‡º, 26.68
2000-12-18, Close, 28.46
2000-12-19, Close, 27.24
2000-12-20, Close, 25.35
2000-12-20, ä¹°å…¥, 25.35
2000-12-21, å·²ä¹°å…¥, 24.74
2000-12-21, Close, 26.24
2000-12-22, Close, 28.35
2000-12-26, Close, 27.52
2000-12-27, Close, 27.30
2000-12-28, Close, 27.63
2000-12-29, Close, 25.85
2000-12-29, å–å‡º, 25.85
ç»„åˆæœŸæœ«èµ„é‡‘: 100017.52
```

ç«Ÿç„¶ç›ˆåˆ©äº†ï¼Œæ˜¯ä¸æ˜¯å“ªé‡Œå‡ºé”™äº†ï¼Ÿ

## 3.9 Â ç»çºªäººè¯´ï¼šæ‰‹ç»­è´¹å‘¢ï¼Ÿ

è¿™æ¯”è´¹ç”¨å«åšä½£é‡‘ã€‚è®©æˆ‘ä»¬è®¾å®šä¸€ä¸ªå¸¸è§çš„è´¹ç‡0.1%ï¼Œä¹°å–éƒ½è¦æ”¶ï¼ˆç»çºªäººå°±æ˜¯è¿™ä¹ˆè´ªï¼‰ã€‚ ä¸€è¡Œä»£ç å°±èƒ½æå®š :

```python
cerebro.broker.setcommission(commission=0.001) # 0.001å³æ˜¯0.1%
```

è®©æˆ‘çœ‹çœ‹åŠ ä¸åŠ æ‰‹ç»­è´¹ï¼Œç»“æœåˆ°åº•æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚

```python
class TestStrategy(bt.Strategy): 
    def log(self, txt, dt=None): 
        # è®°å½•ç­–ç•¥çš„æ‰§è¡Œæ—¥å¿—Â Â 
        dt = dt or self.datas[0].datetime.date(0) 
        print('%s, %s' % (dt.isoformat(), txt)) 

    def __init__(self): 
        # ä¿å­˜æ”¶ç›˜ä»·çš„å¼•ç”¨Â Â 
        self.dataclose = self.datas[0].close 
        # è·Ÿè¸ªæŒ‚å•Â Â 
        self.order = None 
        # ä¹°å…¥ä»·æ ¼å’Œæ‰‹ç»­è´¹Â Â 
        self.buyprice = None 
        self.buycomm = None 
        # è®¢å•çŠ¶æ€é€šçŸ¥ï¼Œä¹°å…¥å–å‡ºéƒ½æ˜¯ä¸‹å•Â Â 

    def notify_order(self, order): 
        if order.status in [order.Submitted, order.Accepted]:
            # broker æäº¤/æ¥å—äº†ï¼Œä¹°/å–è®¢å•åˆ™ä»€ä¹ˆéƒ½ä¸åšÂ Â 
            return 
        # æ£€æŸ¥ä¸€ä¸ªè®¢å•æ˜¯å¦å®ŒæˆÂ Â 
        # æ³¨æ„: å½“èµ„é‡‘ä¸è¶³æ—¶ï¼Œbrokerä¼šæ‹’ç»è®¢å•Â Â 
        if order.status in [order.Completed]: 
            if order.isbuy(): 
                self.log( 
                    'å·²ä¹°å…¥, ä»·æ ¼: %.2f, è´¹ç”¨: %.2f, ä½£é‡‘ %.2f' % 
                    (order.executed.price, 
                    order.executed.value, 
                    order.executed.comm)) 
                self.buyprice = order.executed.price 
                self.buycomm = order.executed.comm 
            elif order.issell(): 
                self.log('å·²å–å‡º, ä»·æ ¼: %.2f, è´¹ç”¨: %.2f, ä½£é‡‘ %.2f' % 
                    (order.executed.price, 
                    order.executed.value, 
                    order.executed.comm)) 
            # è®°å½•å½“å‰äº¤æ˜“æ•°é‡Â Â 
            self.bar_executed = len(self) 

        elif order.status in [order.Canceled, order.Margin, order.Rejected]: 
            self.log('è®¢å•å–æ¶ˆ/ä¿è¯é‡‘ä¸è¶³/æ‹’ç»')

        # å…¶ä»–çŠ¶æ€è®°å½•ä¸ºï¼šæ— æŒ‚èµ·è®¢å•Â Â 
        self.order = None 


    # äº¤æ˜“çŠ¶æ€é€šçŸ¥ï¼Œä¸€ä¹°ä¸€å–ç®—äº¤æ˜“Â Â 
    def notify_trade(self, trade): 
        if not trade.isclosed: 
            return 
        self.log('äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ %.2f, å‡€åˆ©æ¶¦ %.2f' % 
            (trade.pnl, trade.pnlcomm)) 
    def next(self): 
        # è®°å½•æ”¶ç›˜ä»·Â Â 
        self.log('Close, %.2f' % self.dataclose[0]) 
        # å¦‚æœæœ‰è®¢å•æ­£åœ¨æŒ‚èµ·ï¼Œä¸æ“ä½œÂ Â 
        if self.order: 
            return 
    # å¦‚æœæ²¡æœ‰æŒä»“åˆ™ä¹°å…¥Â Â 
        if not self.position: 
            # ä»Šå¤©çš„æ”¶ç›˜ä»· < æ˜¨å¤©æ”¶ç›˜ä»·Â Â 
            if self.dataclose[0] < self.dataclose[-1]: 
                # æ˜¨å¤©æ”¶ç›˜ä»· < å‰å¤©çš„æ”¶ç›˜ä»·Â Â 
                if self.dataclose[-1] < self.dataclose[-2]: 
                    # ä¹°å…¥Â Â 
                    self.log('ä¹°å…¥å•, %.2f' % self.dataclose[0]) 
                    # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                    self.order = self.buy() 
        else: 
            # å¦‚æœå·²ç»æŒä»“ï¼Œä¸”å½“å‰äº¤æ˜“æ•°æ®é‡åœ¨ä¹°å…¥å5ä¸ªå•ä½åÂ Â 
            if len(self) >= (self.bar_executed + 5): 
                # å…¨éƒ¨å–å‡ºÂ Â 
                self.log('å–å‡ºå•, %.2f' % self.dataclose[0]) 
                # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                self.order = self.sell()

#åˆ›å»ºCerebroå¼•æ“
cerebro=bt.Cerebro()
#Cerebroå¼•æ“åœ¨åå°åˆ›å»ºbroker(ç»çºªäºº)ï¼Œç³»ç»Ÿé»˜è®¤èµ„é‡‘é‡ä¸º10000
#ä¸ºCerebroå¼•æ“æ·»åŠ ç­–ç•¥
cerebro.addstrategy(TestStrategy)
#è·å–å½“å‰è¿è¡Œè„šæœ¬æ‰€åœ¨ç›®å½•
modpath=os.path.dirname(os.path.abspath(sys.argv[0]))
#æ‹¼æ¥åŠ è½½è·¯å¾„
datapath=os.path.join(modpath,'/home/mw/input/backtrader7822/orcl-1995-2014.txt')
#åˆ›å»ºäº¤æ˜“æ•°æ®é›†
data=bt.feeds.YahooFinanceCSVData(
dataname=datapath,
#æ•°æ®å¿…é¡»å¤§äºfromdate
fromdate=datetime.datetime(2000,1,1),
#æ•°æ®å¿…é¡»å°äºtodate
todate=datetime.datetime(2000,12,31),
reverse=False)
#åŠ è½½äº¤æ˜“æ•°æ®
cerebro.adddata(data)
#è®¾ç½®æŠ•èµ„é‡‘é¢100000.0
cerebro.broker.setcash(100000.0)
#è®¾ç½®ä½£é‡‘ä¸º0.001,é™¤ä»¥100å»æ‰%å·
cerebro.broker.setcommission(commission=0.001)
#å¼•æ“è¿è¡Œå‰æ‰“å°æœŸå‡ºèµ„é‡‘
print('ç»„åˆæœŸåˆèµ„é‡‘:%.2f'%cerebro.broker.getvalue())
cerebro.run()
#å¼•æ“è¿è¡Œåæ‰“æœŸæœ«èµ„é‡‘
print('ç»„åˆæœŸæœ«èµ„é‡‘:%.2f'%cerebro.broker.getvalue())
```

```
ç»„åˆæœŸåˆèµ„é‡‘:100000.00
2000-01-03, Close, 26.27
2000-01-04, Close, 23.95
2000-01-05, Close, 22.68
2000-01-05, ä¹°å…¥å•, 22.68
2000-01-06, å·²ä¹°å…¥, ä»·æ ¼: 22.27, è´¹ç”¨: 22.27, ä½£é‡‘ 0.02
2000-01-06, Close, 21.35
2000-01-07, Close, 22.99
2000-01-10, Close, 25.74
2000-01-11, Close, 24.99
2000-01-12, Close, 23.49
2000-01-13, Close, 23.36
2000-01-13, å–å‡ºå•, 23.36
2000-01-14, å·²å–å‡º, ä»·æ ¼: 24.24, è´¹ç”¨: 22.27, ä½£é‡‘ 0.02
2000-01-14, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 1.97, å‡€åˆ©æ¶¦ 1.92
2000-01-14, Close, 23.75
2000-01-18, Close, 24.74
2000-01-19, Close, 25.41
2000-01-20, Close, 26.35
2000-01-21, Close, 26.55
2000-01-24, Close, 24.10
2000-01-25, Close, 25.10
2000-01-26, Close, 24.49
2000-01-27, Close, 23.04
2000-01-27, ä¹°å…¥å•, 23.04
2000-01-28, å·²ä¹°å…¥, ä»·æ ¼: 22.90, è´¹ç”¨: 22.90, ä½£é‡‘ 0.02
2000-01-28, Close, 21.07
2000-01-31, Close, 22.22
2000-02-01, Close, 24.02
2000-02-02, Close, 24.16
2000-02-03, Close, 25.21
2000-02-04, Close, 25.71
2000-02-04, å–å‡ºå•, 25.71
2000-02-07, å·²å–å‡º, ä»·æ ¼: 26.38, è´¹ç”¨: 22.90, ä½£é‡‘ 0.03
2000-02-07, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 3.48, å‡€åˆ©æ¶¦ 3.43
2000-02-07, Close, 26.66
2000-02-08, Close, 26.49
2000-02-09, Close, 26.66
2000-02-10, Close, 27.71
2000-02-11, Close, 26.55
2000-02-14, Close, 27.66
2000-02-15, Close, 27.30
2000-02-16, Close, 27.24
2000-02-16, ä¹°å…¥å•, 27.24
2000-02-17, å·²ä¹°å…¥, ä»·æ ¼: 27.46, è´¹ç”¨: 27.46, ä½£é‡‘ 0.03
2000-02-17, Close, 27.41
2000-02-18, Close, 26.05
2000-02-22, Close, 26.38
2000-02-23, Close, 28.05
2000-02-24, Close, 27.55
2000-02-25, Close, 31.41
2000-02-25, å–å‡ºå•, 31.41
2000-02-28, å·²å–å‡º, ä»·æ ¼: 31.69, è´¹ç”¨: 27.46, ä½£é‡‘ 0.03
2000-02-28, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 4.23, å‡€åˆ©æ¶¦ 4.17
2000-02-28, Close, 30.52
2000-02-29, Close, 33.02
2000-03-01, Close, 31.80
2000-03-02, Close, 30.47
2000-03-02, ä¹°å…¥å•, 30.47
2000-03-03, å·²ä¹°å…¥, ä»·æ ¼: 31.63, è´¹ç”¨: 31.63, ä½£é‡‘ 0.03
2000-03-03, Close, 33.36
2000-03-06, Close, 33.69
2000-03-07, Close, 33.33
2000-03-08, Close, 36.97
2000-03-09, Close, 37.36
2000-03-10, Close, 36.30
2000-03-10, å–å‡ºå•, 36.30
2000-03-13, å·²å–å‡º, ä»·æ ¼: 34.91, è´¹ç”¨: 31.63, ä½£é‡‘ 0.03
2000-03-13, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 3.28, å‡€åˆ©æ¶¦ 3.21
2000-03-13, Close, 35.02
2000-03-13, ä¹°å…¥å•, 35.02
2000-03-14, å·²ä¹°å…¥, ä»·æ ¼: 36.41, è´¹ç”¨: 36.41, ä½£é‡‘ 0.04
2000-03-14, Close, 34.25
2000-03-15, Close, 34.97
2000-03-16, Close, 36.44
2000-03-17, Close, 35.50
2000-03-20, Close, 34.75
2000-03-21, Close, 35.89
2000-03-21, å–å‡ºå•, 35.89
2000-03-22, å·²å–å‡º, ä»·æ ¼: 36.02, è´¹ç”¨: 36.41, ä½£é‡‘ 0.04
2000-03-22, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -0.39, å‡€åˆ©æ¶¦ -0.46
2000-03-22, Close, 37.39
2000-03-23, Close, 38.64
2000-03-24, Close, 38.69
2000-03-27, Close, 39.33
2000-03-28, Close, 38.50
2000-03-29, Close, 36.69
2000-03-29, ä¹°å…¥å•, 36.69
2000-03-30, å·²ä¹°å…¥, ä»·æ ¼: 34.91, è´¹ç”¨: 34.91, ä½£é‡‘ 0.03
2000-03-30, Close, 34.88
2000-03-31, Close, 34.72
2000-04-03, Close, 34.19
2000-04-04, Close, 33.77
2000-04-05, Close, 34.80
2000-04-06, Close, 36.55
2000-04-06, å–å‡ºå•, 36.55
2000-04-07, å·²å–å‡º, ä»·æ ¼: 37.22, è´¹ç”¨: 34.91, ä½£é‡‘ 0.04
2000-04-07, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 2.31, å‡€åˆ©æ¶¦ 2.24
2000-04-07, Close, 38.75
2000-04-10, Close, 36.69
2000-04-11, Close, 34.41
2000-04-11, ä¹°å…¥å•, 34.41
2000-04-12, å·²ä¹°å…¥, ä»·æ ¼: 34.66, è´¹ç”¨: 34.66, ä½£é‡‘ 0.03
2000-04-12, Close, 32.52
2000-04-13, Close, 31.99
2000-04-14, Close, 27.80
2000-04-17, Close, 33.27
2000-04-18, Close, 35.11
2000-04-19, Close, 33.16
2000-04-19, å–å‡ºå•, 33.16
2000-04-20, å·²å–å‡º, ä»·æ ¼: 32.83, è´¹ç”¨: 34.66, ä½£é‡‘ 0.03
2000-04-20, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -1.83, å‡€åˆ©æ¶¦ -1.90
2000-04-20, Close, 31.49
2000-04-20, ä¹°å…¥å•, 31.49
2000-04-24, å·²ä¹°å…¥, ä»·æ ¼: 29.96, è´¹ç”¨: 29.96, ä½£é‡‘ 0.03
2000-04-24, Close, 32.22
2000-04-25, Close, 33.61
2000-04-26, Close, 32.11
2000-04-27, Close, 34.38
2000-04-28, Close, 35.55
2000-05-01, Close, 35.44
2000-05-01, å–å‡ºå•, 35.44
2000-05-02, å·²å–å‡º, ä»·æ ¼: 35.11, è´¹ç”¨: 29.96, ä½£é‡‘ 0.04
2000-05-02, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 5.15, å‡€åˆ©æ¶¦ 5.08
2000-05-02, Close, 34.61
2000-05-02, ä¹°å…¥å•, 34.61
2000-05-03, å·²ä¹°å…¥, ä»·æ ¼: 34.19, è´¹ç”¨: 34.19, ä½£é‡‘ 0.03
2000-05-03, Close, 33.72
2000-05-04, Close, 33.02
2000-05-05, Close, 34.16
2000-05-08, Close, 32.16
2000-05-09, Close, 32.02
2000-05-10, Close, 30.08
2000-05-10, å–å‡ºå•, 30.08
2000-05-11, å·²å–å‡º, ä»·æ ¼: 30.66, è´¹ç”¨: 34.19, ä½£é‡‘ 0.03
2000-05-11, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -3.53, å‡€åˆ©æ¶¦ -3.59
2000-05-11, Close, 32.19
2000-05-12, Close, 32.99
2000-05-15, Close, 34.25
2000-05-16, Close, 35.22
2000-05-17, Close, 34.77
2000-05-18, Close, 32.49
2000-05-18, ä¹°å…¥å•, 32.49
2000-05-19, å·²ä¹°å…¥, ä»·æ ¼: 32.02, è´¹ç”¨: 32.02, ä½£é‡‘ 0.03
2000-05-19, Close, 31.16
2000-05-22, Close, 30.16
2000-05-23, Close, 27.85
2000-05-24, Close, 28.57
2000-05-25, Close, 29.55
2000-05-26, Close, 29.80
2000-05-26, å–å‡ºå•, 29.80
2000-05-30, å·²å–å‡º, ä»·æ ¼: 30.63, è´¹ç”¨: 32.02, ä½£é‡‘ 0.03
2000-05-30, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -1.39, å‡€åˆ©æ¶¦ -1.45
2000-05-30, Close, 32.99
2000-05-31, Close, 31.97
2000-06-01, Close, 34.63
2000-06-02, Close, 35.66
2000-06-05, Close, 36.00
2000-06-06, Close, 34.27
2000-06-07, Close, 35.58
2000-06-08, Close, 36.64
2000-06-09, Close, 36.77
2000-06-12, Close, 35.83
2000-06-13, Close, 36.33
2000-06-14, Close, 35.13
2000-06-15, Close, 36.69
2000-06-16, Close, 36.41
2000-06-19, Close, 38.25
2000-06-20, Close, 38.27
2000-06-21, Close, 38.33
2000-06-22, Close, 36.25
2000-06-23, Close, 35.36
2000-06-23, ä¹°å…¥å•, 35.36
2000-06-26, å·²ä¹°å…¥, ä»·æ ¼: 35.69, è´¹ç”¨: 35.69, ä½£é‡‘ 0.04
2000-06-26, Close, 36.77
2000-06-27, Close, 36.58
2000-06-28, Close, 36.89
2000-06-29, Close, 35.97
2000-06-30, Close, 37.39
2000-07-03, Close, 35.66
2000-07-03, å–å‡ºå•, 35.66
2000-07-05, å·²å–å‡º, ä»·æ ¼: 34.16, è´¹ç”¨: 35.69, ä½£é‡‘ 0.03
2000-07-05, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -1.53, å‡€åˆ©æ¶¦ -1.60
2000-07-05, Close, 32.16
2000-07-05, ä¹°å…¥å•, 32.16
2000-07-06, å·²ä¹°å…¥, ä»·æ ¼: 31.91, è´¹ç”¨: 31.91, ä½£é‡‘ 0.03
2000-07-06, Close, 33.63
2000-07-07, Close, 33.75
2000-07-10, Close, 32.97
2000-07-11, Close, 32.16
2000-07-12, Close, 33.22
2000-07-13, Close, 33.69
2000-07-13, å–å‡ºå•, 33.69
2000-07-14, å·²å–å‡º, ä»·æ ¼: 33.88, è´¹ç”¨: 31.91, ä½£é‡‘ 0.03
2000-07-14, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 1.97, å‡€åˆ©æ¶¦ 1.90
2000-07-14, Close, 33.86
2000-07-17, Close, 33.86
2000-07-18, Close, 32.99
2000-07-19, Close, 32.80
2000-07-19, ä¹°å…¥å•, 32.80
2000-07-20, å·²ä¹°å…¥, ä»·æ ¼: 33.27, è´¹ç”¨: 33.27, ä½£é‡‘ 0.03
2000-07-20, Close, 34.75
2000-07-21, Close, 33.55
2000-07-24, Close, 33.36
2000-07-25, Close, 33.80
2000-07-26, Close, 34.13
2000-07-27, Close, 33.38
2000-07-27, å–å‡ºå•, 33.38
2000-07-28, å·²å–å‡º, ä»·æ ¼: 33.41, è´¹ç”¨: 33.27, ä½£é‡‘ 0.03
2000-07-28, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 0.14, å‡€åˆ©æ¶¦ 0.07
2000-07-28, Close, 32.19
2000-07-28, ä¹°å…¥å•, 32.19
2000-07-31, å·²ä¹°å…¥, ä»·æ ¼: 31.91, è´¹ç”¨: 31.91, ä½£é‡‘ 0.03
2000-07-31, Close, 33.44
2000-08-01, Close, 32.52
2000-08-02, Close, 32.52
2000-08-03, Close, 34.44
2000-08-04, Close, 36.27
2000-08-07, Close, 36.41
2000-08-07, å–å‡ºå•, 36.41
2000-08-08, å·²å–å‡º, ä»·æ ¼: 36.02, è´¹ç”¨: 31.91, ä½£é‡‘ 0.04
2000-08-08, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 4.11, å‡€åˆ©æ¶¦ 4.04
2000-08-08, Close, 36.91
2000-08-09, Close, 36.19
2000-08-10, Close, 35.61
2000-08-10, ä¹°å…¥å•, 35.61
2000-08-11, å·²ä¹°å…¥, ä»·æ ¼: 35.55, è´¹ç”¨: 35.55, ä½£é‡‘ 0.04
2000-08-11, Close, 36.08
2000-08-14, Close, 36.64
2000-08-15, Close, 36.14
2000-08-16, Close, 36.11
2000-08-17, Close, 37.33
2000-08-18, Close, 36.16
2000-08-18, å–å‡ºå•, 36.16
2000-08-21, å·²å–å‡º, ä»·æ ¼: 36.52, è´¹ç”¨: 35.55, ä½£é‡‘ 0.04
2000-08-21, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 0.97, å‡€åˆ©æ¶¦ 0.90
2000-08-21, Close, 37.00
2000-08-22, Close, 37.16
2000-08-23, Close, 36.86
2000-08-24, Close, 37.66
2000-08-25, Close, 37.64
2000-08-28, Close, 38.58
2000-08-29, Close, 39.03
2000-08-30, Close, 39.25
2000-08-31, Close, 40.44
2000-09-01, Close, 41.19
2000-09-05, Close, 40.50
2000-09-06, Close, 39.69
2000-09-06, ä¹°å…¥å•, 39.69
2000-09-07, å·²ä¹°å…¥, ä»·æ ¼: 40.08, è´¹ç”¨: 40.08, ä½£é‡‘ 0.04
2000-09-07, Close, 40.56
2000-09-08, Close, 38.50
2000-09-11, Close, 37.11
2000-09-12, Close, 35.30
2000-09-13, Close, 36.39
2000-09-14, Close, 37.78
2000-09-14, å–å‡ºå•, 37.78
2000-09-15, å·²å–å‡º, ä»·æ ¼: 36.08, è´¹ç”¨: 40.08, ä½£é‡‘ 0.04
2000-09-15, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -4.00, å‡€åˆ©æ¶¦ -4.08
2000-09-15, Close, 34.83
2000-09-18, Close, 34.01
2000-09-18, ä¹°å…¥å•, 34.01
2000-09-19, å·²ä¹°å…¥, ä»·æ ¼: 34.44, è´¹ç”¨: 34.44, ä½£é‡‘ 0.03
2000-09-19, Close, 35.27
2000-09-20, Close, 35.55
2000-09-21, Close, 35.11
2000-09-22, Close, 35.91
2000-09-25, Close, 35.02
2000-09-26, Close, 35.33
2000-09-26, å–å‡ºå•, 35.33
2000-09-27, å·²å–å‡º, ä»·æ ¼: 35.66, è´¹ç”¨: 34.44, ä½£é‡‘ 0.04
2000-09-27, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 1.22, å‡€åˆ©æ¶¦ 1.15
2000-09-27, Close, 35.52
2000-09-28, Close, 36.24
2000-09-29, Close, 35.02
2000-10-02, Close, 35.02
2000-10-03, Close, 30.91
2000-10-04, Close, 30.30
2000-10-04, ä¹°å…¥å•, 30.30
2000-10-05, å·²ä¹°å…¥, ä»·æ ¼: 30.38, è´¹ç”¨: 30.38, ä½£é‡‘ 0.03
2000-10-05, Close, 30.38
2000-10-06, Close, 30.08
2000-10-09, Close, 29.69
2000-10-10, Close, 28.74
2000-10-11, Close, 27.69
2000-10-12, Close, 28.02
2000-10-12, å–å‡ºå•, 28.02
2000-10-13, å·²å–å‡º, ä»·æ ¼: 27.57, è´¹ç”¨: 30.38, ä½£é‡‘ 0.03
2000-10-13, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -2.81, å‡€åˆ©æ¶¦ -2.87
2000-10-13, Close, 31.69
2000-10-16, Close, 30.74
2000-10-17, Close, 29.96
2000-10-17, ä¹°å…¥å•, 29.96
2000-10-18, å·²ä¹°å…¥, ä»·æ ¼: 28.07, è´¹ç”¨: 28.07, ä½£é‡‘ 0.03
2000-10-18, Close, 29.85
2000-10-19, Close, 32.36
2000-10-20, Close, 31.35
2000-10-23, Close, 30.30
2000-10-24, Close, 31.85
2000-10-25, Close, 30.58
2000-10-25, å–å‡ºå•, 30.58
2000-10-26, å·²å–å‡º, ä»·æ ¼: 30.91, è´¹ç”¨: 28.07, ä½£é‡‘ 0.03
2000-10-26, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 2.84, å‡€åˆ©æ¶¦ 2.78
2000-10-26, Close, 30.30
2000-10-26, ä¹°å…¥å•, 30.30
2000-10-27, å·²ä¹°å…¥, ä»·æ ¼: 30.69, è´¹ç”¨: 30.69, ä½£é‡‘ 0.03
2000-10-27, Close, 30.41
2000-10-30, Close, 28.13
2000-10-31, Close, 29.35
2000-11-01, Close, 27.91
2000-11-02, Close, 26.30
2000-11-03, Close, 26.96
2000-11-03, å–å‡ºå•, 26.96
2000-11-06, å·²å–å‡º, ä»·æ ¼: 27.30, è´¹ç”¨: 30.69, ä½£é‡‘ 0.03
2000-11-06, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -3.39, å‡€åˆ©æ¶¦ -3.45
2000-11-06, Close, 24.85
2000-11-07, Close, 23.63
2000-11-07, ä¹°å…¥å•, 23.63
2000-11-08, å·²ä¹°å…¥, ä»·æ ¼: 24.35, è´¹ç”¨: 24.35, ä½£é‡‘ 0.02
2000-11-08, Close, 22.07
2000-11-09, Close, 24.18
2000-11-10, Close, 22.63
2000-11-13, Close, 22.01
2000-11-14, Close, 25.24
2000-11-15, Close, 25.68
2000-11-15, å–å‡ºå•, 25.68
2000-11-16, å·²å–å‡º, ä»·æ ¼: 25.57, è´¹ç”¨: 24.35, ä½£é‡‘ 0.03
2000-11-16, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 1.22, å‡€åˆ©æ¶¦ 1.17
2000-11-16, Close, 24.35
2000-11-17, Close, 25.63
2000-11-20, Close, 22.01
2000-11-21, Close, 21.24
2000-11-21, ä¹°å…¥å•, 21.24
2000-11-22, å·²ä¹°å…¥, ä»·æ ¼: 21.01, è´¹ç”¨: 21.01, ä½£é‡‘ 0.02
2000-11-22, Close, 19.85
2000-11-24, Close, 21.46
2000-11-27, Close, 20.57
2000-11-28, Close, 20.15
2000-11-29, Close, 20.35
2000-11-30, Close, 23.57
2000-11-30, å–å‡ºå•, 23.57
2000-12-01, å·²å–å‡º, ä»·æ ¼: 23.46, è´¹ç”¨: 21.01, ä½£é‡‘ 0.02
2000-12-01, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 2.45, å‡€åˆ©æ¶¦ 2.41
2000-12-01, Close, 23.52
2000-12-04, Close, 25.07
2000-12-05, Close, 28.02
2000-12-06, Close, 26.85
2000-12-07, Close, 25.18
2000-12-07, ä¹°å…¥å•, 25.18
2000-12-08, å·²ä¹°å…¥, ä»·æ ¼: 26.74, è´¹ç”¨: 26.74, ä½£é‡‘ 0.03
2000-12-08, Close, 26.74
2000-12-11, Close, 28.41
2000-12-12, Close, 27.35
2000-12-13, Close, 25.24
2000-12-14, Close, 24.46
2000-12-15, Close, 25.41
2000-12-15, å–å‡ºå•, 25.41
2000-12-18, å·²å–å‡º, ä»·æ ¼: 26.68, è´¹ç”¨: 26.74, ä½£é‡‘ 0.03
2000-12-18, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -0.06, å‡€åˆ©æ¶¦ -0.11
2000-12-18, Close, 28.46
2000-12-19, Close, 27.24
2000-12-20, Close, 25.35
2000-12-20, ä¹°å…¥å•, 25.35
2000-12-21, å·²ä¹°å…¥, ä»·æ ¼: 24.74, è´¹ç”¨: 24.74, ä½£é‡‘ 0.02
2000-12-21, Close, 26.24
2000-12-22, Close, 28.35
2000-12-26, Close, 27.52
2000-12-27, Close, 27.30
2000-12-28, Close, 27.63
2000-12-29, Close, 25.85
2000-12-29, å–å‡ºå•, 25.85
ç»„åˆæœŸæœ«èµ„é‡‘:100016.06
```

## 3.10 è‡ªå®šä¹‰ç­–ç•¥:æŠ€æœ¯æŒ‡æ ‡å‚æ•°

åœ¨å®æˆ˜ä¸­ï¼Œä¸€èˆ¬ä¸å°†å‚æ•°å†™æ­»åˆ°ç­–ç•¥ä¸­ã€‚Parametersï¼ˆå‚æ•°ï¼‰å°±æ˜¯ç”¨æ¥å¤„ç†è¿™ä¸ªçš„ã€‚ å‚æ•°çš„å®šä¹‰åƒè¿™æ · :

```python
# å‚æ•°çš„å®šä¹‰åƒè¿™æ ·: 
params = (('myparam', 27), ('exitbars', 5),) 

#è¿™ä¸ª tuple åµŒå¥—çœ‹ç€ä¸æ–¹ä¾¿ï¼Œæ ¼å¼åŒ–ä¸€ä¸‹: 
params = ( 
('myparam', 27), 
('exitbars', 5), 
)
```

å°†ç­–ç•¥æ·»åŠ åˆ°å¼•æ“çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šåˆšæ‰å®šä¹‰çš„å‚æ•°:

```python
# æŒ‡å®šå‚æ•°Â Â 
cerebro.addstrategy(TestStrategy, myparam=20, exitbars=7)
```

```
1
```

> æ³¨æ„ï¼š ä¸‹é¢çš„ setsizing æ–¹æ³•å·²ç»è¢«å¼ƒç”¨ã€‚è¿™é‡Œè¿˜ä¿ç•™æ˜¯å› ä¸ºè¿˜æœ‰ä¸€äº›è€ç¤ºä¾‹åœ¨ç”¨ã€‚æ–¹æ³•å·²æ”¹ä¸ºä¸‹é¢è¿™ç§:
cerebro.addsizer(bt.sizers.FixedSize, stake=10) è¯·å‚è€ƒ sizers ç« èŠ‚ã€‚


åœ¨ç­–ç•¥ç±»ä¸­ä½¿ç”¨ä¹°å–æ•°é‡å‚æ•°å¾ˆå®¹æ˜“ï¼Œå®ƒä»¬è¢«ä¿å­˜åœ¨ â€œparamsâ€ å‚æ•°é‡Œã€‚ä¾‹å¦‚ï¼Œå‚æ•°å·²ç»ä¼ å…¥ï¼Œåœ¨ç­–ç•¥ç±»é‡Œçš„ init æ–¹æ³•ä¸­è¿™æ ·è°ƒç”¨å°±å¯ä»¥äº†:

#æ ¹æ®ä¼ å…¥çš„å‚åŠ è®¾ç½®ä¹°å–æ•°é‡

```
self.sizer.setsizing(self.params.stake)
```

ä¹Ÿå¯ä»¥ç›´æ¥å°†ä¹°å–æ•°é‡ä¼ å…¥buyå’Œsellæ–¹æ³•ã€‚ å–å‡ºçš„é€»è¾‘æ”¹ä¸º :

å·²ç»æŒæœ‰ï¼Œå¯ä»¥å–å‡ºäº†

```
if len(self) >= (self.bar_executed + self.params.exitbars)
```

ä»£ç ä¿®æ”¹ä¸º:

```python
import datetime # 
import os.path # è·¯å¾„ç®¡ç†Â Â 
import sys # è·å–å½“å‰è¿è¡Œè„šæœ¬çš„è·¯å¾„ (in argv[0]) 
#å¯¼å…¥backtraderæ¡†æ¶Â Â 
import backtrader as bt 
# åˆ›å»ºç­–ç•¥ç»§æ‰¿bt.Strategy 
class TestStrategy(bt.Strategy): 
    params = ( 
            # æŒä»“å¤Ÿ5ä¸ªå•ä½å°±å–å‡ºÂ Â 
            ('exitbars', 5), 
    )
    def log(self, txt, dt=None): 
        # è®°å½•ç­–ç•¥çš„æ‰§è¡Œæ—¥å¿—Â Â 
        dt = dt or self.datas[0].datetime.date(0) 
        print('%s, %s' % (dt.isoformat(), txt)) 
    def __init__(self): 
        # ä¿å­˜æ”¶ç›˜ä»·çš„å¼•ç”¨Â Â 
        self.dataclose = self.datas[0].close 
        # è·Ÿè¸ªæŒ‚å•Â Â 
        self.order = None
        # ä¹°å…¥ä»·æ ¼å’Œæ‰‹ç»­è´¹Â Â 
        self.buyprice = None 
        self.buycomm = None

    # è®¢å•çŠ¶æ€é€šçŸ¥ï¼Œä¹°å…¥å–å‡ºéƒ½æ˜¯ä¸‹å•Â Â 
    def notify_order(self, order): 
        if order.status in [order.Submitted, order.Accepted]: 
            # broker æäº¤/æ¥å—äº†ï¼Œä¹°/å–è®¢å•åˆ™ä»€ä¹ˆéƒ½ä¸åšÂ Â 
            return 

        # æ£€æŸ¥ä¸€ä¸ªè®¢å•æ˜¯å¦å®ŒæˆÂ Â 
        # æ³¨æ„: å½“èµ„é‡‘ä¸è¶³æ—¶ï¼Œbrokerä¼šæ‹’ç»è®¢å•Â Â 
        if order.status in [order.Completed]: 
            if order.isbuy(): 
                self.log( 
                'å·²ä¹°å…¥, ä»·æ ¼: %.2f, è´¹ç”¨: %.2f, ä½£é‡‘ %.2f' % 
                (order.executed.price, 
                order.executed.value, 
                order.executed.comm)) 
                self.buyprice = order.executed.price 
                self.buycomm = order.executed.comm 
            elif order.issell(): 
                self.log('å·²å–å‡º, ä»·æ ¼: %.2f, è´¹ç”¨: %.2f, ä½£é‡‘ %.2f' % 
                (order.executed.price, 
                order.executed.value, 
                order.executed.comm)) 
            # è®°å½•å½“å‰äº¤æ˜“æ•°é‡Â Â 
            self.bar_executed = len(self) 

        elif order.status in [order.Canceled, order.Margin, order.Rejected]: 
            self.log('è®¢å•å–æ¶ˆ/ä¿è¯é‡‘ä¸è¶³/æ‹’ç»') 

        # å…¶ä»–çŠ¶æ€è®°å½•ä¸ºï¼šæ— æŒ‚èµ·è®¢å•Â Â 
        self.order = None 


    # äº¤æ˜“çŠ¶æ€é€šçŸ¥ï¼Œä¸€ä¹°ä¸€å–ç®—äº¤æ˜“Â Â 
    def notify_trade(self, trade): 
        if not trade.isclosed: 
            return 
        self.log('äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ %.2f, å‡€åˆ©æ¶¦ %.2f' % 
        (trade.pnl, trade.pnlcomm)) 


    def next(self): 
        # è®°å½•æ”¶ç›˜ä»·Â Â 
        self.log('Close, %.2f' % self.dataclose[0]) 

        # å¦‚æœæœ‰è®¢å•æ­£åœ¨æŒ‚èµ·ï¼Œä¸æ“ä½œÂ Â 
        if self.order: 
            return 

        # å¦‚æœæ²¡æœ‰æŒä»“åˆ™ä¹°å…¥Â Â 
        if not self.position: 
            # ä»Šå¤©çš„æ”¶ç›˜ä»· < æ˜¨å¤©æ”¶ç›˜ä»·Â Â 
            if self.dataclose[0] < self.dataclose[-1]: 
                # æ˜¨å¤©æ”¶ç›˜ä»· < å‰å¤©çš„æ”¶ç›˜ä»·Â Â 
                if self.dataclose[-1] < self.dataclose[-2]: 
                    # ä¹°å…¥Â Â 
                    self.log('ä¹°å…¥å•, %.2f' % self.dataclose[0]) 
                    # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                    self.order = self.buy() 
        else: 
        # å¦‚æœå·²ç»æŒä»“ï¼Œä¸”å½“å‰äº¤æ˜“æ•°æ®é‡åœ¨ä¹°å…¥å5ä¸ªå•ä½åÂ Â 
        # æ­¤å¤„åšäº†æ›´æ–°å°†5æ›¿æ¢ä¸ºå‚æ•°Â Â 
            if len(self) >= (self.bar_executed + self.params.exitbars): 
                # å…¨éƒ¨å–å‡ºÂ Â 
                self.log('å–å‡ºå•, %.2f' % self.dataclose[0])
                # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                self.order = self.sell()



# åˆ›å»ºCerebroå¼•æ“Â Â 
cerebro = bt.Cerebro() 
# Cerebroå¼•æ“åœ¨åå°åˆ›å»ºbroker(ç»çºªäºº)ï¼Œç³»ç»Ÿé»˜è®¤èµ„é‡‘é‡ä¸º10000 
# ä¸ºCerebroå¼•æ“æ·»åŠ ç­–ç•¥Â Â 
cerebro.addstrategy(TestStrategy) 
# è·å–å½“å‰è¿è¡Œè„šæœ¬æ‰€åœ¨ç›®å½•Â Â 
modpath = os.path.dirname(os.path.abspath(sys.argv[0])) 
# æ‹¼æ¥åŠ è½½è·¯å¾„Â Â 
datapath = os.path.join(modpath, '/home/mw/input/backtrader7822/orcl-1995-2014.txt') 
# åˆ›å»ºäº¤æ˜“æ•°æ®é›†Â Â 
data = bt.feeds.YahooFinanceCSVData( 
    dataname=datapath, 
    # æ•°æ®å¿…é¡»å¤§äºfromdate 
    fromdate=datetime.datetime(2000, 1, 1), 
    # æ•°æ®å¿…é¡»å°äºtodate 
    todate=datetime.datetime(2000, 12, 31), 
    reverse=False) 
# åŠ è½½äº¤æ˜“æ•°æ®Â Â 
cerebro.adddata(data) 
# è®¾ç½®æŠ•èµ„é‡‘é¢1000000.0 
cerebro.broker.setcash(1000000.0) 
# æ¯ç¬”äº¤æ˜“ä½¿ç”¨å›ºå®šäº¤æ˜“é‡Â Â 
cerebro.addsizer(bt.sizers.FixedSize, stake=10) 
# è®¾ç½®ä½£é‡‘ä¸º0.001,é™¤ä»¥100å»æ‰%å·Â Â 
cerebro.broker.setcommission(commission=0.001) 
# å¼•æ“è¿è¡Œå‰æ‰“å°æœŸå‡ºèµ„é‡‘Â Â 
print('ç»„åˆæœŸåˆèµ„é‡‘: %.2f' % cerebro.broker.getvalue()) 
cerebro.run() 
# å¼•æ“è¿è¡Œåæ‰“æœŸæœ«èµ„é‡‘Â Â 
print('ç»„åˆæœŸæœ«èµ„é‡‘: %.2f' % cerebro.broker.getvalue())
```

```
ç»„åˆæœŸåˆèµ„é‡‘: 1000000.00
2000-01-03, Close, 26.27
2000-01-04, Close, 23.95
2000-01-05, Close, 22.68
2000-01-05, ä¹°å…¥å•, 22.68
2000-01-06, å·²ä¹°å…¥, ä»·æ ¼: 22.27, è´¹ç”¨: 222.70, ä½£é‡‘ 0.22
2000-01-06, Close, 21.35
2000-01-07, Close, 22.99
2000-01-10, Close, 25.74
2000-01-11, Close, 24.99
2000-01-12, Close, 23.49
2000-01-13, Close, 23.36
2000-01-13, å–å‡ºå•, 23.36
2000-01-14, å·²å–å‡º, ä»·æ ¼: 24.24, è´¹ç”¨: 222.70, ä½£é‡‘ 0.24
2000-01-14, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 19.70, å‡€åˆ©æ¶¦ 19.23
2000-01-14, Close, 23.75
2000-01-18, Close, 24.74
2000-01-19, Close, 25.41
2000-01-20, Close, 26.35
2000-01-21, Close, 26.55
2000-01-24, Close, 24.10
2000-01-25, Close, 25.10
2000-01-26, Close, 24.49
2000-01-27, Close, 23.04
2000-01-27, ä¹°å…¥å•, 23.04
2000-01-28, å·²ä¹°å…¥, ä»·æ ¼: 22.90, è´¹ç”¨: 229.00, ä½£é‡‘ 0.23
2000-01-28, Close, 21.07
2000-01-31, Close, 22.22
2000-02-01, Close, 24.02
2000-02-02, Close, 24.16
2000-02-03, Close, 25.21
2000-02-04, Close, 25.71
2000-02-04, å–å‡ºå•, 25.71
2000-02-07, å·²å–å‡º, ä»·æ ¼: 26.38, è´¹ç”¨: 229.00, ä½£é‡‘ 0.26
2000-02-07, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 34.80, å‡€åˆ©æ¶¦ 34.31
2000-02-07, Close, 26.66
2000-02-08, Close, 26.49
2000-02-09, Close, 26.66
2000-02-10, Close, 27.71
2000-02-11, Close, 26.55
2000-02-14, Close, 27.66
2000-02-15, Close, 27.30
2000-02-16, Close, 27.24
2000-02-16, ä¹°å…¥å•, 27.24
2000-02-17, å·²ä¹°å…¥, ä»·æ ¼: 27.46, è´¹ç”¨: 274.60, ä½£é‡‘ 0.27
2000-02-17, Close, 27.41
2000-02-18, Close, 26.05
2000-02-22, Close, 26.38
2000-02-23, Close, 28.05
2000-02-24, Close, 27.55
2000-02-25, Close, 31.41
2000-02-25, å–å‡ºå•, 31.41
2000-02-28, å·²å–å‡º, ä»·æ ¼: 31.69, è´¹ç”¨: 274.60, ä½£é‡‘ 0.32
2000-02-28, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 42.30, å‡€åˆ©æ¶¦ 41.71
2000-02-28, Close, 30.52
2000-02-29, Close, 33.02
2000-03-01, Close, 31.80
2000-03-02, Close, 30.47
2000-03-02, ä¹°å…¥å•, 30.47
2000-03-03, å·²ä¹°å…¥, ä»·æ ¼: 31.63, è´¹ç”¨: 316.30, ä½£é‡‘ 0.32
2000-03-03, Close, 33.36
2000-03-06, Close, 33.69
2000-03-07, Close, 33.33
2000-03-08, Close, 36.97
2000-03-09, Close, 37.36
2000-03-10, Close, 36.30
2000-03-10, å–å‡ºå•, 36.30
2000-03-13, å·²å–å‡º, ä»·æ ¼: 34.91, è´¹ç”¨: 316.30, ä½£é‡‘ 0.35
2000-03-13, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 32.80, å‡€åˆ©æ¶¦ 32.13
2000-03-13, Close, 35.02
2000-03-13, ä¹°å…¥å•, 35.02
2000-03-14, å·²ä¹°å…¥, ä»·æ ¼: 36.41, è´¹ç”¨: 364.10, ä½£é‡‘ 0.36
2000-03-14, Close, 34.25
2000-03-15, Close, 34.97
2000-03-16, Close, 36.44
2000-03-17, Close, 35.50
2000-03-20, Close, 34.75
2000-03-21, Close, 35.89
2000-03-21, å–å‡ºå•, 35.89
2000-03-22, å·²å–å‡º, ä»·æ ¼: 36.02, è´¹ç”¨: 364.10, ä½£é‡‘ 0.36
2000-03-22, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -3.90, å‡€åˆ©æ¶¦ -4.62
2000-03-22, Close, 37.39
2000-03-23, Close, 38.64
2000-03-24, Close, 38.69
2000-03-27, Close, 39.33
2000-03-28, Close, 38.50
2000-03-29, Close, 36.69
2000-03-29, ä¹°å…¥å•, 36.69
2000-03-30, å·²ä¹°å…¥, ä»·æ ¼: 34.91, è´¹ç”¨: 349.10, ä½£é‡‘ 0.35
2000-03-30, Close, 34.88
2000-03-31, Close, 34.72
2000-04-03, Close, 34.19
2000-04-04, Close, 33.77
2000-04-05, Close, 34.80
2000-04-06, Close, 36.55
2000-04-06, å–å‡ºå•, 36.55
2000-04-07, å·²å–å‡º, ä»·æ ¼: 37.22, è´¹ç”¨: 349.10, ä½£é‡‘ 0.37
2000-04-07, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 23.10, å‡€åˆ©æ¶¦ 22.38
2000-04-07, Close, 38.75
2000-04-10, Close, 36.69
2000-04-11, Close, 34.41
2000-04-11, ä¹°å…¥å•, 34.41
2000-04-12, å·²ä¹°å…¥, ä»·æ ¼: 34.66, è´¹ç”¨: 346.60, ä½£é‡‘ 0.35
2000-04-12, Close, 32.52
2000-04-13, Close, 31.99
2000-04-14, Close, 27.80
2000-04-17, Close, 33.27
2000-04-18, Close, 35.11
2000-04-19, Close, 33.16
2000-04-19, å–å‡ºå•, 33.16
2000-04-20, å·²å–å‡º, ä»·æ ¼: 32.83, è´¹ç”¨: 346.60, ä½£é‡‘ 0.33
2000-04-20, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -18.30, å‡€åˆ©æ¶¦ -18.97
2000-04-20, Close, 31.49
2000-04-20, ä¹°å…¥å•, 31.49
2000-04-24, å·²ä¹°å…¥, ä»·æ ¼: 29.96, è´¹ç”¨: 299.60, ä½£é‡‘ 0.30
2000-04-24, Close, 32.22
2000-04-25, Close, 33.61
2000-04-26, Close, 32.11
2000-04-27, Close, 34.38
2000-04-28, Close, 35.55
2000-05-01, Close, 35.44
2000-05-01, å–å‡ºå•, 35.44
2000-05-02, å·²å–å‡º, ä»·æ ¼: 35.11, è´¹ç”¨: 299.60, ä½£é‡‘ 0.35
2000-05-02, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 51.50, å‡€åˆ©æ¶¦ 50.85
2000-05-02, Close, 34.61
2000-05-02, ä¹°å…¥å•, 34.61
2000-05-03, å·²ä¹°å…¥, ä»·æ ¼: 34.19, è´¹ç”¨: 341.90, ä½£é‡‘ 0.34
2000-05-03, Close, 33.72
2000-05-04, Close, 33.02
2000-05-05, Close, 34.16
2000-05-08, Close, 32.16
2000-05-09, Close, 32.02
2000-05-10, Close, 30.08
2000-05-10, å–å‡ºå•, 30.08
2000-05-11, å·²å–å‡º, ä»·æ ¼: 30.66, è´¹ç”¨: 341.90, ä½£é‡‘ 0.31
2000-05-11, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -35.30, å‡€åˆ©æ¶¦ -35.95
2000-05-11, Close, 32.19
2000-05-12, Close, 32.99
2000-05-15, Close, 34.25
2000-05-16, Close, 35.22
2000-05-17, Close, 34.77
2000-05-18, Close, 32.49
2000-05-18, ä¹°å…¥å•, 32.49
2000-05-19, å·²ä¹°å…¥, ä»·æ ¼: 32.02, è´¹ç”¨: 320.20, ä½£é‡‘ 0.32
2000-05-19, Close, 31.16
2000-05-22, Close, 30.16
2000-05-23, Close, 27.85
2000-05-24, Close, 28.57
2000-05-25, Close, 29.55
2000-05-26, Close, 29.80
2000-05-26, å–å‡ºå•, 29.80
2000-05-30, å·²å–å‡º, ä»·æ ¼: 30.63, è´¹ç”¨: 320.20, ä½£é‡‘ 0.31
2000-05-30, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -13.90, å‡€åˆ©æ¶¦ -14.53
2000-05-30, Close, 32.99
2000-05-31, Close, 31.97
2000-06-01, Close, 34.63
2000-06-02, Close, 35.66
2000-06-05, Close, 36.00
2000-06-06, Close, 34.27
2000-06-07, Close, 35.58
2000-06-08, Close, 36.64
2000-06-09, Close, 36.77
2000-06-12, Close, 35.83
2000-06-13, Close, 36.33
2000-06-14, Close, 35.13
2000-06-15, Close, 36.69
2000-06-16, Close, 36.41
2000-06-19, Close, 38.25
2000-06-20, Close, 38.27
2000-06-21, Close, 38.33
2000-06-22, Close, 36.25
2000-06-23, Close, 35.36
2000-06-23, ä¹°å…¥å•, 35.36
2000-06-26, å·²ä¹°å…¥, ä»·æ ¼: 35.69, è´¹ç”¨: 356.90, ä½£é‡‘ 0.36
2000-06-26, Close, 36.77
2000-06-27, Close, 36.58
2000-06-28, Close, 36.89
2000-06-29, Close, 35.97
2000-06-30, Close, 37.39
2000-07-03, Close, 35.66
2000-07-03, å–å‡ºå•, 35.66
2000-07-05, å·²å–å‡º, ä»·æ ¼: 34.16, è´¹ç”¨: 356.90, ä½£é‡‘ 0.34
2000-07-05, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -15.30, å‡€åˆ©æ¶¦ -16.00
2000-07-05, Close, 32.16
2000-07-05, ä¹°å…¥å•, 32.16
2000-07-06, å·²ä¹°å…¥, ä»·æ ¼: 31.91, è´¹ç”¨: 319.10, ä½£é‡‘ 0.32
2000-07-06, Close, 33.63
2000-07-07, Close, 33.75
2000-07-10, Close, 32.97
2000-07-11, Close, 32.16
2000-07-12, Close, 33.22
2000-07-13, Close, 33.69
2000-07-13, å–å‡ºå•, 33.69
2000-07-14, å·²å–å‡º, ä»·æ ¼: 33.88, è´¹ç”¨: 319.10, ä½£é‡‘ 0.34
2000-07-14, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 19.70, å‡€åˆ©æ¶¦ 19.04
2000-07-14, Close, 33.86
2000-07-17, Close, 33.86
2000-07-18, Close, 32.99
2000-07-19, Close, 32.80
2000-07-19, ä¹°å…¥å•, 32.80
2000-07-20, å·²ä¹°å…¥, ä»·æ ¼: 33.27, è´¹ç”¨: 332.70, ä½£é‡‘ 0.33
2000-07-20, Close, 34.75
2000-07-21, Close, 33.55
2000-07-24, Close, 33.36
2000-07-25, Close, 33.80
2000-07-26, Close, 34.13
2000-07-27, Close, 33.38
2000-07-27, å–å‡ºå•, 33.38
2000-07-28, å·²å–å‡º, ä»·æ ¼: 33.41, è´¹ç”¨: 332.70, ä½£é‡‘ 0.33
2000-07-28, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 1.40, å‡€åˆ©æ¶¦ 0.73
2000-07-28, Close, 32.19
2000-07-28, ä¹°å…¥å•, 32.19
2000-07-31, å·²ä¹°å…¥, ä»·æ ¼: 31.91, è´¹ç”¨: 319.10, ä½£é‡‘ 0.32
2000-07-31, Close, 33.44
2000-08-01, Close, 32.52
2000-08-02, Close, 32.52
2000-08-03, Close, 34.44
2000-08-04, Close, 36.27
2000-08-07, Close, 36.41
2000-08-07, å–å‡ºå•, 36.41
2000-08-08, å·²å–å‡º, ä»·æ ¼: 36.02, è´¹ç”¨: 319.10, ä½£é‡‘ 0.36
2000-08-08, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 41.10, å‡€åˆ©æ¶¦ 40.42
2000-08-08, Close, 36.91
2000-08-09, Close, 36.19
2000-08-10, Close, 35.61
2000-08-10, ä¹°å…¥å•, 35.61
2000-08-11, å·²ä¹°å…¥, ä»·æ ¼: 35.55, è´¹ç”¨: 355.50, ä½£é‡‘ 0.36
2000-08-11, Close, 36.08
2000-08-14, Close, 36.64
2000-08-15, Close, 36.14
2000-08-16, Close, 36.11
2000-08-17, Close, 37.33
2000-08-18, Close, 36.16
2000-08-18, å–å‡ºå•, 36.16
2000-08-21, å·²å–å‡º, ä»·æ ¼: 36.52, è´¹ç”¨: 355.50, ä½£é‡‘ 0.37
2000-08-21, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 9.70, å‡€åˆ©æ¶¦ 8.98
2000-08-21, Close, 37.00
2000-08-22, Close, 37.16
2000-08-23, Close, 36.86
2000-08-24, Close, 37.66
2000-08-25, Close, 37.64
2000-08-28, Close, 38.58
2000-08-29, Close, 39.03
2000-08-30, Close, 39.25
2000-08-31, Close, 40.44
2000-09-01, Close, 41.19
2000-09-05, Close, 40.50
2000-09-06, Close, 39.69
2000-09-06, ä¹°å…¥å•, 39.69
2000-09-07, å·²ä¹°å…¥, ä»·æ ¼: 40.08, è´¹ç”¨: 400.80, ä½£é‡‘ 0.40
2000-09-07, Close, 40.56
2000-09-08, Close, 38.50
2000-09-11, Close, 37.11
2000-09-12, Close, 35.30
2000-09-13, Close, 36.39
2000-09-14, Close, 37.78
2000-09-14, å–å‡ºå•, 37.78
2000-09-15, å·²å–å‡º, ä»·æ ¼: 36.08, è´¹ç”¨: 400.80, ä½£é‡‘ 0.36
2000-09-15, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -40.00, å‡€åˆ©æ¶¦ -40.76
2000-09-15, Close, 34.83
2000-09-18, Close, 34.01
2000-09-18, ä¹°å…¥å•, 34.01
2000-09-19, å·²ä¹°å…¥, ä»·æ ¼: 34.44, è´¹ç”¨: 344.40, ä½£é‡‘ 0.34
2000-09-19, Close, 35.27
2000-09-20, Close, 35.55
2000-09-21, Close, 35.11
2000-09-22, Close, 35.91
2000-09-25, Close, 35.02
2000-09-26, Close, 35.33
2000-09-26, å–å‡ºå•, 35.33
2000-09-27, å·²å–å‡º, ä»·æ ¼: 35.66, è´¹ç”¨: 344.40, ä½£é‡‘ 0.36
2000-09-27, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 12.20, å‡€åˆ©æ¶¦ 11.50
2000-09-27, Close, 35.52
2000-09-28, Close, 36.24
2000-09-29, Close, 35.02
2000-10-02, Close, 35.02
2000-10-03, Close, 30.91
2000-10-04, Close, 30.30
2000-10-04, ä¹°å…¥å•, 30.30
2000-10-05, å·²ä¹°å…¥, ä»·æ ¼: 30.38, è´¹ç”¨: 303.80, ä½£é‡‘ 0.30
2000-10-05, Close, 30.38
2000-10-06, Close, 30.08
2000-10-09, Close, 29.69
2000-10-10, Close, 28.74
2000-10-11, Close, 27.69
2000-10-12, Close, 28.02
2000-10-12, å–å‡ºå•, 28.02
2000-10-13, å·²å–å‡º, ä»·æ ¼: 27.57, è´¹ç”¨: 303.80, ä½£é‡‘ 0.28
2000-10-13, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -28.10, å‡€åˆ©æ¶¦ -28.68
2000-10-13, Close, 31.69
2000-10-16, Close, 30.74
2000-10-17, Close, 29.96
2000-10-17, ä¹°å…¥å•, 29.96
2000-10-18, å·²ä¹°å…¥, ä»·æ ¼: 28.07, è´¹ç”¨: 280.70, ä½£é‡‘ 0.28
2000-10-18, Close, 29.85
2000-10-19, Close, 32.36
2000-10-20, Close, 31.35
2000-10-23, Close, 30.30
2000-10-24, Close, 31.85
2000-10-25, Close, 30.58
2000-10-25, å–å‡ºå•, 30.58
2000-10-26, å·²å–å‡º, ä»·æ ¼: 30.91, è´¹ç”¨: 280.70, ä½£é‡‘ 0.31
2000-10-26, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 28.40, å‡€åˆ©æ¶¦ 27.81
2000-10-26, Close, 30.30
2000-10-26, ä¹°å…¥å•, 30.30
2000-10-27, å·²ä¹°å…¥, ä»·æ ¼: 30.69, è´¹ç”¨: 306.90, ä½£é‡‘ 0.31
2000-10-27, Close, 30.41
2000-10-30, Close, 28.13
2000-10-31, Close, 29.35
2000-11-01, Close, 27.91
2000-11-02, Close, 26.30
2000-11-03, Close, 26.96
2000-11-03, å–å‡ºå•, 26.96
2000-11-06, å·²å–å‡º, ä»·æ ¼: 27.30, è´¹ç”¨: 306.90, ä½£é‡‘ 0.27
2000-11-06, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -33.90, å‡€åˆ©æ¶¦ -34.48
2000-11-06, Close, 24.85
2000-11-07, Close, 23.63
2000-11-07, ä¹°å…¥å•, 23.63
2000-11-08, å·²ä¹°å…¥, ä»·æ ¼: 24.35, è´¹ç”¨: 243.50, ä½£é‡‘ 0.24
2000-11-08, Close, 22.07
2000-11-09, Close, 24.18
2000-11-10, Close, 22.63
2000-11-13, Close, 22.01
2000-11-14, Close, 25.24
2000-11-15, Close, 25.68
2000-11-15, å–å‡ºå•, 25.68
2000-11-16, å·²å–å‡º, ä»·æ ¼: 25.57, è´¹ç”¨: 243.50, ä½£é‡‘ 0.26
2000-11-16, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 12.20, å‡€åˆ©æ¶¦ 11.70
2000-11-16, Close, 24.35
2000-11-17, Close, 25.63
2000-11-20, Close, 22.01
2000-11-21, Close, 21.24
2000-11-21, ä¹°å…¥å•, 21.24
2000-11-22, å·²ä¹°å…¥, ä»·æ ¼: 21.01, è´¹ç”¨: 210.10, ä½£é‡‘ 0.21
2000-11-22, Close, 19.85
2000-11-24, Close, 21.46
2000-11-27, Close, 20.57
2000-11-28, Close, 20.15
2000-11-29, Close, 20.35
2000-11-30, Close, 23.57
2000-11-30, å–å‡ºå•, 23.57
2000-12-01, å·²å–å‡º, ä»·æ ¼: 23.46, è´¹ç”¨: 210.10, ä½£é‡‘ 0.23
2000-12-01, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 24.50, å‡€åˆ©æ¶¦ 24.06
2000-12-01, Close, 23.52
2000-12-04, Close, 25.07
2000-12-05, Close, 28.02
2000-12-06, Close, 26.85
2000-12-07, Close, 25.18
2000-12-07, ä¹°å…¥å•, 25.18
2000-12-08, å·²ä¹°å…¥, ä»·æ ¼: 26.74, è´¹ç”¨: 267.40, ä½£é‡‘ 0.27
2000-12-08, Close, 26.74
2000-12-11, Close, 28.41
2000-12-12, Close, 27.35
2000-12-13, Close, 25.24
2000-12-14, Close, 24.46
2000-12-15, Close, 25.41
2000-12-15, å–å‡ºå•, 25.41
2000-12-18, å·²å–å‡º, ä»·æ ¼: 26.68, è´¹ç”¨: 267.40, ä½£é‡‘ 0.27
2000-12-18, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -0.60, å‡€åˆ©æ¶¦ -1.13
2000-12-18, Close, 28.46
2000-12-19, Close, 27.24
2000-12-20, Close, 25.35
2000-12-20, ä¹°å…¥å•, 25.35
2000-12-21, å·²ä¹°å…¥, ä»·æ ¼: 24.74, è´¹ç”¨: 247.40, ä½£é‡‘ 0.25
2000-12-21, Close, 26.24
2000-12-22, Close, 28.35
2000-12-26, Close, 27.52
2000-12-27, Close, 27.30
2000-12-28, Close, 27.63
2000-12-29, Close, 25.85
2000-12-29, å–å‡ºå•, 25.85
ç»„åˆæœŸæœ«èµ„é‡‘: 1000160.58
```

ä¸ºäº†æ˜¾ç¤ºæ”¹å˜å·²ç”Ÿæ•ˆï¼Œè¾“å‡ºä¸­æ˜¾ç¤ºäº†ä¹°å–æ•°é‡ã€‚ ä¹°å–æ•°é‡æ”¹ä¸ºäº†åŸæ¥çš„ 10å€ï¼Œç›ˆäºä¹Ÿå˜ä¸ºäº†åŸæ¥çš„10å€ã€‚

## 3.11 æ·»åŠ æŠ€æœ¯æŒ‡æ ‡

ä¹‹å‰æˆ‘æåˆ°è¿‡indicatorsï¼ˆæŠ€æœ¯æŒ‡æ ‡ï¼‰ï¼Œä¸‹ä¸€æ­¥å°±è¯¥æ·»åŠ ä»–ä»¬äº†ï¼Œè¦åšçš„è‚¯å®šæ¯”â€œä¸‰è¿è·Œâ€è¿™ç§å¤æ‚ç‚¹ã€‚å€Ÿç”¨PyAlgoTradeè¿™ä¸ªæ¡†æ¶çš„ä¸€ä¸ªä½¿ç”¨ç§»åŠ¨Â Â å¹³å‡çº¿çš„ä¾‹å­ï¼š

- æ”¶ç›˜ä»·é«˜äºå¹³å‡ä»·çš„æ—¶å€™ï¼Œä»¥å¸‚ä»·ä¹°å…¥
- æŒæœ‰ä»“ä½çš„æ—¶å€™ï¼Œå¦‚æœæ”¶ç›˜ä»·ä½äºå¹³å‡ä»·ï¼Œå–å‡º
- åªæœ‰ä¸€ä¸ªå¾…æ‰§è¡Œçš„è®¢å•

å¤§å¤šæ•°ä»£ç ä¸ç”¨æ”¹å˜ï¼Œåœ¨ init æ–¹æ³•ä¸­åŠ å…¥ç§»åŠ¨å¹³å‡çº¿çš„å®ä¾‹åŒ–:

## åŠ å…¥ç§»åŠ¨å¹³å‡çº¿

`sma = bt.indicators.MovingAverageSimple(datas[0], period=params.maperiod)`

å½“ç„¶ä¹°å…¥å–å‡ºçš„é€»è¾‘ä¾èµ–å¹³å‡ä»·ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ã€‚

> æ³¨æ„ï¼š èµ·å§‹é‡‘é¢ä¸º1000å…ƒï¼Œæ— æ‰‹ç»­è´¹ï¼Œè¿™å’Œ PyAlgoTrade ä¿æŒä¸€è‡´ã€‚


```python
import datetime # 
import os.path # è·¯å¾„ç®¡ç†Â Â 
import sys # è·å–å½“å‰è¿è¡Œè„šæœ¬çš„è·¯å¾„ (in argv[0]) 
#å¯¼å…¥backtraderæ¡†æ¶Â Â 
import backtrader as bt 
# åˆ›å»ºç­–ç•¥ç»§æ‰¿bt.Strategy 
class TestStrategy(bt.Strategy): 
    params = ( 
        # å‡çº¿å‚æ•°è®¾ç½®15å¤©ï¼Œ15æ—¥å‡çº¿Â Â 
        ('maperiod', 15), 
        )


    def log(self, txt, dt=None): 
        # è®°å½•ç­–ç•¥çš„æ‰§è¡Œæ—¥å¿—Â Â 
        dt = dt or self.datas[0].datetime.date(0) 
        print('%s, %s' % (dt.isoformat(), txt))


    def __init__(self): 
        # ä¿å­˜æ”¶ç›˜ä»·çš„å¼•ç”¨Â Â 
        self.dataclose = self.datas[0].close 
        # è·Ÿè¸ªæŒ‚å•Â Â 
        self.order = None 
        # ä¹°å…¥ä»·æ ¼å’Œæ‰‹ç»­è´¹Â Â 
        self.buyprice = None 
        self.buycomm = None 
        # åŠ å…¥å‡çº¿æŒ‡æ ‡Â Â 
        self.sma = bt.indicators.SimpleMovingAverage(self.datas[0], period=self.params.maperiod) 


    # è®¢å•çŠ¶æ€é€šçŸ¥ï¼Œä¹°å…¥å–å‡ºéƒ½æ˜¯ä¸‹å•Â Â 
    def notify_order(self, order): 
        if order.status in [order.Submitted, order.Accepted]: 
            # broker æäº¤/æ¥å—äº†ï¼Œä¹°/å–è®¢å•åˆ™ä»€ä¹ˆéƒ½ä¸åšÂ Â 
            return 
        # æ£€æŸ¥ä¸€ä¸ªè®¢å•æ˜¯å¦å®ŒæˆÂ Â 
        # æ³¨æ„: å½“èµ„é‡‘ä¸è¶³æ—¶ï¼Œbrokerä¼šæ‹’ç»è®¢å•Â Â 
        if order.status in [order.Completed]: 
            if order.isbuy(): 
                self.log( 
                    'å·²ä¹°å…¥, ä»·æ ¼: %.2f, è´¹ç”¨: %.2f, ä½£é‡‘ %.2f' % 
                    (order.executed.price, 
                    order.executed.value, 
                    order.executed.comm)) 
                self.buyprice = order.executed.price 
                self.buycomm = order.executed.comm 
            elif order.issell(): 
                self.log('å·²å–å‡º, ä»·æ ¼: %.2f, è´¹ç”¨: %.2f, ä½£é‡‘ %.2f' % 
                    (order.executed.price, 
                    order.executed.value, 
                    order.executed.comm)) 

            # è®°å½•å½“å‰äº¤æ˜“æ•°é‡Â Â 
            self.bar_executed = len(self) 
        elif order.status in [order.Canceled, order.Margin, order.Rejected]: 
            self.log('è®¢å•å–æ¶ˆ/ä¿è¯é‡‘ä¸è¶³/æ‹’ç»')
        # å…¶ä»–çŠ¶æ€è®°å½•ä¸ºï¼šæ— æŒ‚èµ·è®¢å•Â Â 
        self.order = None

    # äº¤æ˜“çŠ¶æ€é€šçŸ¥ï¼Œä¸€ä¹°ä¸€å–ç®—äº¤æ˜“Â Â 
    def notify_trade(self, trade): 
        if not trade.isclosed: 
            return 
        self.log('äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ %.2f, å‡€åˆ©æ¶¦ %.2f' % 
        (trade.pnl, trade.pnlcomm)) 

    def next(self): 
        # è®°å½•æ”¶ç›˜ä»·Â Â 
        self.log('Close, %.2f' % self.dataclose[0]) 

        # å¦‚æœæœ‰è®¢å•æ­£åœ¨æŒ‚èµ·ï¼Œä¸æ“ä½œÂ Â 
        if self.order: 
            return 

        # å¦‚æœæ²¡æœ‰æŒä»“åˆ™ä¹°å…¥Â Â 
        if not self.position: 
            # ä»Šå¤©çš„æ”¶ç›˜ä»·åœ¨å‡çº¿ä»·æ ¼ä¹‹ä¸ŠÂ Â 
            if self.dataclose[0] > self.sma[0]: 
                # ä¹°å…¥Â Â 
                self.log('ä¹°å…¥å•, %.2f' % self.dataclose[0]) 
                # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                self.order = self.buy() 
        else: 
            # å¦‚æœå·²ç»æŒä»“ï¼Œæ”¶ç›˜ä»·åœ¨å‡çº¿ä»·æ ¼ä¹‹ä¸‹Â Â 
            if self.dataclose[0] < self.sma[0]: 
                # å…¨éƒ¨å–å‡ºÂ Â 
                self.log('å–å‡ºå•, %.2f' % self.dataclose[0]) 
                # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                self.order = self.sell()



# åˆ›å»ºCerebroå¼•æ“Â Â 
cerebro = bt.Cerebro() 
# Cerebroå¼•æ“åœ¨åå°åˆ›å»ºbroker(ç»çºªäºº)ï¼Œç³»ç»Ÿé»˜è®¤èµ„é‡‘é‡ä¸º10000 
# ä¸ºCerebroå¼•æ“æ·»åŠ ç­–ç•¥Â Â 
cerebro.addstrategy(TestStrategy) 
# è·å–å½“å‰è¿è¡Œè„šæœ¬æ‰€åœ¨ç›®å½•
modpath = os.path.dirname(os.path.abspath(sys.argv[0])) 
# æ‹¼æ¥åŠ è½½è·¯å¾„Â Â 
datapath = os.path.join(modpath, '/home/mw/input/backtrader7822/orcl-1995-2014.txt') 
# åˆ›å»ºäº¤æ˜“æ•°æ®é›†Â Â 
data = bt.feeds.YahooFinanceCSVData( 
dataname=datapath, 
# æ•°æ®å¿…é¡»å¤§äºfromdate 
fromdate=datetime.datetime(2000, 1, 1), 
# æ•°æ®å¿…é¡»å°äºtodate 
todate=datetime.datetime(2000, 12, 31), 
reverse=False) 
# åŠ è½½äº¤æ˜“æ•°æ®Â Â 
cerebro.adddata(data) 
# è®¾ç½®æŠ•èµ„é‡‘é¢1000.0 
cerebro.broker.setcash(1000.0) 
# æ¯ç¬”äº¤æ˜“ä½¿ç”¨å›ºå®šäº¤æ˜“é‡Â Â 
cerebro.addsizer(bt.sizers.FixedSize, stake=10) 
# è®¾ç½®ä½£é‡‘ä¸º0.0 
cerebro.broker.setcommission(commission=0.0) 
# å¼•æ“è¿è¡Œå‰æ‰“å°æœŸå‡ºèµ„é‡‘Â Â 
print('ç»„åˆæœŸåˆèµ„é‡‘: %.2f' % cerebro.broker.getvalue()) 
cerebro.run() 
# å¼•æ“è¿è¡Œåæ‰“æœŸæœ«èµ„é‡‘Â Â 
print('ç»„åˆæœŸæœ«èµ„é‡‘: %.2f' % cerebro.broker.getvalue())
```

```
ç»„åˆæœŸåˆèµ„é‡‘: 1000.00
2000-01-24, Close, 24.10
2000-01-25, Close, 25.10
2000-01-25, ä¹°å…¥å•, 25.10
2000-01-26, å·²ä¹°å…¥, ä»·æ ¼: 25.24, è´¹ç”¨: 252.40, ä½£é‡‘ 0.00
2000-01-26, Close, 24.49
2000-01-27, Close, 23.04
2000-01-27, å–å‡ºå•, 23.04
2000-01-28, å·²å–å‡º, ä»·æ ¼: 22.90, è´¹ç”¨: 252.40, ä½£é‡‘ 0.00
2000-01-28, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -23.40, å‡€åˆ©æ¶¦ -23.40
2000-01-28, Close, 21.07
2000-01-31, Close, 22.22
2000-02-01, Close, 24.02
2000-02-02, Close, 24.16
2000-02-02, ä¹°å…¥å•, 24.16
2000-02-03, å·²ä¹°å…¥, ä»·æ ¼: 24.63, è´¹ç”¨: 246.30, ä½£é‡‘ 0.00
2000-02-03, Close, 25.21
2000-02-04, Close, 25.71
2000-02-07, Close, 26.66
2000-02-08, Close, 26.49
2000-02-09, Close, 26.66
2000-02-10, Close, 27.71
2000-02-11, Close, 26.55
2000-02-14, Close, 27.66
2000-02-15, Close, 27.30
2000-02-16, Close, 27.24
2000-02-17, Close, 27.41
2000-02-18, Close, 26.05
2000-02-18, å–å‡ºå•, 26.05
2000-02-22, å·²å–å‡º, ä»·æ ¼: 26.30, è´¹ç”¨: 246.30, ä½£é‡‘ 0.00
2000-02-22, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 16.70, å‡€åˆ©æ¶¦ 16.70
2000-02-22, Close, 26.38
2000-02-22, ä¹°å…¥å•, 26.38
2000-02-23, å·²ä¹°å…¥, ä»·æ ¼: 26.77, è´¹ç”¨: 267.70, ä½£é‡‘ 0.00
2000-02-23, Close, 28.05
2000-02-24, Close, 27.55
2000-02-25, Close, 31.41
2000-02-28, Close, 30.52
2000-02-29, Close, 33.02
2000-03-01, Close, 31.80
2000-03-02, Close, 30.47
2000-03-03, Close, 33.36
2000-03-06, Close, 33.69
2000-03-07, Close, 33.33
2000-03-08, Close, 36.97
2000-03-09, Close, 37.36
2000-03-10, Close, 36.30
2000-03-13, Close, 35.02
2000-03-14, Close, 34.25
2000-03-15, Close, 34.97
2000-03-16, Close, 36.44
2000-03-17, Close, 35.50
2000-03-20, Close, 34.75
2000-03-21, Close, 35.89
2000-03-22, Close, 37.39
2000-03-23, Close, 38.64
2000-03-24, Close, 38.69
2000-03-27, Close, 39.33
2000-03-28, Close, 38.50
2000-03-29, Close, 36.69
2000-03-30, Close, 34.88
2000-03-30, å–å‡ºå•, 34.88
2000-03-31, å·²å–å‡º, ä»·æ ¼: 35.66, è´¹ç”¨: 267.70, ä½£é‡‘ 0.00
2000-03-31, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 88.90, å‡€åˆ©æ¶¦ 88.90
2000-03-31, Close, 34.72
2000-04-03, Close, 34.19
2000-04-04, Close, 33.77
2000-04-05, Close, 34.80
2000-04-06, Close, 36.55
2000-04-06, ä¹°å…¥å•, 36.55
2000-04-07, å·²ä¹°å…¥, ä»·æ ¼: 37.22, è´¹ç”¨: 372.20, ä½£é‡‘ 0.00
2000-04-07, Close, 38.75
2000-04-10, Close, 36.69
2000-04-11, Close, 34.41
2000-04-11, å–å‡ºå•, 34.41
2000-04-12, å·²å–å‡º, ä»·æ ¼: 34.66, è´¹ç”¨: 372.20, ä½£é‡‘ 0.00
2000-04-12, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -25.60, å‡€åˆ©æ¶¦ -25.60
2000-04-12, Close, 32.52
2000-04-13, Close, 31.99
2000-04-14, Close, 27.80
2000-04-17, Close, 33.27
2000-04-18, Close, 35.11
2000-04-18, ä¹°å…¥å•, 35.11
2000-04-19, å·²ä¹°å…¥, ä»·æ ¼: 34.97, è´¹ç”¨: 349.70, ä½£é‡‘ 0.00
2000-04-19, Close, 33.16
2000-04-19, å–å‡ºå•, 33.16
2000-04-20, å·²å–å‡º, ä»·æ ¼: 32.83, è´¹ç”¨: 349.70, ä½£é‡‘ 0.00
2000-04-20, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -21.40, å‡€åˆ©æ¶¦ -21.40
2000-04-20, Close, 31.49
2000-04-24, Close, 32.22
2000-04-25, Close, 33.61
2000-04-26, Close, 32.11
2000-04-27, Close, 34.38
2000-04-27, ä¹°å…¥å•, 34.38
2000-04-28, å·²ä¹°å…¥, ä»·æ ¼: 34.91, è´¹ç”¨: 349.10, ä½£é‡‘ 0.00
2000-04-28, Close, 35.55
2000-05-01, Close, 35.44
2000-05-02, Close, 34.61
2000-05-03, Close, 33.72
2000-05-04, Close, 33.02
2000-05-04, å–å‡ºå•, 33.02
2000-05-05, å·²å–å‡º, ä»·æ ¼: 32.91, è´¹ç”¨: 349.10, ä½£é‡‘ 0.00
2000-05-05, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -20.00, å‡€åˆ©æ¶¦ -20.00
2000-05-05, Close, 34.16
2000-05-05, ä¹°å…¥å•, 34.16
2000-05-08, å·²ä¹°å…¥, ä»·æ ¼: 33.49, è´¹ç”¨: 334.90, ä½£é‡‘ 0.00
2000-05-08, Close, 32.16
2000-05-08, å–å‡ºå•, 32.16
2000-05-09, å·²å–å‡º, ä»·æ ¼: 32.77, è´¹ç”¨: 334.90, ä½£é‡‘ 0.00
2000-05-09, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -7.20, å‡€åˆ©æ¶¦ -7.20
2000-05-09, Close, 32.02
2000-05-10, Close, 30.08
2000-05-11, Close, 32.19
2000-05-12, Close, 32.99
2000-05-15, Close, 34.25
2000-05-15, ä¹°å…¥å•, 34.25
2000-05-16, å·²ä¹°å…¥, ä»·æ ¼: 34.52, è´¹ç”¨: 345.20, ä½£é‡‘ 0.00
2000-05-16, Close, 35.22
2000-05-17, Close, 34.77
2000-05-18, Close, 32.49
2000-05-18, å–å‡ºå•, 32.49
2000-05-19, å·²å–å‡º, ä»·æ ¼: 32.02, è´¹ç”¨: 345.20, ä½£é‡‘ 0.00
2000-05-19, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -25.00, å‡€åˆ©æ¶¦ -25.00
2000-05-19, Close, 31.16
2000-05-22, Close, 30.16
2000-05-23, Close, 27.85
2000-05-24, Close, 28.57
2000-05-25, Close, 29.55
2000-05-26, Close, 29.80
2000-05-30, Close, 32.99
2000-05-30, ä¹°å…¥å•, 32.99
2000-05-31, å·²ä¹°å…¥, ä»·æ ¼: 32.58, è´¹ç”¨: 325.80, ä½£é‡‘ 0.00
2000-05-31, Close, 31.97
2000-06-01, Close, 34.63
2000-06-02, Close, 35.66
2000-06-05, Close, 36.00
2000-06-06, Close, 34.27
2000-06-07, Close, 35.58
2000-06-08, Close, 36.64
2000-06-09, Close, 36.77
2000-06-12, Close, 35.83
2000-06-13, Close, 36.33
2000-06-14, Close, 35.13
2000-06-15, Close, 36.69
2000-06-16, Close, 36.41
2000-06-19, Close, 38.25
2000-06-20, Close, 38.27
2000-06-21, Close, 38.33
2000-06-22, Close, 36.25
2000-06-22, å–å‡ºå•, 36.25
2000-06-23, å·²å–å‡º, ä»·æ ¼: 35.94, è´¹ç”¨: 325.80, ä½£é‡‘ 0.00
2000-06-23, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 33.60, å‡€åˆ©æ¶¦ 33.60
2000-06-23, Close, 35.36
2000-06-26, Close, 36.77
2000-06-26, ä¹°å…¥å•, 36.77
2000-06-27, å·²ä¹°å…¥, ä»·æ ¼: 36.64, è´¹ç”¨: 366.40, ä½£é‡‘ 0.00
2000-06-27, Close, 36.58
2000-06-27, å–å‡ºå•, 36.58
2000-06-28, å·²å–å‡º, ä»·æ ¼: 36.50, è´¹ç”¨: 366.40, ä½£é‡‘ 0.00
2000-06-28, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -1.40, å‡€åˆ©æ¶¦ -1.40
2000-06-28, Close, 36.89
2000-06-28, ä¹°å…¥å•, 36.89
2000-06-29, å·²ä¹°å…¥, ä»·æ ¼: 36.50, è´¹ç”¨: 365.00, ä½£é‡‘ 0.00
2000-06-29, Close, 35.97
2000-06-29, å–å‡ºå•, 35.97
2000-06-30, å·²å–å‡º, ä»·æ ¼: 35.75, è´¹ç”¨: 365.00, ä½£é‡‘ 0.00
2000-06-30, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -7.50, å‡€åˆ©æ¶¦ -7.50
2000-06-30, Close, 37.39
2000-06-30, ä¹°å…¥å•, 37.39
2000-07-03, å·²ä¹°å…¥, ä»·æ ¼: 36.08, è´¹ç”¨: 360.80, ä½£é‡‘ 0.00
2000-07-03, Close, 35.66
2000-07-03, å–å‡ºå•, 35.66
2000-07-05, å·²å–å‡º, ä»·æ ¼: 34.16, è´¹ç”¨: 360.80, ä½£é‡‘ 0.00
2000-07-05, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -19.20, å‡€åˆ©æ¶¦ -19.20
2000-07-05, Close, 32.16
2000-07-06, Close, 33.63
2000-07-07, Close, 33.75
2000-07-10, Close, 32.97
2000-07-11, Close, 32.16
2000-07-12, Close, 33.22
2000-07-13, Close, 33.69
2000-07-14, Close, 33.86
2000-07-17, Close, 33.86
2000-07-18, Close, 32.99
2000-07-19, Close, 32.80
2000-07-20, Close, 34.75
2000-07-20, ä¹°å…¥å•, 34.75
2000-07-21, å·²ä¹°å…¥, ä»·æ ¼: 34.44, è´¹ç”¨: 344.40, ä½£é‡‘ 0.00
2000-07-21, Close, 33.55
2000-07-21, å–å‡ºå•, 33.55
2000-07-24, å·²å–å‡º, ä»·æ ¼: 34.30, è´¹ç”¨: 344.40, ä½£é‡‘ 0.00
2000-07-24, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -1.40, å‡€åˆ©æ¶¦ -1.40
2000-07-24, Close, 33.36
2000-07-25, Close, 33.80
2000-07-25, ä¹°å…¥å•, 33.80
2000-07-26, å·²ä¹°å…¥, ä»·æ ¼: 33.27, è´¹ç”¨: 332.70, ä½£é‡‘ 0.00
2000-07-26, Close, 34.13
2000-07-27, Close, 33.38
2000-07-27, å–å‡ºå•, 33.38
2000-07-28, å·²å–å‡º, ä»·æ ¼: 33.41, è´¹ç”¨: 332.70, ä½£é‡‘ 0.00
2000-07-28, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 1.40, å‡€åˆ©æ¶¦ 1.40
2000-07-28, Close, 32.19
2000-07-31, Close, 33.44
2000-07-31, ä¹°å…¥å•, 33.44
2000-08-01, å·²ä¹°å…¥, ä»·æ ¼: 33.44, è´¹ç”¨: 334.40, ä½£é‡‘ 0.00
2000-08-01, Close, 32.52
2000-08-01, å–å‡ºå•, 32.52
2000-08-02, å·²å–å‡º, ä»·æ ¼: 32.47, è´¹ç”¨: 334.40, ä½£é‡‘ 0.00
2000-08-02, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -9.70, å‡€åˆ©æ¶¦ -9.70
2000-08-02, Close, 32.52
2000-08-03, Close, 34.44
2000-08-03, ä¹°å…¥å•, 34.44
2000-08-04, å·²ä¹°å…¥, ä»·æ ¼: 34.83, è´¹ç”¨: 348.30, ä½£é‡‘ 0.00
2000-08-04, Close, 36.27
2000-08-07, Close, 36.41
2000-08-08, Close, 36.91
2000-08-09, Close, 36.19
2000-08-10, Close, 35.61
2000-08-11, Close, 36.08
2000-08-14, Close, 36.64
2000-08-15, Close, 36.14
2000-08-16, Close, 36.11
2000-08-17, Close, 37.33
2000-08-18, Close, 36.16
2000-08-21, Close, 37.00
2000-08-22, Close, 37.16
2000-08-23, Close, 36.86
2000-08-24, Close, 37.66
2000-08-25, Close, 37.64
2000-08-28, Close, 38.58
2000-08-29, Close, 39.03
2000-08-30, Close, 39.25
2000-08-31, Close, 40.44
2000-09-01, Close, 41.19
2000-09-05, Close, 40.50
2000-09-06, Close, 39.69
2000-09-07, Close, 40.56
2000-09-08, Close, 38.50
2000-09-08, å–å‡ºå•, 38.50
2000-09-11, å·²å–å‡º, ä»·æ ¼: 38.28, è´¹ç”¨: 348.30, ä½£é‡‘ 0.00
2000-09-11, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 34.50, å‡€åˆ©æ¶¦ 34.50
2000-09-11, Close, 37.11
2000-09-12, Close, 35.30
2000-09-13, Close, 36.39
2000-09-14, Close, 37.78
2000-09-15, Close, 34.83
2000-09-18, Close, 34.01
2000-09-19, Close, 35.27
2000-09-20, Close, 35.55
2000-09-21, Close, 35.11
2000-09-22, Close, 35.91
2000-09-25, Close, 35.02
2000-09-26, Close, 35.33
2000-09-27, Close, 35.52
2000-09-28, Close, 36.24
2000-09-28, ä¹°å…¥å•, 36.24
2000-09-29, å·²ä¹°å…¥, ä»·æ ¼: 36.18, è´¹ç”¨: 361.80, ä½£é‡‘ 0.00
2000-09-29, Close, 35.02
2000-09-29, å–å‡ºå•, 35.02
2000-10-02, å·²å–å‡º, ä»·æ ¼: 35.47, è´¹ç”¨: 361.80, ä½£é‡‘ 0.00
2000-10-02, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -7.10, å‡€åˆ©æ¶¦ -7.10
2000-10-02, Close, 35.02
2000-10-03, Close, 30.91
2000-10-04, Close, 30.30
2000-10-05, Close, 30.38
2000-10-06, Close, 30.08
2000-10-09, Close, 29.69
2000-10-10, Close, 28.74
2000-10-11, Close, 27.69
2000-10-12, Close, 28.02
2000-10-13, Close, 31.69
2000-10-16, Close, 30.74
2000-10-17, Close, 29.96
2000-10-18, Close, 29.85
2000-10-19, Close, 32.36
2000-10-19, ä¹°å…¥å•, 32.36
2000-10-20, å·²ä¹°å…¥, ä»·æ ¼: 32.13, è´¹ç”¨: 321.30, ä½£é‡‘ 0.00
2000-10-20, Close, 31.35
2000-10-23, Close, 30.30
2000-10-24, Close, 31.85
2000-10-25, Close, 30.58
2000-10-26, Close, 30.30
2000-10-27, Close, 30.41
2000-10-30, Close, 28.13
2000-10-30, å–å‡ºå•, 28.13
2000-10-31, å·²å–å‡º, ä»·æ ¼: 29.02, è´¹ç”¨: 321.30, ä½£é‡‘ 0.00
2000-10-31, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -31.10, å‡€åˆ©æ¶¦ -31.10
2000-10-31, Close, 29.35
2000-11-01, Close, 27.91
2000-11-02, Close, 26.30
2000-11-03, Close, 26.96
2000-11-06, Close, 24.85
2000-11-07, Close, 23.63
2000-11-08, Close, 22.07
2000-11-09, Close, 24.18
2000-11-10, Close, 22.63
2000-11-13, Close, 22.01
2000-11-14, Close, 25.24
2000-11-15, Close, 25.68
2000-11-16, Close, 24.35
2000-11-17, Close, 25.63
2000-11-17, ä¹°å…¥å•, 25.63
2000-11-20, å·²ä¹°å…¥, ä»·æ ¼: 21.63, è´¹ç”¨: 216.30, ä½£é‡‘ 0.00
2000-11-20, Close, 22.01
2000-11-20, å–å‡ºå•, 22.01
2000-11-21, å·²å–å‡º, ä»·æ ¼: 22.07, è´¹ç”¨: 216.30, ä½£é‡‘ 0.00
2000-11-21, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 4.40, å‡€åˆ©æ¶¦ 4.40
2000-11-21, Close, 21.24
2000-11-22, Close, 19.85
2000-11-24, Close, 21.46
2000-11-27, Close, 20.57
2000-11-28, Close, 20.15
2000-11-29, Close, 20.35
2000-11-30, Close, 23.57
2000-11-30, ä¹°å…¥å•, 23.57
2000-12-01, å·²ä¹°å…¥, ä»·æ ¼: 23.46, è´¹ç”¨: 234.60, ä½£é‡‘ 0.00
2000-12-01, Close, 23.52
2000-12-04, Close, 25.07
2000-12-05, Close, 28.02
2000-12-06, Close, 26.85
2000-12-07, Close, 25.18
2000-12-08, Close, 26.74
2000-12-11, Close, 28.41
2000-12-12, Close, 27.35
2000-12-13, Close, 25.24
2000-12-14, Close, 24.46
2000-12-14, å–å‡ºå•, 24.46
2000-12-15, å·²å–å‡º, ä»·æ ¼: 26.18, è´¹ç”¨: 234.60, ä½£é‡‘ 0.00
2000-12-15, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 27.20, å‡€åˆ©æ¶¦ 27.20
2000-12-15, Close, 25.41
2000-12-15, ä¹°å…¥å•, 25.41
2000-12-18, å·²ä¹°å…¥, ä»·æ ¼: 26.68, è´¹ç”¨: 266.80, ä½£é‡‘ 0.00
2000-12-18, Close, 28.46
2000-12-19, Close, 27.24
2000-12-20, Close, 25.35
2000-12-20, å–å‡ºå•, 25.35
2000-12-21, å·²å–å‡º, ä»·æ ¼: 24.74, è´¹ç”¨: 266.80, ä½£é‡‘ 0.00
2000-12-21, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -19.40, å‡€åˆ©æ¶¦ -19.40
2000-12-21, Close, 26.24
2000-12-21, ä¹°å…¥å•, 26.24
2000-12-22, å·²ä¹°å…¥, ä»·æ ¼: 27.02, è´¹ç”¨: 270.20, ä½£é‡‘ 0.00
2000-12-22, Close, 28.35
2000-12-26, Close, 27.52
2000-12-27, Close, 27.30
2000-12-28, Close, 27.63
2000-12-29, Close, 25.85
2000-12-29, å–å‡ºå•, 25.85
ç»„åˆæœŸæœ«èµ„é‡‘: 975.60
```

è®©æˆ‘ä»¬ä»”ç»†åœ°çœ‹ä¸€ä¸‹å‡ºç°åœ¨ä¸‹é¢æ—¥å¿—ä¸­çš„ç¬¬ä¸€æ¡è®°å½•ï¼š ä¸å†æ˜¯æ–°åƒå¹´çš„ç¬¬ä¸€ä¸ªäº¤æ˜“æ—¥2000-01-03äº†ã€‚ å˜æˆäº†2000-01-24ï¼Œæ€ä¹ˆå›äº‹å‘¢ï¼Ÿ æ˜¯å› ä¸ºï¼Œæ¡†æ¶æ ¹æ®æ–°ä»£ç åšå‡ºäº†æ”¹å˜ï¼š åœ¨ç­–ç•¥ä¸­æˆ‘ä»¬åŠ å…¥äº†ç§»åŠ¨å¹³å‡æŠ€æœ¯æŒ‡æ ‡ã€‚ ç§»åŠ¨å¹³å‡éœ€è¦æœ‰ä¸ªå‡çº¿å‘¨æœŸå‚æ•°ï¼Œç¨‹åºæ ¹æ®è¿™ä¸ªå‚æ•°å›çœ‹è®¡ç®—å‰è¾¹çš„Xæ¡ä»·æ ¼æ•°æ®ç„¶åè¿›è¡Œå¼€ä»“åˆ¤æ–­ï¼Œä¾‹å­ä¸­å‘¨æœŸæ˜¯15ã€‚ 2000-01-24å°±æ˜¯ç¬¬15å¤© backtrader æ¡†æ¶å‡å®šç­–ç•¥åŠ å…¥è¿™ä¸ªæŠ€æœ¯æŒ‡æ ‡æ˜¯æœ‰æ­£å½“ç†ç”±çš„ï¼Œæ¯”å¦‚åšå¼€å¹³ä»“çš„å†³ç­–ã€‚ æ¡†æ¶ä¸ä¼šåœ¨æ•°æ®æ²¡åˆ°ä½çš„æ—¶å€™å°±è¿›è¡Œä¸‹ä¸€æ­¥ã€‚ åœ¨æŠ€æœ¯æŒ‡æ ‡äº§ç”Ÿç¬¬ä¸€æ¡æ•°æ®ä¹‹åï¼Œnextæ–¹æ³•ç¬¬ä¸€ä¸ªè¢«è°ƒç”¨ã€‚ åœ¨ç¤ºä¾‹ä¸­åªæœ‰ä¸€ä¸ªæŠ€æœ¯æŒ‡æ ‡ï¼Œå…¶å®ç­–ç•¥æ”¯æŒæ·»åŠ å¤šä¸ªæŠ€æœ¯æŒ‡æ ‡ã€‚

ä¸€ä¸ªç›ˆåˆ©ç³»ç»Ÿè¢«æ”¹å˜ä¹‹åå¼€å§‹äºæŸäº†ï¼Œè¿˜æ˜¯åœ¨æ‰‹ç»­è´¹ç‡è®¾ç½®ä¸º0çš„æƒ…å†µä¸‹ã€‚çœ‹æ¥ç®€å•æ·»åŠ ä¸€ä¸ªæŠ€æœ¯æŒ‡æ ‡å¹¶ä¸æ˜¯ä¸‡èƒ½çš„ã€‚

> æ³¨æ„ï¼š åŒæ ·çš„äº¤æ˜“é€»è¾‘å’Œæ•°æ®ï¼Œå’Œ PyAlgoTradeè¾“å‡ºçš„ç»“æœå¹¶ä¸å®Œå…¨ä¸€è‡´ï¼Œå½“ç„¶åªæ˜¯è½»å¾®ä¸ä¸€è‡´ã€‚æœ€å¯ç–‘çš„åŸå› æ˜¯å› ä¸ºï¼šå°æ•°ç‚¹ å¤„ç† â€è°ƒæ•´åä»·æ ¼â€ï¼ˆåˆ†çº¢ã€æ‹†è‚¡åè°ƒæ•´ï¼‰æ—¶ï¼ŒPyAlgoTradeå¹¶ä¸å¯¹å°æ•°ç‚¹è¿›è¡Œå››èˆäº”å…¥ã€‚ åœ¨å¯¹ä»·æ ¼è¿›è¡Œè°ƒæ•´åï¼Œ backtraderçš„æ•°æ®å¼•æ“å°†Yahooä»·æ ¼æ•°æ®çš„ä»·æ ¼å°æ•°ç‚¹ç¼©å‡åˆ°2ä½ã€‚è™½ç„¶è¾“å‡ºçœ‹èµ·æ¥å·®ä¸å¤šï¼Œä½†ç§¯å°‘æˆå¤šç»“æœå°±ä¸åŒäº†ã€‚ å°†ä»·æ ¼å°æ•°ç‚¹ç¼©å‡åˆ° 2ä½æ˜¯åˆç†çš„ï¼Œä¸€èˆ¬äº¤æ˜“æ‰€åªå…è®¸ä»·æ ¼ä¿ç•™å°æ•°ç‚¹åé¢2ä½ã€‚


ä» 1.8.11.99 ç‰ˆæœ¬å¼€å§‹ï¼Œbacktraderçš„Yahooæ•°æ®å¼•æ“å¯ä»¥è®¾ç½®æ˜¯å¦åšå°æ•°ç‚¹ä½æ•°ä¿ç•™ï¼Œè¿˜å¯ä»¥è®¾ç½®ä¿ç•™å¤šå°‘ä½ã€‚

## 3.12 å¯è§†åŒ–:ç»˜å›¾

æ–‡å­—æ—¥å¿—è™½ç„¶èƒ½çœ‹åˆ°ç»†èŠ‚ï¼Œä½†äººä»¬è¿˜æ˜¯å–œæ¬¢çœ‹å¯è§†åŒ–çš„ä¸œè¥¿ï¼Œæ‰€ä»¥æœ‰å¿…è¦å°†ç»“æœç»˜åˆ¶æˆå›¾è¡¨ã€‚ ç»˜å›¾å¾ˆå®¹æ˜“ä½¿ç”¨ï¼Œåªéœ€æ·»åŠ ä¸€è¡Œä»£ç  :
Â Â 
cerebro.plot()

è¿™è¡Œä»£ç è¦æ”¾åœ¨ cerebro.run() ä¹‹åã€‚ ä¸ºæ–¹ä¾¿ä½¿ç”¨ï¼Œæ¡†æ¶åšäº†ä¸‹é¢è¿™äº›è‡ªåŠ¨åŒ–çš„äº‹æƒ…ï¼š å°†æ·»åŠ ç¬¬äºŒæ¡æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ï¼Œé»˜è®¤å°†ä½¿ç”¨æ•°æ®è¿›è¡Œç»˜åˆ¶Â ï¼ˆå°±åƒç¬¬1æ¡ï¼‰ã€‚ å°†æ·»åŠ ç¬¬ä¸‰æ¡åŠ æƒç§»åŠ¨å¹³å‡çº¿ï¼Œåœ¨å•ç‹¬åŒºåŸŸç»˜åˆ¶ï¼ˆä¹Ÿè®¸çœ‹èµ·æ¥ä¸åˆç†ï¼‰ã€‚ å°†æ·»åŠ ä¸€æ¡ Stochasticï¼ˆæ…¢ï¼‰ï¼Œä½¿ç”¨é»˜è®¤å‚æ•°ã€‚ å°†æ·»åŠ ä¸€æ¡MACDï¼Œä½¿ç”¨é»˜è®¤å‚æ•°ã€‚ å°†æ·»åŠ ä¸€æ¡ RSIæŒ‡æ ‡ï¼Œä½¿ç”¨é»˜è®¤å‚æ•°ã€‚ å°†æ·»åŠ ä¸€æ¡ RSIæŒ‡æ ‡çš„ç®€å•ç§»åŠ¨å¹³å‡çº¿ï¼Œä½¿ç”¨é»˜è®¤å‚æ•°ï¼ˆå°†å’ŒRSIä¸€èµ·è¢«ç»˜åˆ¶ï¼‰ã€‚ å°†æ·»åŠ ä¸€æ¡ATRæŒ‡æ ‡ï¼Œä¿®æ”¹äº†é»˜è®¤å‚æ•°ä»¥é¿å…è¢«ç»˜åˆ¶ã€‚

ä¸Šé¢æ·»åŠ çš„è¿™äº›æŒ‡æ ‡ï¼Œç­‰äºåœ¨ç­–ç•¥ç±»çš„ init æ–¹æ³•ä¸­æ·»åŠ äº†ä»¥ä¸‹è¯­å¥:

# éœ€è¦ç»˜åˆ¶çš„æŒ‡æ ‡

`bt.indicators.ExponentialMovingAverage(self.datas[0], period=25)`

`bt.indicators.WeightedMovingAverage(self.datas[0], period=25).subplot = True`

`bt.indicators.StochasticSlow(self.datas[0])`

`bt.indicators.MACDHisto(self.datas[0])`

`rsi = bt.indicators.RSI(self.datas[0])`

`bt.indicators.SmoothedMovingAverage(rsi, period=10)`

`bt.indicators.ATR(self.datas[0]).plot = False`

> æ³¨æ„ï¼š å³ä½¿æŒ‡æ ‡æ²¡æœ‰è¢«æ˜¾å¼åœ°å£°æ˜ä¸ºæˆå‘˜å˜é‡ï¼ˆå¦‚ self.sma = MovingAverageSimpleâ€¦ï¼‰ï¼Œ å®ƒä»¬è¿˜æ˜¯ä¼šè¢«è‡ªåŠ¨æ³¨å†Œåˆ°ç­–ç•¥ç±»ä¸­ï¼Œå¹¶å½±å“å¼€å§‹æ‰§è¡Œ next çš„æœ€å°å‘¨æœŸï¼Œè€Œä¸”ä¼šè¢«ç»˜åˆ¶ã€‚ åœ¨ä¾‹å­ä¸­ï¼Œåªæœ‰ RSIçš„æŒ‡æ ‡è¢«èµ‹äºˆäº†ä¸€ä¸ªrsiçš„å˜é‡ï¼Œä¾›åè¾¹ä¸ºå®ƒåˆ›å»ºç§»åŠ¨å¹³å‡çº¿ä½¿ç”¨ã€‚


ç°åœ¨ç¨‹åºå˜æˆäº†è¿™æ ·ï¼š

```python
import datetime # 
import os.path # è·¯å¾„ç®¡ç†Â Â 
import sys # è·å–å½“å‰è¿è¡Œè„šæœ¬çš„è·¯å¾„ (in argv[0]) 
#å¯¼å…¥backtraderæ¡†æ¶Â Â 
import backtrader as bt 
# åˆ›å»ºç­–ç•¥ç»§æ‰¿bt.Strategy 
class TestStrategy(bt.Strategy): 
    params = ( 
    # å‡çº¿å‚æ•°è®¾ç½®15å¤©ï¼Œ15æ—¥å‡çº¿Â Â 
    ('maperiod', 15), 
    )
    def log(self, txt, dt=None): 
        # è®°å½•ç­–ç•¥çš„æ‰§è¡Œæ—¥å¿—Â Â 
        dt = dt or self.datas[0].datetime.date(0) 
        print('%s, %s' % (dt.isoformat(), txt)) 

    def __init__(self): 
        # ä¿å­˜æ”¶ç›˜ä»·çš„å¼•ç”¨Â Â 
        self.dataclose = self.datas[0].close 
        # è·Ÿè¸ªæŒ‚å•Â Â 
        self.order = None 
        # ä¹°å…¥ä»·æ ¼å’Œæ‰‹ç»­è´¹Â Â 
        self.buyprice = None 
        self.buycomm = None 
        # åŠ å…¥å‡çº¿æŒ‡æ ‡Â Â 
        self.sma = bt.indicators.SimpleMovingAverage(self.datas[0], period=self.params.maperiod) 
        # ç»˜åˆ¶å›¾å½¢æ—¶å€™ç”¨åˆ°çš„æŒ‡æ ‡Â Â 
        bt.indicators.ExponentialMovingAverage(self.datas[0], period=25) 
        bt.indicators.WeightedMovingAverage(self.datas[0], period=25,subplot=True) 
        bt.indicators.StochasticSlow(self.datas[0]) 
        bt.indicators.MACDHisto(self.datas[0]) 
        rsi = bt.indicators.RSI(self.datas[0]) 
        bt.indicators.SmoothedMovingAverage(rsi, period=10) 
        bt.indicators.ATR(self.datas[0], plot=False) 


    # è®¢å•çŠ¶æ€é€šçŸ¥ï¼Œä¹°å…¥å–å‡ºéƒ½æ˜¯ä¸‹å•Â Â 
    def notify_order(self, order): 
        if order.status in [order.Submitted, order.Accepted]: 
            # broker æäº¤/æ¥å—äº†ï¼Œä¹°/å–è®¢å•åˆ™ä»€ä¹ˆéƒ½ä¸åšÂ Â 
            return 

        # æ£€æŸ¥ä¸€ä¸ªè®¢å•æ˜¯å¦å®ŒæˆÂ Â 
        # æ³¨æ„: å½“èµ„é‡‘ä¸è¶³æ—¶ï¼Œbrokerä¼šæ‹’ç»è®¢å•Â Â 
        if order.status in [order.Completed]: 
            if order.isbuy(): 
                self.log( 
                    'å·²ä¹°å…¥, ä»·æ ¼: %.2f, è´¹ç”¨: %.2f, ä½£é‡‘ %.2f' % 
                    (order.executed.price, 
                    order.executed.value, 
                    order.executed.comm)) 
                self.buyprice = order.executed.price 
                self.buycomm = order.executed.comm 
            elif order.issell(): 
                self.log('å·²å–å‡º, ä»·æ ¼: %.2f, è´¹ç”¨: %.2f, ä½£é‡‘ %.2f' % 
                    (order.executed.price, 
                    order.executed.value, 
                    order.executed.comm)) 
            # è®°å½•å½“å‰äº¤æ˜“æ•°é‡Â Â 
            self.bar_executed = len(self) 

        elif order.status in [order.Canceled, order.Margin, order.Rejected]: 
            self.log('è®¢å•å–æ¶ˆ/ä¿è¯é‡‘ä¸è¶³/æ‹’ç»') 

        # å…¶ä»–çŠ¶æ€è®°å½•ä¸ºï¼šæ— æŒ‚èµ·è®¢å•Â Â 
        self.order = None 
        # äº¤æ˜“çŠ¶æ€é€šçŸ¥ï¼Œä¸€ä¹°ä¸€å–ç®—äº¤æ˜“Â Â 

    def notify_trade(self, trade): 
        if not trade.isclosed: 
            return 
        self.log('äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ %.2f, å‡€åˆ©æ¶¦ %.2f' % 
        (trade.pnl, trade.pnlcomm)) 


    def next(self): 
        # è®°å½•æ”¶ç›˜ä»·Â Â 
        self.log('Close, %.2f' % self.dataclose[0]) 
        # å¦‚æœæœ‰è®¢å•æ­£åœ¨æŒ‚èµ·ï¼Œä¸æ“ä½œÂ Â 
        if self.order: 
            return 

        # å¦‚æœæ²¡æœ‰æŒä»“åˆ™ä¹°å…¥Â Â 
        if not self.position: 
            # ä»Šå¤©çš„æ”¶ç›˜ä»·åœ¨å‡çº¿ä»·æ ¼ä¹‹ä¸ŠÂ Â 
            if self.dataclose[0] > self.sma[0]: 
                # ä¹°å…¥Â Â 
                self.log('ä¹°å…¥å•, %.2f' % self.dataclose[0]) 
                # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                self.order = self.buy() 
        else: 
            # å¦‚æœå·²ç»æŒä»“ï¼Œæ”¶ç›˜ä»·åœ¨å‡çº¿ä»·æ ¼ä¹‹ä¸‹Â Â 
            if self.dataclose[0] < self.sma[0]: 
                # å…¨éƒ¨å–å‡ºÂ Â 
                self.log('å–å‡ºå•, %.2f' % self.dataclose[0]) 
                # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                self.order = self.sell()


# åˆ›å»ºCerebroå¼•æ“Â Â 
cerebro = bt.Cerebro() 
# Cerebroå¼•æ“åœ¨åå°åˆ›å»ºbroker(ç»çºªäºº)ï¼Œç³»ç»Ÿé»˜è®¤èµ„é‡‘é‡ä¸º10000 
# ä¸ºCerebroå¼•æ“æ·»åŠ ç­–ç•¥Â Â 
cerebro.addstrategy(TestStrategy) 
# è·å–å½“å‰è¿è¡Œè„šæœ¬æ‰€åœ¨ç›®å½•Â Â 
modpath = os.path.dirname(os.path.abspath(sys.argv[0])) 
# æ‹¼æ¥åŠ è½½è·¯å¾„Â Â 
datapath = os.path.join(modpath, '/home/mw/input/backtrader7822/orcl-1995-2014.txt') 
# åˆ›å»ºäº¤æ˜“æ•°æ®é›†Â Â 
data = bt.feeds.YahooFinanceCSVData( 
    dataname=datapath, 
    # æ•°æ®å¿…é¡»å¤§äºfromdate 
    fromdate=datetime.datetime(2000, 1, 1), 
    # æ•°æ®å¿…é¡»å°äºtodate 
    todate=datetime.datetime(2000, 12, 31), 
    reverse=False) 
# åŠ è½½äº¤æ˜“æ•°æ®Â Â 
cerebro.adddata(data) 
# è®¾ç½®æŠ•èµ„é‡‘é¢1000.0 
cerebro.broker.setcash(1000.0) 
# æ¯ç¬”äº¤æ˜“ä½¿ç”¨å›ºå®šäº¤æ˜“é‡Â Â 
cerebro.addsizer(bt.sizers.FixedSize, stake=10) 
# è®¾ç½®ä½£é‡‘ä¸º0.0 
cerebro.broker.setcommission(commission=0.0) 
# å¼•æ“è¿è¡Œå‰æ‰“å°æœŸå‡ºèµ„é‡‘Â Â 
print('ç»„åˆæœŸåˆèµ„é‡‘: %.2f' % cerebro.broker.getvalue()) 
cerebro.run() 
# å¼•æ“è¿è¡Œåæ‰“æœŸæœ«èµ„é‡‘Â Â 
print('ç»„åˆæœŸæœ«èµ„é‡‘: %.2f' % cerebro.broker.getvalue()) 
# ç»˜åˆ¶å›¾åƒÂ Â 
cerebro.plot()
```

```
ç»„åˆæœŸåˆèµ„é‡‘: 1000.00
2000-02-18, Close, 26.05
2000-02-22, Close, 26.38
2000-02-22, ä¹°å…¥å•, 26.38
2000-02-23, å·²ä¹°å…¥, ä»·æ ¼: 26.77, è´¹ç”¨: 267.70, ä½£é‡‘ 0.00
2000-02-23, Close, 28.05
2000-02-24, Close, 27.55
2000-02-25, Close, 31.41
2000-02-28, Close, 30.52
2000-02-29, Close, 33.02
2000-03-01, Close, 31.80
2000-03-02, Close, 30.47
2000-03-03, Close, 33.36
2000-03-06, Close, 33.69
2000-03-07, Close, 33.33
2000-03-08, Close, 36.97
2000-03-09, Close, 37.36
2000-03-10, Close, 36.30
2000-03-13, Close, 35.02
2000-03-14, Close, 34.25
2000-03-15, Close, 34.97
2000-03-16, Close, 36.44
2000-03-17, Close, 35.50
2000-03-20, Close, 34.75
2000-03-21, Close, 35.89
2000-03-22, Close, 37.39
2000-03-23, Close, 38.64
2000-03-24, Close, 38.69
2000-03-27, Close, 39.33
2000-03-28, Close, 38.50
2000-03-29, Close, 36.69
2000-03-30, Close, 34.88
2000-03-30, å–å‡ºå•, 34.88
2000-03-31, å·²å–å‡º, ä»·æ ¼: 35.66, è´¹ç”¨: 267.70, ä½£é‡‘ 0.00
2000-03-31, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 88.90, å‡€åˆ©æ¶¦ 88.90
2000-03-31, Close, 34.72
2000-04-03, Close, 34.19
2000-04-04, Close, 33.77
2000-04-05, Close, 34.80
2000-04-06, Close, 36.55
2000-04-06, ä¹°å…¥å•, 36.55
2000-04-07, å·²ä¹°å…¥, ä»·æ ¼: 37.22, è´¹ç”¨: 372.20, ä½£é‡‘ 0.00
2000-04-07, Close, 38.75
2000-04-10, Close, 36.69
2000-04-11, Close, 34.41
2000-04-11, å–å‡ºå•, 34.41
2000-04-12, å·²å–å‡º, ä»·æ ¼: 34.66, è´¹ç”¨: 372.20, ä½£é‡‘ 0.00
2000-04-12, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -25.60, å‡€åˆ©æ¶¦ -25.60
2000-04-12, Close, 32.52
2000-04-13, Close, 31.99
2000-04-14, Close, 27.80
2000-04-17, Close, 33.27
2000-04-18, Close, 35.11
2000-04-18, ä¹°å…¥å•, 35.11
2000-04-19, å·²ä¹°å…¥, ä»·æ ¼: 34.97, è´¹ç”¨: 349.70, ä½£é‡‘ 0.00
2000-04-19, Close, 33.16
2000-04-19, å–å‡ºå•, 33.16
2000-04-20, å·²å–å‡º, ä»·æ ¼: 32.83, è´¹ç”¨: 349.70, ä½£é‡‘ 0.00
2000-04-20, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -21.40, å‡€åˆ©æ¶¦ -21.40
2000-04-20, Close, 31.49
2000-04-24, Close, 32.22
2000-04-25, Close, 33.61
2000-04-26, Close, 32.11
2000-04-27, Close, 34.38
2000-04-27, ä¹°å…¥å•, 34.38
2000-04-28, å·²ä¹°å…¥, ä»·æ ¼: 34.91, è´¹ç”¨: 349.10, ä½£é‡‘ 0.00
2000-04-28, Close, 35.55
2000-05-01, Close, 35.44
2000-05-02, Close, 34.61
2000-05-03, Close, 33.72
2000-05-04, Close, 33.02
2000-05-04, å–å‡ºå•, 33.02
2000-05-05, å·²å–å‡º, ä»·æ ¼: 32.91, è´¹ç”¨: 349.10, ä½£é‡‘ 0.00
2000-05-05, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -20.00, å‡€åˆ©æ¶¦ -20.00
2000-05-05, Close, 34.16
2000-05-05, ä¹°å…¥å•, 34.16
2000-05-08, å·²ä¹°å…¥, ä»·æ ¼: 33.49, è´¹ç”¨: 334.90, ä½£é‡‘ 0.00
2000-05-08, Close, 32.16
2000-05-08, å–å‡ºå•, 32.16
2000-05-09, å·²å–å‡º, ä»·æ ¼: 32.77, è´¹ç”¨: 334.90, ä½£é‡‘ 0.00
2000-05-09, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -7.20, å‡€åˆ©æ¶¦ -7.20
2000-05-09, Close, 32.02
2000-05-10, Close, 30.08
2000-05-11, Close, 32.19
2000-05-12, Close, 32.99
2000-05-15, Close, 34.25
2000-05-15, ä¹°å…¥å•, 34.25
2000-05-16, å·²ä¹°å…¥, ä»·æ ¼: 34.52, è´¹ç”¨: 345.20, ä½£é‡‘ 0.00
2000-05-16, Close, 35.22
2000-05-17, Close, 34.77
2000-05-18, Close, 32.49
2000-05-18, å–å‡ºå•, 32.49
2000-05-19, å·²å–å‡º, ä»·æ ¼: 32.02, è´¹ç”¨: 345.20, ä½£é‡‘ 0.00
2000-05-19, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -25.00, å‡€åˆ©æ¶¦ -25.00
2000-05-19, Close, 31.16
2000-05-22, Close, 30.16
2000-05-23, Close, 27.85
2000-05-24, Close, 28.57
2000-05-25, Close, 29.55
2000-05-26, Close, 29.80
2000-05-30, Close, 32.99
2000-05-30, ä¹°å…¥å•, 32.99
2000-05-31, å·²ä¹°å…¥, ä»·æ ¼: 32.58, è´¹ç”¨: 325.80, ä½£é‡‘ 0.00
2000-05-31, Close, 31.97
2000-06-01, Close, 34.63
2000-06-02, Close, 35.66
2000-06-05, Close, 36.00
2000-06-06, Close, 34.27
2000-06-07, Close, 35.58
2000-06-08, Close, 36.64
2000-06-09, Close, 36.77
2000-06-12, Close, 35.83
2000-06-13, Close, 36.33
2000-06-14, Close, 35.13
2000-06-15, Close, 36.69
2000-06-16, Close, 36.41
2000-06-19, Close, 38.25
2000-06-20, Close, 38.27
2000-06-21, Close, 38.33
2000-06-22, Close, 36.25
2000-06-22, å–å‡ºå•, 36.25
2000-06-23, å·²å–å‡º, ä»·æ ¼: 35.94, è´¹ç”¨: 325.80, ä½£é‡‘ 0.00
2000-06-23, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 33.60, å‡€åˆ©æ¶¦ 33.60
2000-06-23, Close, 35.36
2000-06-26, Close, 36.77
2000-06-26, ä¹°å…¥å•, 36.77
2000-06-27, å·²ä¹°å…¥, ä»·æ ¼: 36.64, è´¹ç”¨: 366.40, ä½£é‡‘ 0.00
2000-06-27, Close, 36.58
2000-06-27, å–å‡ºå•, 36.58
2000-06-28, å·²å–å‡º, ä»·æ ¼: 36.50, è´¹ç”¨: 366.40, ä½£é‡‘ 0.00
2000-06-28, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -1.40, å‡€åˆ©æ¶¦ -1.40
2000-06-28, Close, 36.89
2000-06-28, ä¹°å…¥å•, 36.89
2000-06-29, å·²ä¹°å…¥, ä»·æ ¼: 36.50, è´¹ç”¨: 365.00, ä½£é‡‘ 0.00
2000-06-29, Close, 35.97
2000-06-29, å–å‡ºå•, 35.97
2000-06-30, å·²å–å‡º, ä»·æ ¼: 35.75, è´¹ç”¨: 365.00, ä½£é‡‘ 0.00
2000-06-30, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -7.50, å‡€åˆ©æ¶¦ -7.50
2000-06-30, Close, 37.39
2000-06-30, ä¹°å…¥å•, 37.39
2000-07-03, å·²ä¹°å…¥, ä»·æ ¼: 36.08, è´¹ç”¨: 360.80, ä½£é‡‘ 0.00
2000-07-03, Close, 35.66
2000-07-03, å–å‡ºå•, 35.66
2000-07-05, å·²å–å‡º, ä»·æ ¼: 34.16, è´¹ç”¨: 360.80, ä½£é‡‘ 0.00
2000-07-05, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -19.20, å‡€åˆ©æ¶¦ -19.20
2000-07-05, Close, 32.16
2000-07-06, Close, 33.63
2000-07-07, Close, 33.75
2000-07-10, Close, 32.97
2000-07-11, Close, 32.16
2000-07-12, Close, 33.22
2000-07-13, Close, 33.69
2000-07-14, Close, 33.86
2000-07-17, Close, 33.86
2000-07-18, Close, 32.99
2000-07-19, Close, 32.80
2000-07-20, Close, 34.75
2000-07-20, ä¹°å…¥å•, 34.75
2000-07-21, å·²ä¹°å…¥, ä»·æ ¼: 34.44, è´¹ç”¨: 344.40, ä½£é‡‘ 0.00
2000-07-21, Close, 33.55
2000-07-21, å–å‡ºå•, 33.55
2000-07-24, å·²å–å‡º, ä»·æ ¼: 34.30, è´¹ç”¨: 344.40, ä½£é‡‘ 0.00
2000-07-24, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -1.40, å‡€åˆ©æ¶¦ -1.40
2000-07-24, Close, 33.36
2000-07-25, Close, 33.80
2000-07-25, ä¹°å…¥å•, 33.80
2000-07-26, å·²ä¹°å…¥, ä»·æ ¼: 33.27, è´¹ç”¨: 332.70, ä½£é‡‘ 0.00
2000-07-26, Close, 34.13
2000-07-27, Close, 33.38
2000-07-27, å–å‡ºå•, 33.38
2000-07-28, å·²å–å‡º, ä»·æ ¼: 33.41, è´¹ç”¨: 332.70, ä½£é‡‘ 0.00
2000-07-28, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 1.40, å‡€åˆ©æ¶¦ 1.40
2000-07-28, Close, 32.19
2000-07-31, Close, 33.44
2000-07-31, ä¹°å…¥å•, 33.44
2000-08-01, å·²ä¹°å…¥, ä»·æ ¼: 33.44, è´¹ç”¨: 334.40, ä½£é‡‘ 0.00
2000-08-01, Close, 32.52
2000-08-01, å–å‡ºå•, 32.52
2000-08-02, å·²å–å‡º, ä»·æ ¼: 32.47, è´¹ç”¨: 334.40, ä½£é‡‘ 0.00
2000-08-02, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -9.70, å‡€åˆ©æ¶¦ -9.70
2000-08-02, Close, 32.52
2000-08-03, Close, 34.44
2000-08-03, ä¹°å…¥å•, 34.44
2000-08-04, å·²ä¹°å…¥, ä»·æ ¼: 34.83, è´¹ç”¨: 348.30, ä½£é‡‘ 0.00
2000-08-04, Close, 36.27
2000-08-07, Close, 36.41
2000-08-08, Close, 36.91
2000-08-09, Close, 36.19
2000-08-10, Close, 35.61
2000-08-11, Close, 36.08
2000-08-14, Close, 36.64
2000-08-15, Close, 36.14
2000-08-16, Close, 36.11
2000-08-17, Close, 37.33
2000-08-18, Close, 36.16
2000-08-21, Close, 37.00
2000-08-22, Close, 37.16
2000-08-23, Close, 36.86
2000-08-24, Close, 37.66
2000-08-25, Close, 37.64
2000-08-28, Close, 38.58
2000-08-29, Close, 39.03
2000-08-30, Close, 39.25
2000-08-31, Close, 40.44
2000-09-01, Close, 41.19
2000-09-05, Close, 40.50
2000-09-06, Close, 39.69
2000-09-07, Close, 40.56
2000-09-08, Close, 38.50
2000-09-08, å–å‡ºå•, 38.50
2000-09-11, å·²å–å‡º, ä»·æ ¼: 38.28, è´¹ç”¨: 348.30, ä½£é‡‘ 0.00
2000-09-11, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 34.50, å‡€åˆ©æ¶¦ 34.50
2000-09-11, Close, 37.11
2000-09-12, Close, 35.30
2000-09-13, Close, 36.39
2000-09-14, Close, 37.78
2000-09-15, Close, 34.83
2000-09-18, Close, 34.01
2000-09-19, Close, 35.27
2000-09-20, Close, 35.55
2000-09-21, Close, 35.11
2000-09-22, Close, 35.91
2000-09-25, Close, 35.02
2000-09-26, Close, 35.33
2000-09-27, Close, 35.52
2000-09-28, Close, 36.24
2000-09-28, ä¹°å…¥å•, 36.24
2000-09-29, å·²ä¹°å…¥, ä»·æ ¼: 36.18, è´¹ç”¨: 361.80, ä½£é‡‘ 0.00
2000-09-29, Close, 35.02
2000-09-29, å–å‡ºå•, 35.02
2000-10-02, å·²å–å‡º, ä»·æ ¼: 35.47, è´¹ç”¨: 361.80, ä½£é‡‘ 0.00
2000-10-02, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -7.10, å‡€åˆ©æ¶¦ -7.10
2000-10-02, Close, 35.02
2000-10-03, Close, 30.91
2000-10-04, Close, 30.30
2000-10-05, Close, 30.38
2000-10-06, Close, 30.08
2000-10-09, Close, 29.69
2000-10-10, Close, 28.74
2000-10-11, Close, 27.69
2000-10-12, Close, 28.02
2000-10-13, Close, 31.69
2000-10-16, Close, 30.74
2000-10-17, Close, 29.96
2000-10-18, Close, 29.85
2000-10-19, Close, 32.36
2000-10-19, ä¹°å…¥å•, 32.36
2000-10-20, å·²ä¹°å…¥, ä»·æ ¼: 32.13, è´¹ç”¨: 321.30, ä½£é‡‘ 0.00
2000-10-20, Close, 31.35
2000-10-23, Close, 30.30
2000-10-24, Close, 31.85
2000-10-25, Close, 30.58
2000-10-26, Close, 30.30
2000-10-27, Close, 30.41
2000-10-30, Close, 28.13
2000-10-30, å–å‡ºå•, 28.13
2000-10-31, å·²å–å‡º, ä»·æ ¼: 29.02, è´¹ç”¨: 321.30, ä½£é‡‘ 0.00
2000-10-31, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -31.10, å‡€åˆ©æ¶¦ -31.10
2000-10-31, Close, 29.35
2000-11-01, Close, 27.91
2000-11-02, Close, 26.30
2000-11-03, Close, 26.96
2000-11-06, Close, 24.85
2000-11-07, Close, 23.63
2000-11-08, Close, 22.07
2000-11-09, Close, 24.18
2000-11-10, Close, 22.63
2000-11-13, Close, 22.01
2000-11-14, Close, 25.24
2000-11-15, Close, 25.68
2000-11-16, Close, 24.35
2000-11-17, Close, 25.63
2000-11-17, ä¹°å…¥å•, 25.63
2000-11-20, å·²ä¹°å…¥, ä»·æ ¼: 21.63, è´¹ç”¨: 216.30, ä½£é‡‘ 0.00
2000-11-20, Close, 22.01
2000-11-20, å–å‡ºå•, 22.01
2000-11-21, å·²å–å‡º, ä»·æ ¼: 22.07, è´¹ç”¨: 216.30, ä½£é‡‘ 0.00
2000-11-21, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 4.40, å‡€åˆ©æ¶¦ 4.40
2000-11-21, Close, 21.24
2000-11-22, Close, 19.85
2000-11-24, Close, 21.46
2000-11-27, Close, 20.57
2000-11-28, Close, 20.15
2000-11-29, Close, 20.35
2000-11-30, Close, 23.57
2000-11-30, ä¹°å…¥å•, 23.57
2000-12-01, å·²ä¹°å…¥, ä»·æ ¼: 23.46, è´¹ç”¨: 234.60, ä½£é‡‘ 0.00
2000-12-01, Close, 23.52
2000-12-04, Close, 25.07
2000-12-05, Close, 28.02
2000-12-06, Close, 26.85
2000-12-07, Close, 25.18
2000-12-08, Close, 26.74
2000-12-11, Close, 28.41
2000-12-12, Close, 27.35
2000-12-13, Close, 25.24
2000-12-14, Close, 24.46
2000-12-14, å–å‡ºå•, 24.46
2000-12-15, å·²å–å‡º, ä»·æ ¼: 26.18, è´¹ç”¨: 234.60, ä½£é‡‘ 0.00
2000-12-15, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ 27.20, å‡€åˆ©æ¶¦ 27.20
2000-12-15, Close, 25.41
2000-12-15, ä¹°å…¥å•, 25.41
2000-12-18, å·²ä¹°å…¥, ä»·æ ¼: 26.68, è´¹ç”¨: 266.80, ä½£é‡‘ 0.00
2000-12-18, Close, 28.46
2000-12-19, Close, 27.24
2000-12-20, Close, 25.35
2000-12-20, å–å‡ºå•, 25.35
2000-12-21, å·²å–å‡º, ä»·æ ¼: 24.74, è´¹ç”¨: 266.80, ä½£é‡‘ 0.00
2000-12-21, äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ -19.40, å‡€åˆ©æ¶¦ -19.40
2000-12-21, Close, 26.24
2000-12-21, ä¹°å…¥å•, 26.24
2000-12-22, å·²ä¹°å…¥, ä»·æ ¼: 27.02, è´¹ç”¨: 270.20, ä½£é‡‘ 0.00
2000-12-22, Close, 28.35
2000-12-26, Close, 27.52
2000-12-27, Close, 27.30
2000-12-28, Close, 27.63
2000-12-29, Close, 25.85
2000-12-29, å–å‡ºå•, 25.85
ç»„åˆæœŸæœ«èµ„é‡‘: 982.30





[[<Figure size 640x480 with 8 Axes>]]
```

è™½ç„¶ç­–ç•¥é€»è¾‘æ²¡æœ‰å˜ï¼Œä½†å›æµ‹ç»“æœå´å˜äº†ã€‚è¿™æ˜¯ç”±äºbarçš„æ•°é‡å‘ç”Ÿäº†å˜åŒ–ã€‚

> æ³¨æ„ï¼š å‰é¢æåˆ°è¿‡ï¼Œæ¡†æ¶ä¼šç­‰å¾…æ‰€æœ‰æŒ‡æ ‡æ•°æ®åˆ°ä½ä¹‹åï¼Œæ‰ä¼šè¿è¡Œ nextå‡½æ•°ã€‚ åœ¨ä¸Šä¾‹ä¸­ï¼ŒMACDæ˜¯æœ€åä¸€ä¸ªæ•°æ®åˆ°ä½çš„æŒ‡æ ‡ï¼ˆå®ƒçš„3æ¡çº¿éƒ½å®Œæˆäº†è¾“å‡ºï¼‰ã€‚ æ‰€ä»¥ç¬¬ä¸€ç¬”ä¸‹å•å·²ç»ä¸æ˜¯ 2000å¹´1æœˆä»½äº†ï¼Œè€Œæ˜¯2000å¹´2æœˆä»½æœ«ã€‚


## 3.13 å‚æ•°è°ƒä¼˜

è®¸å¤šäº¤æ˜“ä¹¦ç±éƒ½ä¼šè¯´æ¯ä¸ªå¸‚åœºã€æ¯åªè‚¡ç¥¨ï¼ˆæˆ–æœŸè´§ç­‰ç­‰ï¼‰éƒ½æœ‰ä¸åŒçš„èŠ‚å¥ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰ä¸€ä¸ªå‚æ•°èƒ½é€‚åº”æ‰€æœ‰ã€‚åœ¨ä¹‹å‰çš„ä¾‹å­é‡Œï¼Œç­–ç•¥é‡Œä½¿ç”¨çš„é»˜è®¤å‚æ•°æ˜¯15ã€‚è¿™ä¸ªå‚æ•°å¯ä»¥è¢«æ›´æ¢å¹¶è¿›è¡Œæµ‹è¯•ï¼Œä»¥è¯„ä¼°ä»€ä¹ˆå€¼æ›´é€‚åˆäºå¸‚åœºã€‚

> æ³¨æ„ï¼š å¤§é‡æ–‡çŒ®è®¨è®ºäº†å…³äºä¼˜åŒ–çš„ä¼˜ç¼ºç‚¹ã€‚ä¸€èˆ¬å»ºè®®éƒ½ä¼šæŒ‡å‘åŒä¸€æ–¹å‘ï¼šä¸è¦è¿‡åº¦ä¼˜åŒ–ã€‚å¦‚æœç­–ç•¥ä¸ç†æƒ³ï¼Œè€Œåœ¨æ‹Ÿåˆä¸Šä¸‹åŠŸå¤«ï¼Œåˆ™å¯èƒ½äº§ç”Ÿä¸€ä¸ªåœ¨å›æµ‹æ•°æ®ä¸Šéå¸¸ä¼˜ç§€çš„å‚æ•°ï¼Œä½†è¿™ä¸ªå‚æ•°åœ¨å°†æ¥è¡¨ç°å¯èƒ½å¹¶ä¸å¥½ã€‚


ä¿®æ”¹äº†ä»£ç ï¼Œä»¥æµ‹è¯•ç§»åŠ¨å¹³å‡çº¿çš„æœ€ä¼˜å‘¨æœŸå‚æ•°ã€‚ä¸ºä¿æŒæ¸…æ–°ï¼Œåˆ é™¤äº†æ‰€æœ‰ä¹°å…¥ã€å–å‡ºçš„è¾“å‡ºã€‚

```python
import datetime # 
import os.path # è·¯å¾„ç®¡ç†Â Â 
import sys # è·å–å½“å‰è¿è¡Œè„šæœ¬çš„è·¯å¾„ (in argv[0]) 
#å¯¼å…¥backtraderæ¡†æ¶Â Â 
import backtrader as bt 
# åˆ›å»ºç­–ç•¥ç»§æ‰¿bt.Strategy 
class TestStrategy(bt.Strategy): 
    params = ( 
    # å‡çº¿å‚æ•°è®¾ç½®15å¤©ï¼Œ15æ—¥å‡çº¿Â Â 
    ('maperiod', 15), 
    ('printlog', False), 
    )


    def log(self, txt, dt=None, doprint=False):
        # è®°å½•ç­–ç•¥çš„æ‰§è¡Œæ—¥å¿—
        if self.params.printlog or doprint:
            dt = dt or self.datas[0].datetime.date(0)
            print('%s, %s' % (dt.isoformat(), txt))
    


    def __init__(self): 
        # ä¿å­˜æ”¶ç›˜ä»·çš„å¼•ç”¨Â Â 
        self.dataclose = self.datas[0].close 
        # è·Ÿè¸ªæŒ‚å•Â Â 
        self.order = None 
        # ä¹°å…¥ä»·æ ¼å’Œæ‰‹ç»­è´¹Â Â 
        self.buyprice = None 
        self.buycomm = None 
        # åŠ å…¥å‡çº¿æŒ‡æ ‡Â Â 
        self.sma = bt.indicators.SimpleMovingAverage(self.datas[0], period=self.params.maperiod) 
        # è®¢å•çŠ¶æ€é€šçŸ¥ï¼Œä¹°å…¥å–å‡ºéƒ½æ˜¯ä¸‹å•Â Â 


    def notify_order(self, order): 
        if order.status in [order.Submitted, order.Accepted]: 
            # broker æäº¤/æ¥å—äº†ï¼Œä¹°/å–è®¢å•åˆ™ä»€ä¹ˆéƒ½ä¸åšÂ Â 
            return 

        # æ£€æŸ¥ä¸€ä¸ªè®¢å•æ˜¯å¦å®ŒæˆÂ Â 
        # æ³¨æ„: å½“èµ„é‡‘ä¸è¶³æ—¶ï¼Œbrokerä¼šæ‹’ç»è®¢å•Â Â 
        if order.status in [order.Completed]: 
            if order.isbuy(): 
                
                self.log( 
                    'å·²ä¹°å…¥, ä»·æ ¼: %.2f, è´¹ç”¨: %.2f, ä½£é‡‘ %.2f' % 
                    (order.executed.price, 
                    order.executed.value, 
                    order.executed.comm)) 
                self.buyprice = order.executed.price 
                self.buycomm = order.executed.comm 
            elif order.issell(): 
                self.log('å·²å–å‡º, ä»·æ ¼: %.2f, è´¹ç”¨: %.2f, ä½£é‡‘ %.2f' % 
                (order.executed.price, 
                order.executed.value, 
                order.executed.comm)) 
                # è®°å½•å½“å‰äº¤æ˜“æ•°é‡Â Â 
            self.bar_executed = len(self) 
        elif order.status in [order.Canceled, order.Margin, order.Rejected]: 
            self.log('è®¢å•å–æ¶ˆ/ä¿è¯é‡‘ä¸è¶³/æ‹’ç»') 

        # å…¶ä»–çŠ¶æ€è®°å½•ä¸ºï¼šæ— æŒ‚èµ·è®¢å•Â Â 
        self.order = None 
        # äº¤æ˜“çŠ¶æ€é€šçŸ¥ï¼Œä¸€ä¹°ä¸€å–ç®—äº¤æ˜“Â Â 


    def notify_trade(self, trade): 
        if not trade.isclosed: 
            return 
        self.log('äº¤æ˜“åˆ©æ¶¦, æ¯›åˆ©æ¶¦ %.2f, å‡€åˆ©æ¶¦ %.2f' % 
            (trade.pnl, trade.pnlcomm)) 

    def next(self): 
        # è®°å½•æ”¶ç›˜ä»·Â Â 
        self.log('Close, %.2f' % self.dataclose[0]) 
        
        # å¦‚æœæœ‰è®¢å•æ­£åœ¨æŒ‚èµ·ï¼Œä¸æ“ä½œÂ Â 
        if self.order: 
            return 

        # å¦‚æœæ²¡æœ‰æŒä»“åˆ™ä¹°å…¥Â Â 
        if not self.position: 
            # ä»Šå¤©çš„æ”¶ç›˜ä»·åœ¨å‡çº¿ä»·æ ¼ä¹‹ä¸ŠÂ Â 
            if self.dataclose[0] > self.sma[0]: 
                # ä¹°å…¥Â Â 
                self.log('ä¹°å…¥å•, %.2f' % self.dataclose[0]) 
                # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                self.order = self.buy() 
        else: 
            # å¦‚æœå·²ç»æŒä»“ï¼Œæ”¶ç›˜ä»·åœ¨å‡çº¿ä»·æ ¼ä¹‹ä¸‹Â Â 
            if self.dataclose[0] < self.sma[0]: 
                # å…¨éƒ¨å–å‡ºÂ Â 
                self.log('å–å‡ºå•, %.2f' % self.dataclose[0]) 
                # è·Ÿè¸ªè®¢å•é¿å…é‡å¤Â Â 
                self.order = self.sell() 
                # æµ‹ç•¥ç»“æŸæ—¶ï¼Œå¤šç”¨äºå‚æ•°è°ƒä¼˜Â Â 

    def stop(self): 
        self.log('(å‡çº¿å‘¨æœŸ %2d)æœŸæœ«èµ„é‡‘ %.2f' % 
        (self.params.maperiod, self.broker.getvalue()), doprint=True) 



# åˆ›å»ºCerebroå¼•æ“Â Â 
cerebro = bt.Cerebro() 
# Cerebroå¼•æ“åœ¨åå°åˆ›å»ºbroker(ç»çºªäºº)ï¼Œç³»ç»Ÿé»˜è®¤èµ„é‡‘é‡ä¸º10000 
# ä¸ºCerebroå¼•æ“æ·»åŠ ç­–ç•¥, ä¼˜åŒ–ç­–ç•¥Â Â 
# ä½¿ç”¨å‚æ•°æ¥è®¾å®š10åˆ°31å¤©çš„å‡çº¿,çœ‹çœ‹å‡çº¿å‚æ•°ä¸‹é‚£ä¸ªæ”¶ç›Šæœ€å¥½Â Â 
strats = cerebro.optstrategy( TestStrategy, 
maperiod=range(10, 31)) 
# è·å–å½“å‰è¿è¡Œè„šæœ¬æ‰€åœ¨ç›®å½•Â Â 
modpath = os.path.dirname(os.path.abspath(sys.argv[0])) 
# æ‹¼æ¥åŠ è½½è·¯å¾„Â Â 
datapath = os.path.join(modpath, '/home/mw/input/backtrader7822/orcl-1995-2014.txt') 
# åˆ›å»ºäº¤æ˜“æ•°æ®é›†Â Â 
data = bt.feeds.YahooFinanceCSVData( 
    dataname=datapath, 
    # æ•°æ®å¿…é¡»å¤§äºfromdate 
    fromdate=datetime.datetime(2000, 1, 1), 
    # æ•°æ®å¿…é¡»å°äºtodate 
    todate=datetime.datetime(2000, 12, 31), 
    reverse=False) 
# åŠ è½½äº¤æ˜“æ•°æ®Â Â 
cerebro.adddata(data) 
# è®¾ç½®æŠ•èµ„é‡‘é¢1000.0 
cerebro.broker.setcash(1000.0) 
# æ¯ç¬”äº¤æ˜“ä½¿ç”¨å›ºå®šäº¤æ˜“é‡Â Â 
cerebro.addsizer(bt.sizers.FixedSize, stake=10) 
# è®¾ç½®ä½£é‡‘ä¸º0.0 
cerebro.broker.setcommission(commission=0.0) 
cerebro.run(maxcpus=1)
```

```
2000-12-29, (å‡çº¿å‘¨æœŸ 10)æœŸæœ«èµ„é‡‘ 877.50
2000-12-29, (å‡çº¿å‘¨æœŸ 11)æœŸæœ«èµ„é‡‘ 878.70
2000-12-29, (å‡çº¿å‘¨æœŸ 12)æœŸæœ«èµ„é‡‘ 839.80
2000-12-29, (å‡çº¿å‘¨æœŸ 13)æœŸæœ«èµ„é‡‘ 899.90
2000-12-29, (å‡çº¿å‘¨æœŸ 14)æœŸæœ«èµ„é‡‘ 902.50
2000-12-29, (å‡çº¿å‘¨æœŸ 15)æœŸæœ«èµ„é‡‘ 975.60
2000-12-29, (å‡çº¿å‘¨æœŸ 16)æœŸæœ«èµ„é‡‘ 961.90
2000-12-29, (å‡çº¿å‘¨æœŸ 17)æœŸæœ«èµ„é‡‘ 952.60
2000-12-29, (å‡çº¿å‘¨æœŸ 18)æœŸæœ«èµ„é‡‘ 1011.00
2000-12-29, (å‡çº¿å‘¨æœŸ 19)æœŸæœ«èµ„é‡‘ 1039.40
2000-12-29, (å‡çº¿å‘¨æœŸ 20)æœŸæœ«èµ„é‡‘ 1073.20
2000-12-29, (å‡çº¿å‘¨æœŸ 21)æœŸæœ«èµ„é‡‘ 1055.10
2000-12-29, (å‡çº¿å‘¨æœŸ 22)æœŸæœ«èµ„é‡‘ 1057.60
2000-12-29, (å‡çº¿å‘¨æœŸ 23)æœŸæœ«èµ„é‡‘ 1021.50
2000-12-29, (å‡çº¿å‘¨æœŸ 24)æœŸæœ«èµ„é‡‘ 1018.80
2000-12-29, (å‡çº¿å‘¨æœŸ 25)æœŸæœ«èµ„é‡‘ 1012.40
2000-12-29, (å‡çº¿å‘¨æœŸ 26)æœŸæœ«èµ„é‡‘ 998.30
2000-12-29, (å‡çº¿å‘¨æœŸ 27)æœŸæœ«èµ„é‡‘ 983.10
2000-12-29, (å‡çº¿å‘¨æœŸ 28)æœŸæœ«èµ„é‡‘ 976.90
2000-12-29, (å‡çº¿å‘¨æœŸ 29)æœŸæœ«èµ„é‡‘ 984.20
2000-12-29, (å‡çº¿å‘¨æœŸ 30)æœŸæœ«èµ„é‡‘ 980.80





[[<backtrader.cerebro.OptReturn at 0x7f80be02d320>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdfe96d8>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdfa2ac8>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdf5b0f0>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdf076d8>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdeb7160>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdeb15c0>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdf4e1d0>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdfd34a8>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdf3c550>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdec7c18>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdee6160>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdfc00f0>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdfbfa20>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdf79b00>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdf91da0>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdf8e3c8>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdf79f28>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdfc0160>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdf91f98>],
 [<backtrader.cerebro.OptReturn at 0x7f80bdecc940>]]
```

> æ³¨æ„ï¼šåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç§»é™¤äº†å¤šä½™çš„ç”¨æ¥ç»˜å›¾çš„æŒ‡æ ‡ï¼Œæ•°æ®å¼€å§‹å›æµ‹çš„æ—¶é—´ä»…å–å†³äºæˆ‘ä»¬æ·»åŠ çš„ç®€å•ç§»åŠ¨å¹³å‡çº¿ã€‚æ‰€ä»¥å‘¨æœŸä¸º 15çš„å›æµ‹ç»“æœå’Œä¹‹å‰çš„ç•¥æœ‰ä¸åŒã€‚


## 3.14 æ€»ç»“

ä¸Šé¢çš„æ•™ç¨‹ï¼Œæˆ‘ä»¬ä»ä¸€ä¸ªå¤´å¼€å§‹ï¼Œä¸€æ­¥æ­¥æ­å»ºäº†ä¸€ä¸ªèƒ½è¿è¡Œçš„å›æµ‹ç³»ç»Ÿï¼Œå¹¶ä¸”å…·å¤‡ç»˜åˆ¶ç»“æœå’Œä¼˜åŒ–å‚æ•°åŠŸèƒ½ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜èƒ½åšä¸€äº›æé«˜èƒœç‡çš„äº‹æƒ…ï¼š è‡ªå®šä¹‰æŒ‡æ ‡ï¼šåˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡å¾ˆå®¹æ˜“ï¼Œç»˜åˆ¶å®ƒä»¬åŒæ ·ç®€å•ï¼› ä¸‹å•æ•°é‡ï¼šèµ„é‡‘ç®¡ç†æ˜¯äº¤æ˜“æˆåŠŸçš„å…³é”®ä¹‹ä¸€ï¼› å§”æ‰˜å•ç±»å‹ï¼ˆé™ä»·å•ã€æ­¢æŸå•ã€é™ä»·æ­¢æŸå•ï¼‰ç­‰ç­‰ã€‚

# å››. ä¸€äº›æ¦‚å¿µ

## 4.1. å¼€å§‹ä¹‹å‰

æ‰€æœ‰çš„ä»£ç ç¤ºä¾‹ï¼Œéœ€è¦å¯¼å…¥ä»¥ä¸‹åº“æ‰èƒ½ä½¿ç”¨ï¼š

```python
import backtrader as bt 
import backtrader.indicators as btind 
import backtrader.feeds as btfeeds
```

> æ³¨æ„ï¼š è®¿é—®å­æ¨¡å—çš„å¦ä¸€ç§è¯­æ³•ï¼š ä»¥ btå½¢å¼å¯¼å…¥backtrader ç„¶åï¼š thefeed = bt.feeds.OneOfTheFeedsï¼ˆ...ï¼‰ theind = bt.indicators.SimpleMovingAverageï¼ˆ...ï¼‰


## 4.2. ä¼ é€’äº¤æ˜“æ•°æ®

è¯¥å¹³å°çš„åŸºç¡€å·¥ä½œéƒ½æ˜¯ç”±â€œç­–ç•¥â€å®Œæˆã€‚ å°†äº¤æ˜“æ•°æ®ä¼ é€’ç»™ç­–ç•¥ï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒæ€ä¹ˆæ¥æ”¶æ”¶æ®ã€‚ äº¤æ˜“æ•°æ®ä»¥æ•°ç»„çš„å½¢å¼ä¼ é€’ç»™ â€œç­–ç•¥â€ï¼Œå¹¶ä½œä¸ºâ€œç­–ç•¥â€çš„æˆå‘˜å˜é‡ï¼Œå¯ä»¥é€šè¿‡æ•°ç»„ä¸‹æ ‡çš„æ–¹å¼å¿«æ·è®¿é—®ã€‚ å¿«é€Ÿé¢„è§ˆä¸€ä¸‹ç­–ç•¥æ´¾ç”Ÿç±»çš„å£°æ˜å’Œæ¡†æ¶çš„è¿è¡Œ

```
class MyStrategy(bt.Strategy): 
    params = dict(period=20) 
	
   def __init__(self): 
          sma = btind.SimpleMovingAverage(self.datas[0], period=self.params.period)
   
cerebro = bt.Cerebro() 
#... 
data = btfeeds.MyFeed(...) 
cerebro.adddata(data) 
#... 
cerebro.addstrategy(MyStrategy, period=30) 
...
```

è¯·æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼šç­–ç•¥çš„æ„é€ æ–¹æ³•initä¸­å¹¶æœªæ¥æ”¶åˆ° argsæˆ–* kwargs ä»»ä½•å‚æ•°ï¼ˆä½†æ˜¯å®ƒä»¬ä»å¯ä»¥ä½¿ç”¨ï¼‰ï¼Œæˆå‘˜å˜é‡self.datasï¼Œè¯¥æˆå‘˜å˜é‡ä¸ºæ•°ç»„/åˆ—è¡¨/å¯è¿­ä»£ï¼Œè‡³å°‘è¦è¦æœ‰ä¸€æ¡è®°å½•ï¼ˆå¦åˆ™å°†å¼•å‘å¼‚å¸¸ï¼‰ã€‚å°±æ˜¯è¿™æ ·ï¼Œäº¤æ˜“æ•°æ®å·²æ·»åŠ åˆ°æ¡†æ¶ä¸­ï¼Œå¹¶ä¸”å°†æŒ‰ç…§æ·»åŠ åˆ°ç³»ç»Ÿä¸­çš„é¡ºåºæ˜¾ç¤ºåœ¨ç­–ç•¥ä¸­ã€‚

> æ³¨æ„ï¼š è¿™ç§æ–¹å¼ï¼ŒåŒæ ·é€‚ç”¨äºæ¡†æ¶æºç ä¸­çš„ç°æœ‰æŒ‡æ ‡ï¼Œæˆ–è€…ç”¨æˆ·å¼€å‘çš„è‡ªå®šä¹‰æŒ‡æ ‡ã€‚


### 4.2.1. äº¤æ˜“æ•°æ®å¿«æ·è®¿é—®

å¯ä»¥ä½¿ç”¨å…¶ä»–è‡ªåŠ¨æˆå‘˜å˜é‡ç›´æ¥è®¿é—®self.datasæ•°ç»„é¡¹ï¼š

- é€šè¿‡self.dataè®¿é—®self.datas[0]
- é€šè¿‡self.dataXè®¿é—®self.datas[X] ä¾‹å¦‚ï¼š

```
class MyStrategy(bt.Strategy): 
	params = dict(period=20) 
	
	def __init__(self): 
		sma = btind.SimpleMovingAverage(self.data, period=self.params.period) 
	...
```

### 4.2.2. çœç•¥äº¤æ˜“æ•°æ®

ä¸Šé¢çš„ç¤ºä¾‹å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ä¸ºï¼š

```
class MyStrategy(bt.Strategy): 
	params = dict(period=20) 

	def __init__(self): 
			sma = btind.SimpleMovingAverage(period=self.params.period) 
	...
```

self.dataå·²ä»SimpleMovingAverageçš„è°ƒç”¨ä¸­å®Œå…¨åˆ é™¤ï¼ŒSimpleMovingAverageé»˜è®¤é¦–ä¸ªå‚æ•°å°±æ˜¯self.dataä¹Ÿå³self.data0ï¼ˆself.data[0]ï¼‰ã€‚

### 4.2.3. ä¸€åˆ‡çš†æ˜¯æ•°æ®æº

ä¸ä»…ä»…äº¤æ˜“æ•°æ®æ˜¯æ•°æ®æºï¼Œå¯ä»¥ä¼ é€’ç»™æµ‹ç­–ç•¥ï¼Œ æŒ‡æ ‡å’Œæ“ä½œç»“æœåŒæ ·ä¹Ÿæ˜¯æ•°æ®æºã€‚Â Â 
åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼ŒSimpleMovingAverageæ¥æ”¶self.datas[0]ä½œä¸ºè¦è¿›è¡Œæ“ä½œçš„è¾“å…¥ã€‚ä¸‹é¢çœ‹ä¸€ä¸ªæ“ä½œç»“æœå’Œé¢å¤–æŒ‡æ ‡çš„ç¤ºä¾‹ï¼š

```
class MyStrategy(bt.Strategy): 
	params = dict(period1=20, period2=25, period3=10, period4) 
	
	def __init__(self): 
		sma1 = btind.SimpleMovingAverage(self.datas[0], period=self.p.period1) 
		
		# ç¬¬äºŒç§»åŠ¨å¹³å‡çº¿ä½¿ç”¨sma1ä½œä¸ºå‚æ•°ï¼Œå‡çº¿çš„å‡çº¿Â Â 
		sma2 = btind.SimpleMovingAverage(sma1, period=self.p.period2) 
		
		# é€šè¿‡ç®—æœ¯è¿ç®—åˆ›å»ºçš„æ–°æ•°æ®Â Â 
		something = sma2 - sma1 + self.data.close 
		# ç¬¬ä¸‰ç§»åŠ¨å¹³å‡çº¿ä½¿ç”¨somethingä½œä¸ºå‚æ•°Â Â 
		sma3 = btind.SimpleMovingAverage(something, period=self.p.period3) 
		
		# æ¯”è¾ƒsma3å’Œsma1... 
		greater = sma3 > sma1 
		
		# å¹¶æ²¡æœ‰å®é™…æ„ä¹‰çš„å‡å€¼Â Â 
		# ç¬¬å››ç§»åŠ¨å¹³å‡çº¿ä½¿ç”¨greateråšä¸ºå‚æ•°Â Â 
		sma3 = btind.SimpleMovingAverage(greater, period=self.p.period4) 
	...
```

åŸºæœ¬ä¸Šï¼Œæ‰€æœ‰å†…å®¹éƒ½ä¼šè½¬æ¢ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œä¸€æ—¦å¯¹å…¶è¿›è¡Œæ“ä½œï¼Œå°±å¯ä»¥ç”¨ä½œæ•°æ®æºã€‚

## 4.3. å‚æ•°

é€šå¸¸ï¼Œå¹³å°ä¸­çš„æ‰€æœ‰å…¶ä»–ç±»éƒ½æ”¯æŒå‚æ•°çš„æ¦‚å¿µã€‚ å‚æ•°å’Œé»˜è®¤å€¼ä¸€èµ·å£°æ˜ä¸ºç±»çš„å±æ€§ï¼ˆå…ƒç»„æˆ–ç±»ä¼¼å­—å…¸çš„å¯¹è±¡ï¼‰ã€‚ æ‰«æå…³é”®å­— argsï¼ˆ kwargsï¼‰ä»¥æŸ¥æ‰¾åŒ¹é…çš„å‚æ•°ï¼Œå¦‚æœæ‰¾åˆ°åˆ™å°†å®ƒä»¬ä» kwargsä¸­åˆ é™¤ï¼Œå¹¶å°†å€¼åˆ†é…ç»™ç›¸åº”çš„å‚æ•°ã€‚ é€šè¿‡è®¿é—®æˆå‘˜å˜é‡ self.paramsï¼ˆç®€å†™ä¸ºself.pï¼‰ï¼Œæœ€ç»ˆå¯ä»¥åœ¨ç±»çš„å®ä¾‹ä¸­ä½¿ç”¨å‚æ•°ã€‚ å…ˆå‰çš„ç®€æ´ç­–ç•¥å·²ç»åŒ…å«ä¸€ä¸ªå‚æ•°ç¤ºä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å†æ¬¡èšç„¦å‚æ•°çš„ä½¿ç”¨ã€‚

é€šè¿‡å…ƒç»„æ–¹å¼ï¼š

```
class MyStrategy(bt.Strategy): 
	params = (('period', 20),) 
	
	def __init__(self): 
		sma = btind.SimpleMovingAverage(self.data, period=self.p.period)
```

é€šè¿‡å­—å…¸æ–¹å¼ï¼š

```
class MyStrategy(bt.Strategy): 
	params = dict(period=20) 
	
	def __init__(self): 
		sma = btind.SimpleMovingAverage(self.data, period=self.p.period)
```

## 4.4. Linesï¼ˆçº¿ç¾¤ï¼‰

båŒæ ·ï¼Œå¹³å°ä¸­å‡ ä¹æ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ä½¿ç”¨äº†Linesï¼ˆçº¿ç¾¤ï¼‰å¯¹è±¡ã€‚ ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œè¿™æ„å‘³ç€ï¼š

- Linesï¼ˆçº¿ç¾¤ï¼‰å¯¹è±¡å¯ä»¥å®¹çº³ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ï¼Œçº¿æ˜¯ç”±ä¸€ç»„æ•°æ®ç»„æˆçš„æ•°ç»„ï¼Œè¿™ç»„å€¼åœ¨å›¾è¡¨ä¸­æ”¾åœ¨ä¸€èµ·å°±å¯ä»¥å½¢æˆä¸€æ¡çº¿ã€‚ çº¿çš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯ç”±è‚¡ç¥¨çš„æ”¶ç›˜ä»·å½¢æˆçš„çº¿ï¼Œè¿™å®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¼—æ‰€å‘¨çŸ¥çš„æ”¶ç›˜ä»·æ›²çº¿ã€‚

æ¡†æ¶ä¸­å¯¹çº¿çš„ä½¿ç”¨é€šå¸¸å°±æ˜¯è¯»å–æ“ä½œï¼Œ å‰é¢çš„å°ä¾‹å­å°‘åŠ æ”¹é€ å¦‚ä¸‹ï¼š

```
class MyStrategy(bt.Strategy): 
	params = dict(period=20) 
	
	def __init__(self): 
		self.movav = btind.SimpleMovingAverage(self.data, period=self.p.period) 
	
	def next(self): 
		if self.movav.lines.sma[0] > self.data.lines.close[0]: 
			print('ç§»åŠ¨å¹³å‡çº¿å¤§äºæ”¶ç›˜ä»·')
```

å±•ç°äº†æ‹¥æœ‰çº¿çš„ä¸¤ä¸ªå¯¹è±¡ï¼š

- self.dataå…·æœ‰ä¸€ä¸ªlineså±æ€§ï¼Œè¯¥å±æ€§åŒ…å«ä¸€ä¸ªcloseå±æ€§
- self.movavæ˜¯ä¸€ä¸ªSimpleMovingAverageæŒ‡æ ‡ï¼Œä¹Ÿå…·æœ‰ä¸€ä¸ªlineså±æ€§ï¼Œè¯¥å±æ€§åŒ…å«ä¸€ä¸ªsmaå±æ€§ closeå’Œsmaé€šè¿‡è®¿é—®(ç´¢å¼•0)æ¥æ¯”è¾ƒå€¼çš„å¤§å°

> æ³¨æ„ï¼š ç”±æ­¤å¯è§ï¼Œçº¿åªæ˜¯ä¸€ä¸ªåå­—è€Œå·²ã€‚å¯ä»¥æŒ‰ç…§å£°æ˜æ—¶çš„é¡ºåºè®¿é—®å®ƒï¼Œä½†è¿™ä»…é€‚ç”¨äºæŒ‡æ ‡å¼€å‘çš„è¿‡ç¨‹ä¸­ã€‚


ä¹Ÿå¯ä»¥é€šè¿‡å¿«æ·æ–¹å¼è®¿é—®çº¿ï¼š

- xxx.lineså¯ä»¥ç¼©çŸ­ä¸ºxxx.l
- xxx.lines.nameå¯ä»¥ç¼©å†™ä¸ºxxx.lines_name
- è¯¸å¦‚ç­–ç•¥å’ŒæŒ‡æ ‡ä¹‹ç±»çš„å¤æ‚å¯¹è±¡å¯ä»¥å¿«é€Ÿè®¿é—®çº¿æ•°æ®
- self.data_nameæ˜¯å¯¹self.data.lines.nameçš„ç›´æ¥è®¿é—®
- åŒæ ·é€‚ç”¨äºç¼–å·çš„dataå˜é‡ï¼šself.data1_name -> self.data1.lines.name

æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç›´æ¥è®¿é—®çº¿çš„å±æ€§ï¼š

- self.data.close
- self.movav.sma ä½†æ˜¯ï¼Œå®é™…å¼€å‘ä¸­ï¼Œè¿™ç§å¿«æ·è®¿é—®çš„å«ä¹‰ä¸å¦‚ä¹‹å‰çš„æ¸…æ™°ã€‚

> æ³¨æ„ï¼š ä¸æ”¯æŒä½¿ç”¨åé¢çš„ä¸¤ç§æ ‡è®°æ–¹å¼æ¥ç»™ linesèµ‹å€¼


### 4.4.1. Linesï¼ˆçº¿ç¾¤ï¼‰å£°æ˜

å¦‚æœå¼€å‘ä¸€ä¸ªæŒ‡æ ‡ï¼Œåˆ™è¯¥æŒ‡æ ‡æ‰€æ‹¥æœ‰çš„Lineså¿…é¡»è¦å£°æ˜ã€‚ å°±åƒparamsä¸€æ ·ï¼Œä½†æ˜¯åªèƒ½ä½œä¸ºå…ƒç»„ç±»å‹çš„æˆå‘˜å±æ€§ï¼Œä¸æ”¯æŒå­—å…¸ï¼Œå› ä¸ºLinesä¸æŒ‰ç…§æ’å…¥é¡ºåºå­˜å‚¨å†…å®¹ã€‚ å¯¹äºç®€å•ç§»åŠ¨å¹³å‡çº¿ï¼Œå¯ä»¥è¿™æ ·è¿›è¡Œå£°æ˜ï¼š

```
class SimpleMovingAverage(Indicator): 
	lines = ('sma',) 
	...
```

> æ³¨æ„ï¼š å¦‚æœæ‚¨å°†å•ä¸ªå­—ç¬¦ä¸²ä¼ é€’ç»™å…ƒç»„ï¼Œåˆ™åœ¨å…ƒç»„ä¸­å£°æ˜åçš„æ·»åŠ é€—å·ã€‚å¦åˆ™ï¼Œå­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—æ¯éƒ½å°†è¢«è§£é‡Šä¸ºè¦æ·»åŠ åˆ°å…ƒç»„çš„é¡¹ã€‚ è¿™å¯èƒ½æ˜¯Pythonè¯­æ³•ä¸­å°‘æ•°ä¸åˆç†çš„å‡ ä¸ªåœ°æ–¹ä¹‹ä¸€ã€‚


å¦‚ä¸Šä¾‹æ‰€ç¤ºï¼Œè¯¥å£°æ˜åœ¨æŒ‡æ ‡ä¸­åˆ›å»ºäº†ä¸€æ¡smaçº¿ï¼Œä»¥åå¯ä»¥åœ¨è¯¥ç­–ç•¥è¿›è¡Œè®¿é—®ï¼ˆå¹¶å¯èƒ½ä¼ é€’ç»™å…¶ä»–æŒ‡æ ‡æ¥åˆ›å»ºæ›´å¤æ‚çš„æŒ‡æ ‡ï¼‰ã€‚

å¯¹äºå¼€å‘è€Œè¨€ï¼Œé€šè¿‡éå‘½åçš„æ–¹å¼è®¿é—®linesä¼šå¾ˆæœ‰ç”¨ï¼Œè¿™ä¹Ÿæ˜¯ä½¿ç”¨æ•°å­—ç´¢å¼•è®¿é—®çš„æ–¹ä¾¿ä¹‹å¤„ï¼š

- self.lines[0] æŒ‡å‘ self.lines.sma

å¦‚æœå®šä¹‰äº†æ›´å¤šçš„çº¿ï¼Œå¯ä»¥å°†ä½¿ç”¨ç´¢å¼•1ã€2æˆ–è€…æ›´é«˜çš„ç´¢å¼•è¿›è¡Œè®¿é—®ã€‚å½“ç„¶ï¼Œä¹Ÿç¡®å®å­˜åœ¨å¿«æ·è®¿é—®ç‰ˆæœ¬ï¼š

- self.line æŒ‡å‘ to self.lines[0]
- self.lineX æŒ‡å‘ self.lines[X]
- self.line_X æŒ‡å‘ self.lines[X]

äº¤æ˜“æ•°æ®å¯¹è±¡ä¹Ÿå¯ä»¥é€šè¿‡æ•°å­—å¿«é€Ÿè®¿é—®å¯¹è±¡å†…éƒ¨çš„linesï¼š

- self.dataY æŒ‡å‘ self.data.lines[Y]
- self.dataX_Y æŒ‡å‘ self.dataX.lines[X] è¿™æ˜¯ self.datas[X].lines[Y] çš„ç¼©å†™ç‰ˆæœ¬ã€‚

### 4.4.2. è®¿é—®äº¤æ˜“æ•°æ®ä¸­çš„linesï¼ˆçº¿ç¾¤ï¼‰

åœ¨äº¤æ˜“æ•°æ®å†…éƒ¨ï¼Œä¹Ÿå¯ä»¥çœç•¥çš„æ–¹å¼æ¥è®¿é—®linesï¼Œæ¯”å¦‚å¯ä»¥ç”¨æ¯”è¾ƒè‡ªç„¶çš„æ–¹å¼è®¿é—®æ”¶ç›˜ä»·ï¼š

```
data = btfeeds.BacktraderCSVData(dataname='mydata.csv') 
... 
class MyStrategy(bt.Strategy): 
	... 
	def next(self): 
		if self.data.close[0] > 30.0: 
			...
```

è¿™ç§æ–¹å¼è‚¯å®šæ¯” self.data.lines.close[0] > 30.0: æ›´åŠ è‡ªç„¶äº›ã€‚ä½†æ˜¯è¿™ä¸é€‚ç”¨äºä»¥ä¸‹æŒ‡æ ‡ï¼š

- æŒ‡æ ‡åªå…·æœ‰ä¸€ä¸ªå±æ€§closeï¼Œè¯¥å±æ€§åŒ…å«ä¸€ä¸ªä¸­é—´è®¡ç®—ï¼Œè¯¥ä¸­é—´è®¡ç®—éšåçš„ç»“æœèµ‹å€¼ç»™linesä¸­çš„close å¯¹äºäº¤æ˜“æ•°æ®ï¼Œä¸ä¼šè¿›è¡Œä»»ä½•è®¡ç®—ï¼Œå› ä¸ºå®ƒåªæ˜¯ä¸€ä¸ªæ•°æ®æºã€‚

### 4.4.3. çº¿çš„é•¿åº¦

Linesæ˜¯ä¸€ç»„ç‚¹çš„é›†åˆï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šåŠ¨æ€å¢é•¿ï¼Œå› æ­¤å¯ä»¥é€šè¿‡è°ƒç”¨Pythonä¸­çš„lenå‡½æ•°éšæ—¶æµ‹é‡é•¿åº¦ã€‚ è¿™é€‚ç”¨äºï¼š

- äº¤æ˜“æ•°æ®
- ç­–ç•¥
- æŒ‡æ ‡

äº¤æ˜“æ•°æ®é¢„åŠ è½½åï¼Œdataå±æ€§ä¹Ÿå¯ä½¿ç”¨buflenæ–¹æ³•ï¼Œè¿”å›äº¤æ˜“æ•°æ®çš„æŸ±çº¿æ•°ã€‚

lenå’Œbuflenä¹‹é—´çš„åŒºåˆ«ï¼š

- lenæŠ¥å‘Šå·²å¤„ç†äº†å¤šå°‘æ¡
- buflenæŠ¥å‘Šå·²ä¸ºäº¤æ˜“æ•°æ®åŠ è½½çš„æŸ±çº¿æ€»æ•°

å¦‚æœä¸¤ä¸ªéƒ½è¿”å›ç›¸åŒçš„å€¼ï¼Œåˆ™è¦ä¹ˆæ²¡æœ‰æ•°æ®è¢«é¢„åŠ è½½ï¼Œè¦ä¹ˆå½“å‰å¤„ç†å·²æ¶ˆè€—äº†æ‰€æœ‰é¢„åŠ è½½çš„æ•°æ®ï¼ˆé™¤éç³»ç»Ÿè¿æ¥åˆ°å®æ—¶äº¤æ˜“æ•°æ®ï¼Œå¦åˆ™å°†æ„å‘³ç€å¤„ç†ç»“æŸï¼‰ã€‚

### 4.4.4. çº¿å’Œå‚æ•°çš„ç»§æ‰¿

æ¡†æ¶æä¾›äº†ä¸€ç§å…ƒè¯­è¨€æ¥æ”¯æŒå‚æ•°å’Œçº¿çš„å£°æ˜ã€‚æˆ‘ä»¬å°½é‡ä½¿å…¶ä¸Pythonçš„ç»§æ‰¿è§„åˆ™å…¼å®¹ã€‚Â Â 
å‚æ•°ç»§æ‰¿

- æ”¯æŒå¤šé‡ç»§æ‰¿
- åŸºç±»çš„å‚æ•°è¢«ç»§æ‰¿
- å¦‚æœå¤šä¸ªåŸºç±»å®šä¹‰ç›¸åŒçš„å‚æ•°ï¼Œåˆ™ä½¿ç”¨ç»§æ‰¿åˆ—è¡¨ä¸­æœ€åä¸€ä¸ªç±»çš„é»˜è®¤å€¼
- å¦‚æœåœ¨å­ç±»ä¸­é‡æ–°å®šä¹‰äº†ç›¸åŒçš„å‚æ•°ï¼Œåˆ™æ–°çš„é»˜è®¤å€¼å°†è¦†ç›–åŸºç±»çš„é»˜è®¤å€¼ã€‚

Linesç»§æ‰¿

- æ”¯æŒå¤šé‡ç»§æ‰¿
- æ‰€æœ‰åŸºç±»çš„Lineså‡è¢«ç»§æ‰¿ã€‚è¢«å‘½åä¸ºLinesçš„æƒ…å†µä¸‹ï¼Œå¦‚æœåœ¨åŸºç±»ä¸­å¤šæ¬¡ä½¿ç”¨ç›¸åŒçš„åç§°ï¼Œåˆ™Linesä¸­åªæœ‰ä¸€ä¸ªè¯¥åç§°çš„å±æ€§ã€‚

## 4.5. ç´¢å¼•0å’Œ-1

å¦‚å‰æ‰€è¿°ï¼ŒLinesæ˜¯çº¿ç¾¤ï¼Œçº¿æ˜¯ä¸€ç»„ç‚¹çš„é›†åˆï¼Œè¿™äº›ç‚¹åœ¨ç»˜åˆ¶åœ¨ä¸€èµ·å½¢æˆä¸€æ¡çº¿ï¼ˆä¾‹å¦‚ï¼Œæ²¿ç€æ—¶é—´è½´å°†æ‰€æœ‰æ”¶ç›˜ä»·è¿åœ¨ä¸€èµ·å°±å½¢æˆæ”¶ç›˜ä»·æ›²çº¿ï¼‰

è¦åœ¨å¸¸è§„ä»£ç ä¸­è®¿é—®è¿™äº›ç‚¹ï¼Œä¸€èˆ¬é€šè¿‡0ç´¢å¼•çš„æ–¹å¼å¯¹å½“å‰ç‚¹è¿›è¡Œget/setæ“ä½œã€‚ ç­–ç•¥åªèƒ½è¯»å–æ•°æ®ï¼Œ æŒ‡æ ‡æ—¢å¯ä»¥è¯»å–ä¹Ÿå¯ä»¥å†™å…¥æ•°æ®ã€‚

å›é¡¾å‰é¢ç®€å•çš„ç¤ºä¾‹ï¼Œç­–ç•¥ä¸­çš„nextæ–¹æ³•ï¼š

```
def next(self): 
	if self.movav.lines.sma[0] > self.data.lines.close[0]: print('ç®€å•ç§»åŠ¨å¹³å‡çº¿å¤§äºæ”¶ç›˜ä»·')
```

é€šè¿‡ç´¢å¼•0è·å¾—ç§»åŠ¨å¹³å‡çº¿çš„å½“å‰å€¼å’Œå½“å‰æ”¶ç›˜ä»·ï¼Œå¹¶æ¯”è¾ƒå®ƒä»¬çš„å¤§å°ã€‚Â Â 
æ³¨æ„ï¼š å®é™…ä¸Šå¯¹äºç´¢å¼• 0ï¼Œå¯ç›´æ¥è¿›è¡Œé€»è¾‘/ç®—æœ¯è¿ç®—æ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤º

æ›´å¤šç›¸å…³è¯´æ˜è¯·å‚é˜…æ–‡æ¡£åé¢çš„ã€Šæ“ä½œç« èŠ‚ã€‹ã€‚Â Â 
åœ¨æŒ‡æ ‡å¼€å‘çš„åº”ç”¨ä¸­ï¼Œä¼šå‡ºç°èµ‹å€¼æ“ä½œã€‚ ä¾‹å¦‚ SimpleMovingAverageçš„å½“å‰å€¼å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è¿›è¡Œè¯»å†™ï¼š

```
def next(self): 
	self.line[0] = math.fsum(self.data.get(0, size=self.p.period)) / self.p.period
```

è®¿é—®å‰ä¸€ä¸ªç‚¹é›†åˆå¯ä»¥æŒ‰ç…§Pythonè®¿é—®æ•°ç»„ç´¢å¼•ä¸º-1çš„æ–¹å¼ï¼š

- å®ƒæŒ‡å‘æ•°ç»„çš„æœ€åä¸€é¡¹

æ¡†æ¶è®¤ä¸ºæœ€åä¸€é¡¹ä¸ºï¼ˆè¯»å†™å½“å‰ç‚¹çš„å‰ä¸€ä¸ªç‚¹ï¼‰ç´¢å¼•å€¼ä¸º-1ã€‚ å› æ­¤ï¼Œåœ¨ç­–ç•¥ä¸­æ¯”è¾ƒå½“å‰æ”¶ç›˜ä»·ä¸å‰ä¸€ä¸ªæ”¶ç›˜ä»·æ˜¯é€šè¿‡ 0 vs -1çš„æ–¹å¼ã€‚ä¾‹å¦‚ï¼š

```
def next(self): 
	if self.data.close[0] > self.data.close[-1]: 
		print('ä»Šå¤©æ”¶ç›˜ä»·æ›´é«˜')
```

åŒç†ï¼Œä½¿ç”¨-1ï¼Œ-2ï¼Œ-3ï¼Œ...ä¾¿è®¿é—®-1ä¹‹å‰é¡¹çš„ä»·æ ¼ã€‚

## 4.6. åˆ‡ç‰‡

backtraderä¸æ”¯æŒå¯¹çº¿å¯¹è±¡è¿›è¡Œåˆ‡ç‰‡ï¼Œè¿™æ˜¯éµå¾ª[0]å’Œ[-1]ç´¢å¼•æ–¹æ¡ˆçš„è®¾è®¡å†³ç­–ã€‚ ä½¿ç”¨å¸¸è§„çš„å¯ç´¢å¼• Pythonå¯¹è±¡ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

```
# ä»å¼€å§‹åˆ°ç»“å°¾çš„åˆ‡ç‰‡Â Â 
myslice = self.my_sma[0:]
```

ä½†æ˜¯è¯·è®°ä½ï¼Œé€‰æ‹©0â€¦å®é™…ä¸Šæ˜¯å½“å‰å¼€å§‹ä¼ é€’çš„å€¼ï¼Œä¹‹åä¹Ÿæ²¡æœ‰ä»»ä½•å€¼ã€‚

```
# ä»å¼€å§‹åˆ°ç»“å°¾çš„åˆ‡ç‰‡Â Â 
myslice = self.my_sma[0:-1]
```

åŒæ ·ï¼Œâ€¦0æ˜¯å½“å‰å€¼ï¼Œè€Œ-1æ˜¯å…ˆå‰äº¤ä»˜çš„å€¼ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä» 0->-1è¿›è¡Œçš„åˆ‡ç‰‡åå‘æ“ä½œå°±æ¯«æ— æ„ä¹‰çš„åŸå› ã€‚å¦‚æœå¯ä»¥åå‘æ“ä½œï¼Œé‚£ä¹ˆåˆ‡ç‰‡å¯èƒ½åº”è¯¥è¿™æ ·ï¼š

```
# ä»å½“å‰ç‚¹å‘å‰çš„åˆ‡ç‰‡Â Â 
myslice = self.my_sma[:0] 
# ä»æœ€åçš„å€¼åˆ°å½“å‰å€¼Â Â 
myslice = self.my_sma[-1:0] 
# ä»æœ€åçš„å€¼åˆ°å€’æ•°ç¬¬3ä¸ªå€¼
```

### 4.6.1. è·å–åˆ‡ç‰‡

å¯ä»¥è·å¾—å…·æœ‰æœ€æ–°å€¼çš„æ•°ç»„ï¼Œè¯­æ³•ï¼š

```
# æ˜¾ç¤ºé»˜è®¤å€¼Â Â 
myslice = self.my_sma.get(ago=0, size=1)
```

è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œè¯¥æ•°ç»„çš„å¤§å°ä¸º1ï¼Œå½“å‰æ—¶åˆ»ä¸º0ï¼Œå‘åè·å–ã€‚Â Â 
è¦ä»å½“å‰æ—¶é—´ç‚¹è·å–10ä¸ªå€¼ï¼ˆå³ï¼šæœ€å10ä¸ªå€¼ï¼‰ï¼š

```
# agoçš„é»˜è®¤å€¼ä¸º0 
myslice = self.my_sma.get(size=10)
```

å¸¸è§„æ•°ç»„å…·æœ‰ä½ æ‰€æœŸæœ›çš„é¡ºåºã€‚æœ€å·¦è¾¹çš„å€¼æ˜¯æœ€æ—§çš„å€¼ï¼Œæœ€å³è¾¹çš„å€¼æ˜¯æœ€æ–°çš„å€¼ï¼ˆè¿™æ˜¯å¸¸è§„çš„pythonæ•°ç»„ï¼Œè€Œä¸æ˜¯lineså¯¹è±¡ï¼‰ã€‚

```
# è·³è¿‡å½“å‰ç‚¹è·å–æœ€å10ä¸ªå€¼Â Â 
myslice = self.my_sma.get(ago=-1, size=10)
```

## 4.7. çº¿çš„å»¶è¿Ÿç´¢å¼•

[]è¿ç®—ç¬¦å¯ç”¨äºåœ¨nexté€»è¾‘é˜¶æ®µæå–å•ä¸ªå€¼ã€‚lineså¯¹è±¡æ”¯æŒé™„åŠ çš„ç¬¦å·ï¼Œä»¥ä¾¿åœ¨**init**é˜¶æ®µé€šè¿‡å»¶è¿Ÿçš„çº¿å¯¹è±¡å¯»å€å–å€¼ã€‚Â Â 
å‡è®¾ä¸€æ¡é€»è¾‘æ˜¯å°†å…ˆå‰çš„æ”¶ç›˜ä»·ä¸ç®€å•ç§»åŠ¨å¹³å‡çº¿çš„å®é™…å€¼è¿›è¡Œæ¯”è¾ƒã€‚æ— éœ€åœ¨æ¯æ¬¡nextè¿­ä»£ä¸­è¿›è¡Œæ‰‹åŠ¨æ“ä½œï¼Œè€Œæ˜¯å¯ä»¥ç”Ÿæˆé¢„å®šä¹‰çš„lineså¯¹è±¡ï¼š

```
class MyStrategy(bt.Strategy): 
	params = dict(period=20) 
	
	def __init__(self): 
		self.movav = btind.SimpleMovingAverage(self.data, period=self.p.period) 
		self.cmpval = self.data.close(-1) > self.sma 
	def next(self): 
		if self.cmpval[0]: 
			print('ä¸Šä¸€ä¸ªæ”¶ç›˜ä»·é«˜äºå½“å‰ç§»åŠ¨å¹³å‡å€¼')
```

è¿™é‡Œä½¿ç”¨"()"å»¶è¿Ÿç¬¦å·ï¼š

- è¿™æä¾›äº†æ”¶ç›˜ä»·çš„å‰¯æœ¬ï¼Œä½†å»¶è¿Ÿäº†-1ã€‚
- æ¯”è¾ƒself.data.closeï¼ˆ-1ï¼‰> self.sma ä¼šç”Ÿæˆå¦ä¸€ä¸ªlineå¯¹è±¡ï¼Œå¦‚æœæ¡ä»¶ä¸ºTrueï¼Œåˆ™è¿”å›1ï¼Œå¦åˆ™ä¸º0

## 4.8. çº¿(ç¾¤)çš„è€¦åˆ

è¿ç®—ç¬¦()å¯ä»¥ä¸å»¶è¿Ÿçš„æ•°å€¼ä¸€èµ·ä½¿ç”¨ï¼Œä»¥æä¾›å»¶è¿Ÿçš„lineå¯¹è±¡ã€‚Â Â 
å¦‚æœä½¿ç”¨ä¸­ä¸æä¾›å»¶è¿Ÿæ•°å€¼ï¼Œåˆ™è¿”å›LinesCouplerå¯¹è±¡ã€‚è¿™æ˜¯ä¸ºäº†åœ¨æ“ä½œå…·æœ‰ä¸åŒæ—¶é—´èŒƒå›´çš„æ•°æ®æŒ‡æ ‡ä¹‹é—´å»ºç«‹è€¦åˆã€‚Â Â 
ä¸åŒæ—¶é—´èŒƒå›´çš„äº¤æ˜“æ•°æ®å…·æœ‰ä¸åŒçš„é•¿åº¦ï¼Œå¹¶ä¸”æŒ‡æ ‡åœ¨æ“ä½œè¿™äº›æ•°æ®æ—¶ä¼šå¤åˆ¶æ•°æ®çš„é•¿åº¦ã€‚ä¾‹å¦‚ï¼š

- æ—¥äº¤æ˜“æ•°æ®æ¯å¹´çº¦æœ‰250æ¡
- å‘¨äº¤æ˜“æ•°æ®æ¯å¹´æœ‰52æ¡

å°è¯•åˆ›å»ºä¸€ä¸ªæ¯”è¾ƒä¸¤ä¸ªç®€å•ç§»åŠ¨å¹³å‡çº¿çš„æ“ä½œï¼Œæ¯æ¬¡æ“ä½œåœ¨å¼•ç”¨æ•°æ®æ—¶éƒ½æœ‰å¯èƒ½è¢«ä¸­æ–­ã€‚å› ä¸ºç³»ç»Ÿä¸çŸ¥é“å¦‚ä½•åœ¨250æ¡çš„æ—¥äº¤æ˜“æ•°æ®å’Œ52æ¡çš„å‘¨äº¤æ˜“æ•°æ®ä¹‹é—´è¿›è¡ŒåŒ¹é…ã€‚

è¯»è€…å¯ä»¥é€šè¿‡æ‰¾å‡ºä¸€å¤©å’Œä¸€å‘¨çš„å¯¹åº”å…³ç³»è¿›è¡Œæ¯”è¾ƒï¼Œä½†æ˜¯ï¼š

- æŒ‡æ ‡åªæ˜¯æ•°å­¦å…¬å¼ï¼Œæ²¡æœ‰æ—¥æœŸæ—¶é—´ä¿¡æ¯ä»–ä»¬å¯¹ä¸Šä¸‹æ–‡ç¯å¢ƒä¸€æ— æ‰€çŸ¥ï¼Œåªè¦æä¾›äº†è¶³å¤Ÿçš„æ•°æ®ï¼Œå°±å¯ä»¥è¿›è¡Œè®¡ç®—ã€‚

äºæ˜¯()è¡¨ç¤ºæ³•ï¼ˆç©ºè°ƒç”¨ï¼‰å¯ç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```
class MyStrategy(bt.Strategy): 
	params = dict(period=20) 
	def __init__(self): 
	
		# data0 æ˜¯æ—¥äº¤æ˜“æ•°æ®Â Â 
		sma0 = btind.SMA(self.data0, period=15) # 15å¤©sma 
		# data1 æ˜¯å‘¨è¦ä»¥æ•°æ®Â Â 
		sma1 = btind.SMA(self.data1, period=5) # 5å‘¨sma 

		self.buysig = sma0 > sma1() 
		
	def next(self): 
		if self.buysig[0]: 
			print('æ¯æ—¥smaå¤§äºæ¯å‘¨sma1')
```

åœ¨è¿™é‡Œï¼Œè¾ƒå¤§çš„æ—¶é—´èŒƒå›´æŒ‡æ ‡sma1é€šè¿‡sma1()ä¸æ¯æ—¥æ—¶é—´èŒƒå›´è€¦åˆã€‚è¿™å°†è¿”å›ä¸æ›´å¤§æ•°é‡çš„sma0å…¼å®¹çš„å¯¹è±¡ï¼Œå¹¶å¤åˆ¶sma1äº§ç”Ÿçš„å€¼ï¼Œä»è€Œæœ‰æ•ˆåœ°å°†52ä¸ªå‘¨æ•°æ®åˆ†æ•£ä¸º250ä¸ªæ—¥æ•°æ®ã€‚

## 4.9. é€šè¿‡æ“ä½œç¬¦æ„é€ å¯¹è±¡

ä¸ºäº†å®ç°â€œç®€å•æ˜“ç”¨â€çš„ç›®æ ‡ï¼Œbacktraderå…è®¸ï¼ˆåœ¨Pythonçš„è¯­æ³•èŒƒå›´å†…ï¼‰ä½¿ç”¨æ“ä½œç¬¦ã€‚ä¸ºäº†è¿›ä¸€æ­¥ç®€å•åŒ–ï¼Œæ“ä½œç¬¦çš„ä½¿ç”¨æœ‰ä¸¤ç§æƒ…æ™¯ã€‚

### 4.9.1. æƒ…æ™¯1-æ“ä½œç¬¦åˆ›å»ºå¯¹è±¡

æˆ‘ä»¬ä¹‹å‰å·²ç»çœ‹åˆ°äº†ä¸€ä¸ªä¾‹å­ã€‚åœ¨æŒ‡æ ‡å’Œç­–ç•¥ç±»çš„å¯¹è±¡åˆå§‹åŒ–é˜¶æ®µï¼ˆ** init**æ–¹æ³•ï¼‰ä¸­ï¼Œæ“ä½œç¬¦åˆ›å»ºå¹¶ä¿å­˜å¯ä»¥æŒç»­ä½¿ç”¨çš„å¯¹è±¡ï¼Œä¾›ç­–ç•¥é€»è¾‘åœ¨è¯„ä¼°é˜¶æ®µä½¿ç”¨ã€‚Â 
å°†SimpleMovingAverageçš„æ½œåœ¨å®ç°æ–¹å¼è¿›ä¸€æ­¥ç»†åˆ†ä¸ºå¤šä¸ªæ­¥éª¤ã€‚Â Â 
SimpleMovingAverageæŒ‡æ ‡**init**å†…çš„ä»£ç å¯èƒ½å¦‚ä¸‹ï¼š

```
def __ init__(self): 
	# Nä¸ªå‘¨æœŸå€¼çš„æ€»å’Œï¼Œæ•°æ®æ€»å’Œæ˜¯ä¸€ä¸ªLineså¯¹è±¡Â Â 
	# åœ¨ä¸è¿ç®—ç¬¦[]å’Œç´¢å¼•0æŸ¥è¯¢æ—¶Â Â 
	# è¿”å›å½“å‰æ€»å’ŒÂ Â 
	datasum = btind.SumN(self.data, period=self.params.period) 
	# datasumï¼ˆè™½ç„¶æ˜¯å•è¡Œï¼Œä½†ä»æ˜¯ä¸€ä¸ªLineså¯¹è±¡ï¼‰Â Â 
	# åœ¨è¿™ç§æƒ…å†µä¸‹å®ƒå¯ä»¥é™¤ä»¥int/floatç±»å‹çš„æ•°æ®ã€‚Â Â 
	# ä½†å®é™…ä¸Šå®ƒè¢«é™¤ä»¥åå¾—åˆ°å¦å¤–ä¸€ä¸ªLineså¯¹è±¡ã€‚Â Â 
	# è¯¥æ“ä½œè¿”å›åˆ†é…ç»™avå¯¹è±¡Â Â 
	# å½“æŸ¥è¯¢ä¸º[0]ï¼Œåˆ™è¿”å›å½“å‰æ—¶é—´ç‚¹çš„å¹³å‡å€¼Â Â 
	av = datasum / self.params.period 
	# avæ˜¯å¯¹æ–°çš„Lineså¯¹è±¡çš„å‘½åÂ Â 
	# å…¶ä»–å¯¹è±¡ä½¿ç”¨è¿™ä¸ªæŒ‡æ ‡å¯ä»¥ç›´æ¥è®¿é—®è®¡ç®—Â Â 
	self.line.sma = av
```

ç­–ç•¥åˆå§‹åŒ–æœŸé—´æ˜¾ç¤ºäº†æ›´åŠ å®Œæ•´çš„ç”¨æ³•ï¼š

```
class MyStrategy(bt.Strategy): 
	def __init__(self): 
		sma = btind.SimpleMovinAverage(self.data, period=20) 
		close_over_sma = self.data.close > sma 
		sma_dist_to_high = self.data.high - sma 
		sma_dist_small = sma_dist_to_high < 3.5 
		# ä¸å¹¸çš„æ˜¯ï¼Œ"and"ä¸èƒ½åœ¨Pythonä¸­è¢«é‡è½½Â Â 
		# åœ¨pythonä¸­andä¸å±äºè¿ç®—ç¬¦ï¼Œæ‰€ä»¥backtraderæä¾›ä¸€ä¸ªå‡½æ•°æ¨¡æ‹Ÿè¿™ä¸ªåŠŸèƒ½Â Â 
		sell_sig = bt.And(close_over_sma, sma_dist_small)
```

å®Œæˆä¸Šè¿°æ“ä½œåï¼Œsell_sigæ˜¯ä¸€ä¸ªLineså¯¹è±¡ï¼Œå½“æŒ‡ç¤ºæ»¡è¶³æ¡ä»¶æ—¶ï¼Œå¯ä»¥ç›´æ¥åœ¨ç­–ç•¥ä¸­ä½¿ç”¨ã€‚

### 4.9.2. æƒ…æ™¯2-é€»è¾‘æ“ä½œç¬¦

é¦–å…ˆï¼Œç­–ç•¥çš„nextæ–¹æ³•ï¼Œç³»ç»Ÿè¦å¤„ç†æ¯ä¸ªæŸ±æ—¶éƒ½è¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè¿™å°±æ˜¯æ“ä½œç¬¦å¤„äºæƒ…æ™¯2åœ°æ–¹ã€‚ä»¥å‰é¢çš„ç¤ºä¾‹ä¸ºåŸºç¡€ï¼š

```
class MyStrategy(bt.Strategy): 
	def __init__(self): 
		sma = btind.SimpleMovinAverage(self.data, period=20) 
		close_over_sma = self.data.close > sma 
		sma_dist_to_high = self.data.high - sma 
		sma_dist_small = sma_dist_to_high < 3.5 
		
		# ä¸å¹¸çš„æ˜¯ï¼Œ"and"ä¸èƒ½åœ¨Pythonä¸­è¢«é‡è½½Â Â 
		# åœ¨pythonä¸­andä¸å±äºè¿ç®—ç¬¦ï¼Œæ‰€ä»¥backtraderæä¾›ä¸€ä¸ªå‡½æ•°æ¨¡æ‹Ÿè¿™ä¸ªåŠŸèƒ½Â Â 
		sell_sig = bt.And(close_over_sma, sma_dist_small) 
	
	def next(self): 
		# å°½ç®¡è¿™çœ‹èµ·æ¥ä¸åƒæ˜¯â€œæ“ä½œå·â€ï¼Œä½†ç¡®å®è¿”å›çš„æ˜¯æ­£åœ¨æµ‹è¯•å¯¹è±¡çš„True/False 
		if self.sma > 30.0: 
			print('smaå¤§äº30.0') 
		if self.sma > self.data.close: 
			print('smaé«˜äºæ”¶ç›˜ä»·') 
		if self.sell_sig: # if sell_sig == True: would also be valid 
			print('å–å‡ºæ ‡å¿—ä¸ºTrue') 
		else: 
			print('å–å‡ºæ ‡å¿—ä¸ºFalse') 
		if self.sma_dist_to_high > 5.0: 
			print('smaåˆ°highçš„è·ç¦»å¤§äº5.0')
```

è¿™ä¸æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„ç­–ç•¥ï¼Œåªæ˜¯ä¸€ä¸ªä¾‹å­ã€‚åœ¨æƒ…æ™¯2ä¸­ï¼Œæ“ä½œç¬¦è¿”å›æœŸæœ›å€¼ï¼ˆå¦‚æœæµ‹è¯•å€¼ä¸ºTrueï¼Œåˆ™è¿”å›å¸ƒå°”å€¼ï¼›å¦‚æœæ˜¯æµ®ç‚¹æ•°è¿›è¡Œæ¯”è¾ƒï¼Œåˆ™Â Â 
è¿”å›æµ®ç‚¹æ•°ï¼‰ï¼Œå¹¶ä¸”ç®—æœ¯è¿ç®—ä¹Ÿè¿”å›æœŸæœ›å€¼ã€‚

> æ³¨æ„ï¼šÂ Â 
ä¸ºäº†è¿›ä¸€æ­¥ç®€åŒ–ï¼Œæ¯”è¾ƒå®é™…ä¸Šæ²¡æœ‰ä½¿ç”¨æ“åšç¬¦ã€‚


```
if self.sma > 30.0: â€¦æ¯”è¾ƒ self.sma[0] å’Œ 30.0 
if self.sma > self.data.close: â€¦ æ¯”è¾ƒ self.sma[0] å’Œ self.data.close[0]
```

### 4.9.3. ä¸€äº›ä¸å¯é‡è½½çš„è¿ç®—ç¬¦/å‡½æ•°

Pythonä¸å…è®¸é‡è½½æ‰€æœ‰å†…å®¹ï¼Œå› æ­¤æä¾›äº†ä¸€äº›åŠŸèƒ½å‡½æ•°æ¥åº”å¯¹è¿™ç§æƒ…å†µã€‚Â Â 
æ³¨æ„ï¼šä»…é€‚ç”¨äºæƒ…æ™¯1ï¼Œä»¥åˆ›å»ºå¯¹è±¡ä¾›åé¢ä½¿ç”¨ã€‚

æ“ä½œç¬¦:

- and -> And
- or -> Or

é€»è¾‘æ§åˆ¶:

- if -> If

å‡½æ•°:

- any -> Any
- all -> All
- cmp -> Cmp
- max -> Max
- min -> Min
- sum -> Sum
- reduce -> Reduce

Sumå®é™…ä¸Šä½¿ç”¨math.fsumä½œä¸ºåº•å±‚æ“ä½œï¼Œå› ä¸ºbacktraderä½¿ç”¨æµ®ç‚¹æ•°è®¡ç®—ï¼Œå¦‚æœç”¨å¸¸è§„sumå¯èƒ½ä¼šå½±å“ç²¾åº¦ã€‚Â Â 
è¿™äº›å®ç”¨çš„æ“ä½œç¬¦/å‡½æ•°å¯è¿­ä»£ä½¿ç”¨ã€‚å¯è¿­ä»£çš„å…ƒç´ å¯ä»¥æ˜¯å¸¸è§„çš„Pythonæ•°å­—ç±»å‹ï¼ˆintï¼Œfloatç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯å¸¦æœ‰Linesçš„å¯¹è±¡ã€‚ ä¾‹å¦‚ä¸€ä¸ªéå¸¸åŸÂ Â 
å§‹çš„ä¹°å…¥ä¿¡å·ï¼š

```
class MyStrategy(bt.Strategy): 
	def __init__(self): 
		sma1 = btind.SMA(self.data.close, period=15) 
		self.buysig = bt.And(sma1 > self.data.close, sma1 > self.data.high) 
		
	def next(self): 
		if self.buysig[0]: 
			pass # do something here
```

ä¾‹å¦‚sma1é«˜äºæœ€é«˜ä»·ï¼Œåˆ™å¿…é«˜äºæ”¶ç›˜ä»·ï¼Œè¿™é‡Œé‡ç‚¹æ˜¯è¯´æ˜bt.Andçš„ç”¨æ³•ã€‚Â Â 
bt.Ifç”¨æ³•ï¼š

```
class MyStrategy(bt.Strategy): 
	def __init__(self): 
		# åœ¨period=15çš„data.closeä¸Šç”ŸæˆSMA 
		sma1 = btind.SMA(self.data.close, period=15) 
		# å¦‚æœsmaçš„å€¼å¤§äºcloseï¼Œåˆ™è¿”å›lowï¼Œå¦åˆ™è¿”å›high 
		high_or_low = bt.If(sma1 > self.data.close, self.data.low, self.data.high) 
		sma2 = btind.SMA(high_or_low, period=15)
```

è§£é‡Šè¯´æ˜ï¼š

- åœ¨period=15çš„data.closeä¸Šç”Ÿæˆsma1
- å¦‚æœsma1çš„å€¼å¤§äºcloseï¼Œåˆ™è¿”å›lowï¼Œå¦åˆ™è¿”å›high
- è°ƒç”¨bt.Ifæ—¶ä¸ä¼šè¿”å›ä»»ä½•å®é™…å€¼ã€‚å®ƒè¿”å›ä¸€ä¸ªLineså¯¹è±¡ï¼Œå°±åƒSimpleMovingAverageä¸€æ ·ï¼Œè¿™äº›å€¼å°†åœ¨ç¨åè®¡ç®—ä¸­ä¼šç”¨åˆ°
- ç„¶åå°†bt.Ifç”Ÿæˆçš„Lineså¯¹è±¡èµ‹å€¼ç»™sma2è¯¥,sma2æœ‰æ—¶ä¼šä½¿ç”¨æœ€ä½ä»·ï¼Œæœ‰æ—¶ä¼šä½¿ç”¨é«˜ä»·è¿›è¡Œè®¡ç®—Â Â 
è¿™äº›å‡½æ•°ä¹Ÿå¯ä»¥ä½¿ç”¨æ•°å€¼ï¼Œä¿®æ”¹åå¾—åˆ°ç¤ºä¾‹ï¼š

```
class MyStrategy(bt.Strategy): 
	def __init__(self): 
		sma1 = btind.SMA(self.data.close, period=15) 
		high_or_30 = bt.If(sma1 > self.data.close, 30.0, self.data.high) 
		sma2 = btind.SMA(high_or_30, period=15)
```

ç°åœ¨ï¼Œsma2ä½¿ç”¨30.0æˆ–æœ€é«˜ä»·è¿›è¡Œè®¡ç®—ï¼Œå…·ä½“å–å†³äºsma1å’Œcloseçš„æ¯”è¾ƒç»“æœã€‚

> æ³¨æ„ï¼šæ•°å€¼30åœ¨å†…éƒ¨è½¬æ¢ä¸ºä¼ªè¿­ä»£ï¼Œå§‹ç»ˆè¿”å›30


# 5. Cerebro(æ ¸å¿ƒå¼•æ“)

## 5.1. Cerebro

Cerebroç±»æ˜¯backtraderçš„å¼•æ“ï¼Œæ˜¯ä»¥ä¸‹å‡ ä¸ªæ–¹é¢çš„æ ¸å¿ƒï¼š

- æ”¶é›†æ‰€æœ‰è¾“å…¥ï¼ˆData Feedsï¼‰ï¼Œæ‰§è¡Œï¼ˆStratgegiesï¼‰ï¼Œç›‘æ§ï¼ˆObserversï¼‰ï¼Œè¯„æµ‹ï¼ˆAnalyzersï¼‰å’Œè®°å½•ï¼ˆWritersï¼‰ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿéšæ—¶è¿è¡Œã€‚
- æ‰§è¡Œå›æµ‹æˆ–å®ç›˜äº¤æ˜“
- è¿”å›ç»“æœ
- ç»˜å›¾

### 5.1.1. æ”¶é›†è¾“å…¥æ•°æ®

1.ä»¥åˆ›å»ºcerebroå¼€å§‹:

```
# **kwargså‚æ•°æ”¯æŒæŸäº›æ§åˆ¶æ‰§è¡Œï¼Œè¯·å‚é˜…åé¢æ–‡æ¡£ï¼ˆç›¸åŒçš„å‚æ•°ä¹Ÿåº”ç”¨äºrunæ–¹æ³•ï¼‰Â Â 
cerebro = bt.Cerebro(**kwargs)
```

2.æ·»åŠ äº¤æ˜“æ•°æ®Â Â 
æœ€å¸¸è§çš„æ¨¡å¼æ˜¯ cerebro.adddataï¼ˆdataï¼‰ï¼Œå…¶ä¸­dataæ˜¯å·²å®ä¾‹åŒ–çš„æ•°æ®æºã€‚ä¾‹ï¼š

```
data = bt.BacktraderCSVData(dataname='mypath.days', timeframe=bt.TimeFrame.Days) 
cerebro.adddata(data)
```

é‡æ–°é‡‡æ ·æˆ–æ•°æ®é‡æ’­éµå¾ªç›¸åŒçš„æ¨¡å¼ï¼š

```
data = bt.BacktraderCSVData(dataname='mypath.min', timeframe=bt.TimeFrame.Minutes) 
cerebro.resampledata(data, timeframe=bt.TimeFrame.Days) 
# æˆ–è€…Â Â 
data = bt.BacktraderCSVData(dataname='mypath.min', timeframe=bt.TimeFrame.Minutes) 
cerebro.replaydatadata(data, timeframe=bt.TimeFrame.Days)
```

ç³»ç»Ÿå¯ä»¥æ¥å—ä»»ä½•æ•°é‡çš„äº¤æ˜“æ•°æ®ï¼ŒåŒ…æ‹¬å°†å¸¸è§„æ•°æ®ä¸é‡é‡‡æ ·å’Œ/æˆ–é‡æ’­çš„æ•°æ®æ··åˆã€‚å½“ç„¶ï¼Œè¿™äº›ç»„åˆä¸­çš„æŸäº›ç»„åˆè‚¯å®šä¼šæ¯«æ— æ„ä¹‰ï¼Œå¹¶ä¸”ä¸ºäº†ç»„åˆæ•°æ®æœ‰æ„ä¹‰å¢åŠ äº†é™åˆ¶æ¡ä»¶ï¼šæ ¹æ®æ—¶é—´æ¡ä»¶é™åˆ¶ã€‚è¯·å‚é˜…æ•°æ®ç« èŠ‚çš„å¤šä¸ªæ—¶é—´èŒƒå›´ã€æ•°æ®é‡é‡‡æ ·å’Œæ•°æ®é‡æ’­éƒ¨åˆ†ã€‚

3.æ·»åŠ ç­–ç•¥Â Â 
ä¸äº¤æ˜“æ•°æ®ä¸åŒçš„æ˜¯äº¤æ˜“æ•°æ®å·²ç»æ˜¯ç±»çš„å®ä¾‹ï¼Œè€Œcerebroæ˜¯ç›´æ¥ä½¿ç”¨ç­–ç•¥ç±»å’Œå‚æ•°ã€‚å› ä¸ºï¼šåœ¨ç­–ç•¥ä¼˜åŒ–æ–¹æ¡ˆä¸­ï¼Œè¯¥ç±»å°†è¢«å®ä¾‹åŒ–å¤šæ¬¡å¹¶ä¼ é€’ä¸åŒçš„å‚æ•°ã€‚Â Â 
å³ä½¿æ²¡æœ‰è¿è¡Œç­–ç•¥ä¼˜åŒ–æ–¹æ¡ˆï¼Œè¯¥æ¨¡å¼ä»ç„¶é€‚ç”¨ï¼š

```
cerebro.addstrategy(MyStrategy, myparam1=value1, myparam2=value2) 
# ä¼˜åŒ–æ—¶ï¼Œå¿…é¡»å°†å‚æ•°ä½œä¸ºå¯è¿­ä»£å¯¹è±¡æ·»åŠ ã€‚æœ‰å…³è¯¦ç»†è¯´æ˜ï¼Œè¯·å‚è§â€œä¼˜åŒ–â€éƒ¨åˆ†ã€‚Â Â 
cerebro.optstrategy(MyStrategy, myparam1=range(10, 20))
```

å®ƒå°†ä½¿ç”¨myparam1å€¼ä»10åˆ°19çš„å€¼è¿è¡ŒMyStrategy10æ¬¡ï¼ˆè®°ä½Pythonä¸­çš„èŒƒå›´æ˜¯åŠå¼€çš„ï¼Œä¸ä¼šå–åˆ°20ï¼‰

4.å…¶ä»–è¦ç´ Â Â 
å¯ä»¥æ·»åŠ å…¶ä»–ä¸€äº›å…ƒç´ æ¥å¢å¼ºå›æµ‹ä½“éªŒï¼Œè¯·å‚è§ç›¸åº”çš„éƒ¨åˆ†ã€‚æ–¹æ³•æ˜¯ï¼š

- addwriter
- addanalyzer
- addobserver (or addobservermulti)

5.æ›´æ¢ç»çºªäººÂ Â 
Cerebroå°†åœ¨backtraderä¸­ä½¿ç”¨é»˜è®¤ç»çºªäººï¼Œä½†æ˜¯å¯ä»¥è¢«é‡å†™ï¼š

```
broker = MyBroker() 
cerebro.broker = broker # property using getbroker/setbroker methods
```

6.æ¥æ”¶é€šçŸ¥Â Â 
å¦‚æœäº¤æ˜“æ•°æ®å’Œ/æˆ–ä»£ç†å‘é€é€šçŸ¥ï¼ˆè¢«store provideråˆ›å»ºçš„é€šçŸ¥ï¼‰ï¼Œåˆ™å®ƒä»¬å°†é€šè¿‡Cerebro.notify_storeæ–¹æ³•æ¥æ”¶ã€‚æœ‰ä¸‰ç§å¤„ç†é€šçŸ¥çš„æ–¹æ³•ï¼š

- é€šè¿‡addnotifycallback(callback)æ–¹æ³•å°†å›è°ƒæ·»åŠ åˆ°cerebroå®ä¾‹ä¸­ã€‚ å›è°ƒæ–¹æ³•å¦‚ä¸‹ï¼šÂ Â callback(msg, args, ** kwargs) å®é™…æ”¶åˆ°çš„msgï¼Œ argså’Œ** kwarg ç”±ï¼ˆdata/broker/storeï¼‰æ¥å†³å®šï¼Œä½†é€šå¸¸å®ƒä»¬æ˜¯å¯æ‰“å°çš„ï¼Œä»¥ä¾¿è¿›è¡Œæ¥æ”¶å’Œå®éªŒã€‚
- åœ¨Strategyå­ç±»ä¸­çš„è¦†ç›–notify_storeæ–¹æ³• Â notify_storeï¼ˆselfï¼Œmsgï¼Œ argsï¼Œ* kwargsï¼‰
- é€šè¿‡å­ç±»ç»§æ‰¿Cerebroå¹¶è¦†ç›–notify_storeï¼ˆä¸ç­–ç•¥ä¸­çš„æ–¹æ³•ç›¸åŒï¼‰æœ€ä¸æ¨èä½¿ç”¨è¯¥æ–¹æ³•

### 5.1.2. æ‰§è¡Œå›æµ‹

è¿è¡Œå›æµ‹æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å®ƒæ”¯æŒå¤šä¸ªé€‰é¡¹æ¥å†³å®šå¦‚ä½•è¿è¡Œï¼ˆå¯ä»¥åœ¨å®ä¾‹åŒ–æ—¶æŒ‡å®šè¿è¡Œæ¨¡å¼ï¼‰ï¼š

```
result = cerebro.run(**kwargs)
```

è¯·å‚é˜…ä¸‹æ–‡ä¸­ç›¸å…³éƒ¨åˆ†ï¼Œä»¥äº†è§£å¯ç”¨çš„å‚æ•°é€‰é¡¹ã€‚

#### 5.1.2.1. æ ‡å‡†è§‚å¯Ÿè€…

cerebroï¼ˆé™¤éå¦æœ‰è¯´æ˜ï¼‰è‡ªåŠ¨å®ä¾‹åŒ–ä¸‰ä¸ªæ ‡å‡†è§‚å¯Ÿè€…

- ç»çºªäººè§‚å¯Ÿè€…ç”¨æ¥è·Ÿè¸ªç°é‡‘å’ŒæŠ•èµ„ç»„åˆçš„ä»·å€¼
- äº¤æ˜“è§‚å¯Ÿè€…ï¼Œä¼šæ˜¾ç¤ºæ¯ç¬”äº¤æ˜“æ‰€äº§ç”Ÿçš„å½±å“
- ä¹°/å–è§‚å¯Ÿè€…ä¸»è¦å¯¹è®¢å•æ“ä½œè¿›è¡Œè®°å½•Â Â 
å¦‚æœå¸Œæœ›ä½¿ç”¨æ›´å¹²å‡€çš„ç»˜å›¾ï¼Œå¯é€šè¿‡stdstats = False æ¥ç¦ç”¨è¿™äº›è§‚å¯Ÿè€…ã€‚

### 5.1.3. è¿”å›ç»“æœ

cerebroè¿”å›åœ¨å›æµ‹æœŸé—´åˆ›å»ºçš„ç­–ç•¥å®ä¾‹ã€‚ç”±äºç­–ç•¥ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½å¯è®¿é—®ï¼Œå› æ­¤å¯ä»¥åˆ†æä»–ä»¬çš„æ“ä½œï¼š

```
result = cerebro.run(**kwargs)
```

è¿”å›ç»“æœçš„æ ¼å¼å°†æ ¹æ®æ˜¯å¦ä½¿ç”¨ä¼˜åŒ–é€‰é¡¹è€Œæœ‰æ‰€ä¸åŒï¼ˆç­–ç•¥å¯ä»¥é€šè¿‡optstrategyæ–¹å¼æ·»åŠ åˆ°cerebroä¸­ï¼‰ï¼š

- æ‰€æœ‰ç­–ç•¥é€šè¿‡addstrategyæ·»åŠ Â Â resultè¿”å›çš„æ˜¯ä¸€ä¸ªlist
- 1ä¸ªæˆ–å¤šä¸ªç­–ç•¥é€šè¿‡optstrategyæ·»åŠ Â Â resultè¿”å›çš„æ˜¯listçš„listï¼Œ æ¯ä¸ªåˆ—è¡¨é¡¹æ˜¯å¯¹åº”ç­–ç•¥è¿”å›çš„ listã€‚

> æ³¨æ„Â Â : Â ä¸ºä½¿å¾—å†…æ ¸ä¼ é€’çš„æ¶ˆæ¯æ›´è½»ä¾¿ï¼Œç°åœ¨optimizationé»˜è®¤è¿”å›åˆ†æå™¨analyzersã€‚Â Â 
å¦‚æœå¸Œæœ›å°†æ•´å¥—ç­–ç•¥ä½œä¸ºè¿”å›å€¼ï¼Œè¯·å°†å‚æ•°optreturnè®¾ç½®ä¸ºFalseã€‚


### 5.1.4. ä¾¿æ·ç»˜å›¾

å¦‚æœå®‰è£…äº†matplotlibï¼Œåˆ™å¯ä»¥ç»˜åˆ¶ç­–ç•¥ç»“æœã€‚ é€šå¸¸çš„æ¨¡å¼æ˜¯ï¼š

```
cerebro.plotï¼ˆï¼‰
```

è¯·é˜…è¯»ä¸‹é¢çš„å‚è€ƒä¸­â€œç»˜å›¾â€éƒ¨åˆ†ã€‚

### 5.1.5. å›æµ‹é€»è¾‘

å›æµ‹æµç¨‹æ¦‚è¿°ï¼š

1.ä¼ é€’storeä¸­çš„æ‰€æœ‰é€šçŸ¥ï¼›

2.ä»¤æ•°äº¤æ˜“æ•°æ®ä»¥æŸ±é›†åˆæ–¹å¼ä¼ é€’ç»™nextæ–¹æ³•ï¼›Â Â 
åœ¨ç‰ˆæœ¬1.9.0.99ä¸­å·²æ›´æ”¹ä¸ºï¼šÂ Â 
äº¤æ˜“æ•°æ®æ ¹æ®datetimeåŒæ­¥æ£€ç´¢å‡ºæ¥ï¼Œç„¶åæä¾›ç»™nextæ–¹æ³•ã€‚å½“æ²¡æœ‰æ–°æ—¶é—´æ®µçš„äº¤æ˜“æ•°æ®æ—¶ï¼Œå°±ä½¿ç”¨æ—§çš„æ•°æ®ï¼Œæœ‰åˆ™ä½¿ç”¨æ–°çš„ï¼ˆæŒ‡æ ‡ä¸­çš„è®¡ç®—ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ã€‚Â Â 
å¦‚æœè¿‡ä½¿ç”¨æ—§ç‰ˆæœ¬çš„é»˜è®¤è¡Œä¸ºï¼Œå°±åœ¨ä½¿ç”¨Cerebroæ—¶ï¼Œå°†oldsync=Trueã€‚

æ’å…¥åˆ°ç³»ç»Ÿä¸­çš„ç¬¬ä¸€ä¸ªæ•°æ®æ˜¯ä¸»æ•°æ®ï¼Œå…¶ä»–äº¤æ˜“æ•°æ®ä¸ºä»å±æ•°æ®ï¼Œç³»ç»Ÿå°†ç­‰å¾…ç¬¬ä¸€æ¬¡å“åº”æ—¶é’Ÿï¼Œå¹¶ä¸”ï¼š

- å¦‚æœä¸‹ä¸€æ—¶é’Ÿå‘¨æœŸæ¯”datamasterå·²ä¼ é€’çš„æ•°æ®æ—¶é—´è¦æ–°ï¼Œåˆ™è¯¥æ•°æ®å°†ä¸ä¼šè¢«ä¼ é€’ã€‚
- ç”±äºå¤šç§åŸå› ï¼Œå¯èƒ½ä¼šå‡ºç°åœ¨æ²¡æœ‰æä¾›æ–°æŠ¥ä»·çš„æƒ…å†µä¸‹æå‰è¿”å›

è¯¥é€»è¾‘ç›®çš„åœ¨äºåŒæ­¥å¤šä¸ªå…·æœ‰ä¸åŒæ—¶é—´ç‚¹çš„æ•°æ®ã€‚

3.å°†æœ‰å…³è®¢å•ï¼Œäº¤æ˜“å’Œç°é‡‘/ä»·å€¼çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé€šè¿‡ç»çºªé€šçŸ¥ç»™ç­–ç•¥ï¼›

4.å‘ŠçŸ¥ç»çºªäººæ¥å—è®¢å•é˜Ÿåˆ—å¹¶ä½¿ç”¨æ–°æ•°æ®æ‰§è¡ŒæŒ‚å•æ“ä½œï¼›

5.è°ƒç”¨è¯¥ç­–ç•¥çš„nextæ–¹æ³•ï¼Œä»¥ä½¿è¯¥ç­–ç•¥è¯„ä¼°æ–°æ•°æ®ï¼ˆä»¥åŠå¯èƒ½å‘å¸ƒåœ¨ç»çºªäººä¸­æ’é˜Ÿçš„è®¢å•ï¼‰æ ¹æ®é˜¶æ®µçš„ä¸åŒï¼Œåœ¨æ»¡è¶³ç­–ç•¥/æŒ‡æ ‡çš„æœ€çŸ­æœŸé™è¦æ±‚ä¹‹å‰ï¼ˆå¯èƒ½åœ¨prenextæˆ–è€…nextstartæ–¹æ³•ä¸­ï¼‰ï¼Œè¿™äº›ç­–ç•¥å†…éƒ¨è¿˜å°†å¯¹è§‚å¯Ÿè€…ï¼ŒæŒ‡æ ‡ï¼Œåˆ†æå™¨å’Œå…¶ä»–æ´»è·ƒè¦ç´ äº§ç”Ÿå½±å“ï¼›

6.å‘Šè¯‰ä»»ä½•è®°å½•å™¨å°†æ•°æ®å†™å…¥ç›®æ ‡ã€‚

é‡è¦çš„è€ƒè™‘å› ç´ ï¼š

æ³¨æ„:
åœ¨ä¸Šé¢çš„æ­¥éª¤1ä¸­ï¼Œå½“äº¤æ˜“æ•°æ®ä¼ é€’æ–°çš„ä¸€ç»„æŸ±çº¿æ—¶ï¼Œæ—§æŸ±çº¿è¢«å…³é—­ï¼Œè¿™æ„å‘³ç€è¿™äº›è¢«å…³é—­çš„æ•°æ®å·²ç»å‘ç”Ÿè¿‡ã€‚

å› æ­¤ï¼Œæ— æ³•ä½¿ç”¨æ­¥éª¤1ä¸­çš„æ•°æ®æ‰§è¡Œæ­¥éª¤4ä¸­ç­–ç•¥å‘å‡ºçš„è®¢å•ã€‚Â Â 
è¿™æ„å‘³ç€å®šå•å°†ä»¥x + 1çš„æ¦‚å¿µæ‰§è¡Œï¼Œå…¶ä¸­xæ˜¯å®šå•æ‰§è¡Œçš„æŸ±çº¿ï¼Œx + 1æ˜¯ä¸‹ä¸€ä¸ªå®šå•ï¼Œè¿™æ˜¯å¯èƒ½æ‰§è¡Œå®šå•çš„æœ€æ—©æ—¶é—´ã€‚

### 5.1.6. ç›¸å…³ä»‹ç»

class backtrader.Cerebro() å‚æ•°ï¼š

- preload (default: True) æ˜¯å¦ä¸ºç­–ç•¥é¢„å…ˆåŠ è½½ä¼ é€’ç»™cerebroçš„ä¸åŒçš„äº¤æ˜“æ•°æ®
- runonce (default: True) åœ¨çŸ¢é‡æ¨¡å¼ä¸‹è¿è¡ŒæŒ‡æ ‡ï¼Œä»¥åŠ å¿«æ•´ä¸ªç³»ç»Ÿçš„è¿è¡Œé€Ÿåº¦ï¼Œç­–ç•¥å’Œè§‚å¯Ÿè€…å°†å§‹ç»ˆåŸºäºäº‹ä»¶è¿è¡Œ
- live (default: False) å¦‚æœæ²¡æœ‰å®æ—¶æ•°æ®ï¼ˆé€šè¿‡æ•°æ®çš„isliveæ–¹æ³•ï¼Œä½†ç”¨æˆ·ä»å¸Œæœ›ä»¥å®æ—¶æ¨¡å¼è¿è¡Œï¼Œå¯ä»¥å°†æ­¤å‚æ•°è®¾ç½®ä¸ºtrueï¼‰ï¼Œè¿™å°†åŒæ—¶åœç”¨preloadå’Œrunonce,å®ƒä¸ä¼šå¯¹å†…å­˜èŠ‚çœæ–¹æ¡ˆäº§ç”Ÿå½±å“

# å…­. äº¤æ˜“æ•°æ®

backtraderå¸¦æœ‰ä¸€ç»„äº¤æ˜“æ•°æ®è§£æå™¨ï¼ˆè§£ææ‰€æœ‰åŸºäºCSVæ ¼å¼çš„æ–‡ä»¶ï¼‰ï¼Œå¯è®©ä½ ä»ä¸åŒæ¥æºåŠ è½½æ•°æ®ã€‚

- Yahooï¼ˆåœ¨çº¿æˆ–å·²ä¿å­˜åˆ°æ–‡ä»¶ï¼‰
- VisualChartï¼ˆè¯·å‚è§www.visualchart.comï¼‰
- Backtrader CSVï¼ˆbacktraderç”¨äºæµ‹è¯•çš„csvæ–‡ä»¶ï¼‰
- é€šç”¨CSVæ”¯æŒ

ä»å¿«é€Ÿå…¥é—¨æŒ‡å—ä¸­å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œä½ å·²å°†äº¤æ˜“æ•°æ®æ·»åŠ åˆ°Cerebroä¸­ã€‚ äº¤æ˜“æ•°æ®å°†ç”¨äºä¸‹ä¸åŒçš„ç­–ç•¥ï¼š

- æ•°ç»„self.datasï¼ˆæŒ‰æ’å…¥é¡ºåºï¼‰
- æ•°ç»„å¯¹è±¡çš„åˆ«åï¼š 
   - self.dataå’Œself.data0æŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ 
   - self.dataXæŒ‡å‘æ•°ç»„ä¸­ç´¢å¼•ä¸ºXçš„å…ƒç´ 

# ä¸ƒ. ç­–ç•¥

## 7.1. ç®€ä»‹

Cerebroæ˜¯backtraderçš„å¿ƒæ ¸å¿ƒï¼Œç­–ç•¥æ˜¯ç”¨æˆ·çš„æ ¸å¿ƒã€‚

ç ”ç©¶ä¸€ä¸‹ç­–ç•¥çš„ç”Ÿå‘½å‘¨æœŸ:

æ³¨æ„ï¼šÂ Â 
ä¸€ä¸ªç­–ç•¥å¯èƒ½åœ¨å‡ºç”Ÿæ—¶è¢«æ¥è‡ªbacktrader.errorsæ¨¡å—ä¸­çš„StrategySkipErrorå¼‚å¸¸æ‰€ä¸­æ–­ï¼Œè¿™æ ·å¯ä»¥é¿å…åœ¨å›æµ‹æœŸé—´ç»§ç»­æ‰§è¡Œè¯¥ç­–ç•¥ï¼Œè¯¦æƒ…è¯·å‚é˜…ã€Šå¼‚å¸¸ã€‹éƒ¨åˆ†ç« èŠ‚ã€‚

1. åˆå§‹åŒ–ï¼š**init** è¿™æ˜¯åœ¨å®ä¾‹åˆå§‹åŒ–æœŸé—´è°ƒç”¨çš„ï¼šæŒ‡ç¤ºå’Œå…¶ä»–æ‰€éœ€çš„å±æ€§å°†åœ¨æ­¤å¤„åˆ›å»ºã€‚ä¾‹å¦‚ï¼š

```
def __init__ï¼ˆï¼‰ï¼šÂ Â 
	self.sma = btind.SimpleMovingAverageï¼ˆperiod = 15ï¼‰
```

2.  å¯åŠ¨ï¼šstart cerebroé€šçŸ¥strategyå¼€å§‹è¿è¡Œï¼Œé»˜è®¤å€¼æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ã€‚ 
3.  é¢„å¾ªç¯ï¼šprenext
åˆå§‹åŒ–æ—¶ï¼Œå£°æ˜ä¸€ä¸ªæŒ‡æ ‡ï¼ŒæŒ‡æ ‡é™åˆ¶äº†ç­–ç•¥å¯ä½¿ç”¨çš„æœ€å°æœŸé™ã€‚ä¾‹å¦‚ï¼šåœ¨initä¸Šæ–¹ï¼Œåˆ›å»ºäº†ä¸€ä¸ªPeriod = 15çš„SimpleMovingAverageã€‚Â Â 
åªè¦ç³»ç»Ÿçœ‹åˆ°çš„æŸ±çº¿æ•°é‡å°‘äº15æ¡ï¼Œå°±ä¼šè°ƒç”¨prenextï¼ˆé»˜è®¤å®ç°æ˜¯ç©ºæ“ä½œï¼‰ 
4.  å¾ªç¯ï¼šnext
ä¸€æ—¦ç³»ç»Ÿçœ‹åˆ°äº¤æ˜“æ•°æ®ä¸­æœ‰è¶…è¿‡15æ¡æŸ±çº¿ï¼Œå¹¶ä¸”SimpleMovingAverageå…·æœ‰è¶³å¤Ÿå¤§çš„ç¼“å†²åŒºï¼Œè¯¥ç­–ç•¥å¯ä»¥çœŸæ­£æ‰§è¡Œã€‚Â Â 
æœ‰ä¸€ä¸ªnextstartæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä»…è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä»¥æ ‡è®°ä»prenextåˆ°nextçš„åˆ‡æ¢ã€‚ nextstartçš„é»˜è®¤å®ç°æ˜¯ç®€å•åœ°è°ƒç”¨nextæ–¹æ³•ã€‚ 
5.  é‡å¤ï¼šnone
ä¸»è¦åœ¨è¿›è¡Œå‚æ•°ä¼˜åŒ–æ—¶ï¼ˆä½¿ç”¨ä¸åŒçš„å‚æ•°ï¼‰ï¼Œç³»ç»Ÿä¼šæ ¹æ®ä¸åŒçš„å‚æ•°é‡å¤å®ä¾‹åŒ–å¤šæ¬¡ã€‚ 
6.  åœæ­¢ï¼šstop
è¿›è¡Œé‡ç½®çš„æ—¶é—´åˆ°äº†ï¼Œç³»ç»Ÿä¼šå‘Šä¹‹è¯¥ç­–ç•¥è¿›è¡Œé‡ç½®æ“ä½œï¼Œ é»˜è®¤æ–¹æ³•ä¸ºç©ºã€‚Â Â 
åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¸¸è§„ä½¿ç”¨æ¨¡å¼ï¼Œå¦‚ä¸‹ï¼š 

```
class MyStrategy(bt.Strategy): 
	def __init__(self): 
		self.sma = btind.SimpleMovingAverage(period=15) 
	def next(self): 
		if self.sma > self.data.close: 
			# Do something 
			pass 
		elif self.sma < self.data.close: 
			# Do something else 
			pass
```

åœ¨æ­¤ä»£ç æ®µä¸­ï¼š

- åœ¨**init**æœŸé—´ï¼Œä¸ºå±æ€§åˆ†é…äº†ä¸€ä¸ªæŒ‡æ ‡
- é»˜è®¤çš„ç©ºstartæ–¹æ³•ä¸ä¼šè¢«è¦†ç›–
- prenextå’Œnexstartä¸ä¼šè¢«è¦†ç›–
- åœ¨nextæ–¹æ³•ä¸­ï¼Œå°†æŒ‡æ ‡çš„å€¼ä¸æ”¶ç›˜ä»·è¿›è¡Œæ¯”è¾ƒä»¥æ‰§è¡ŒæŸé¡¹æ“ä½œ
- é»˜è®¤çš„ç©ºstopæ–¹æ³•ä¸ä¼šè¢«è¦†ç›–

ç­–ç•¥å°±åƒç°å®ä¸–ç•Œä¸­çš„äº¤æ˜“è€…ä¸€æ ·ï¼Œå½“æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ä¼šå¾—åˆ°é€šçŸ¥ã€‚å®é™…ä¸Šï¼Œå›æµ‹è¿‡ç¨‹ä¸­çš„æ¯ä¸ªå‘¨æœŸnextæ–¹æ³•è¢«è°ƒç”¨ä¸€æ¬¡ã€‚è¯¥ç­–ç•¥å°†æ‰§è¡Œä»¥ä¸‹åŠ¨ä½œï¼š

- é€šè¿‡notify_orderï¼ˆorderï¼‰é€šçŸ¥è®¢å•ä¸­çš„ä»»ä½•çŠ¶æ€æ›´æ”¹
- é€šè¿‡notify_tradeï¼ˆtradeï¼‰é€šçŸ¥ä»»ä½•å¼€ä»“/æ›´æ–°/å¹³ä»“äº¤æ˜“
- é€šè¿‡notify_cashvalueï¼ˆcash, valueï¼‰é€šçŸ¥ç»çºªäººå½“å‰çš„ç°é‡‘å’ŒæŠ•èµ„ç»„åˆ
- é€šè¿‡notify_fundï¼ˆcash, value, fundvalue, sharesï¼‰é€šçŸ¥ç»çºªäººå½“å‰çš„ç°é‡‘å’ŒæŠ•èµ„ç»„åˆä»¥åŠåŸºé‡‘ä»·å€¼å’Œè‚¡ç¥¨çš„äº¤æ˜“
- é€šè¿‡notify_storeï¼ˆmsgï¼Œ argsï¼Œ* kwargsï¼‰å®ç°ç‰¹å®šçš„äº‹ä»¶

è¯·å‚é˜…Cerebroå¯¹æœ‰å…³storeé€šçŸ¥çš„è¯´æ˜ï¼Œå³ä½¿storeé€šçŸ¥ä¼ é€’ç»™äº†Cerebroï¼Œä¹Ÿä¸€æ ·ä¼šä¼ é€’ç»™ç­–ç•¥ï¼ˆä½¿ç”¨é‡å†™çš„notify_storeæ–¹æ³•æˆ–é€šè¿‡å›è°ƒçš„æ–¹å¼ï¼‰ã€‚

ç­–ç•¥ä¹Ÿå¸Œæœ›äº¤æ˜“è€…æ‰‘æ‰åˆ°å¸‚åœºä¸­çš„æœºä¼šï¼Œå¹¶åœ¨nextæ–¹æ³•ä¸­ï¼Œé€šè¿‡ä»¥ä¸‹æ“ä½œæ¥è·åˆ©ï¼š

- buyæ–¹æ³•å¯ä»¥åšå¤šæˆ–å‡å°‘/å…³é—­ç©ºå¤´å¤´å¯¸
- sellæ–¹æ³•å¯ä»¥åšç©ºæˆ–å‡å°‘/å…³é—­å¤šå¤´å¤´å¯¸
- closeæ–¹æ³•å¯ä»¥å¹³ä»“
- cancelæ–¹æ³•å–æ¶ˆå°šæœªæ‰§è¡Œçš„è®¢å•

# å…«. æŒ‡æ ‡

## 8.1. æŒ‡æ ‡ç”¨æ³•

æŒ‡æ ‡å¯ä»¥åœ¨backtraderçš„ä¸¤ä¸ªåœ°æ–¹ä½¿ç”¨ï¼š

- ç­–ç•¥å†…éƒ¨
- å…¶ä»–æŒ‡æ ‡å†…éƒ¨

### 8.1.1. æŒ‡æ ‡ä½¿ç”¨é€»è¾‘

1. æŒ‡æ ‡å§‹ç»ˆåœ¨ç­–ç•¥çš„**init**æœŸé—´å®ä¾‹åŒ–
2. æŒ‡æ ‡çš„å€¼ï¼ˆæˆ–è€…æŒ‡æ ‡æ´¾ç”Ÿå‡ºæ¥çš„å€¼ï¼‰åœ¨nextæ–¹æ³•ä¸­è¢«ä½¿ç”¨Â Â 
æœ‰ä¸€ä¸ªé‡è¦çš„å…¬ç†è¦è€ƒè™‘ï¼šÂ Â 
åœ¨**init**æœŸé—´å£°æ˜çš„ä»»ä½•æŒ‡æ ‡ï¼ˆæˆ–å…¶æ´¾ç”Ÿå€¼ï¼‰å°†åœ¨è°ƒç”¨nextä¹‹å‰è¿›è¡Œé¢„å…ˆè®¡ç®—ã€‚æˆ‘ä»¬æ¥æ¢è®¨ä¸€ä¸‹æ“ä½œæ¨¡å¼çš„å·®å¼‚ï¼š

#### 8.1.1.1. **init** vs next

- åœ¨**init**æœŸé—´æ¶‰åŠçº¿å¯¹è±¡çš„ä»»ä½•æ“ä½œéƒ½ä¼šç”Ÿæˆå¦ä¸€ä¸ªçº¿å¯¹è±¡
- åœ¨nextæ–¹æ³•ä¸­ä»»ä½•æ¶‰åŠlineå¯¹è±¡çš„æ“ä½œéƒ½ä¼šäº§ç”Ÿå¸¸è§„çš„Pythonç±»å‹ï¼Œä¾‹å¦‚floatå’Œboolã€‚

#### 8.1.1.2. **init** åˆå§‹åŒ–æœŸé—´

```
hilo_diff = self.data.high - self.data.low 
# å˜é‡hilo_diffæ‹¥æœ‰å¯¹lineså¯¹è±¡çš„å¼•ç”¨ï¼Œè¯¥å¼•ç”¨åœ¨è°ƒç”¨nextä¹‹å‰å·²é¢„å…ˆè®¡ç®—ï¼Œå¯ä»¥ä½¿ç”¨æ ‡å‡†æ•°ç»„ç¬¦å·[]è¿›è¡Œè®¿é—®ï¼Œå®ƒåŒ…å«äº†æ¯ä¸ªæ¡äº¤æ˜“æ•°æ®çš„æœ€é«˜ä»·å’Œæœ€ä½ä»·ä¹‹å·®ã€‚
```

å½“æ··åˆç®€å•çš„çº¿ï¼ˆå¦‚self.dataäº¤æ˜“æ•°æ®çš„çº¿ï¼‰å’Œå¤æ‚çš„çº¿ï¼ˆå¦‚æŒ‡æ ‡ï¼‰æ—¶ï¼ŒåŒæ ·é€‚ç”¨ï¼š

```
sma = bt.SimpleMovingAverage(self.data.close) 
close_sma_diff = self.data.close - sma 
# close_sma_diff åŒ…å«ä¸€ä¸ªçº¿å¯¹è±¡
```

ä½¿ç”¨é€»è¾‘è¿ç®—ç¬¦ï¼š

```
close_over_sma = self.data.close > sma 
# æ­¤æ—¶ç”Ÿæˆçš„lineså¯¹è±¡å°†åŒ…å«ä¸€ä¸ªå¸ƒå°”æ•°ç»„
```

#### 8.1.1.3. nextæ–¹æ³•ä¸­

```
# æ“ä½œç¤ºä¾‹ï¼ˆé€»è¾‘è¿ç®—ç¬¦ï¼‰Â Â 
close_over_sma = self.data.close> self.sma
```

```
# ä½¿ç”¨ç­‰æ•ˆæ•°ç»„ï¼ˆåŸºäºç´¢å¼•0çš„è¡¨ç¤ºæ³•ï¼‰Â Â 
close_over_sma = self.data.close [0]> self.sma [0]
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œclose_over_smaä¼šäº§ç”Ÿä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¯¥å€¼æ˜¯æ¯”è¾ƒä¸¤ä¸ªæµ®ç‚¹å€¼çš„ç»“æœï¼Œè¿™ä¸¤ä¸ªæµ®ç‚¹å€¼æ˜¯ç”±[0]è¿ç®—ç¬¦è¿”å›çš„å€¼åº”ç”¨äºself.data.closeå’Œself.smaçš„

#### 8.1.1.4. ä¸ºä»€æ˜¯**init**è€Œä¸æ˜¯nextçš„åŸå› 

é€»è¾‘ç®€åŒ–æ˜“ç”¨æ˜¯å…³é”®ã€‚å¯ä»¥åœ¨**init**æœŸé—´è¿›è¡Œç›¸å…³çš„å£°æ˜å’Œè®¡ç®—ï¼Œä»¥ä¾¿åœ¨nextæ–¹æ³•ä¸­å°†å®é™…æ“ä½œé€»è¾‘é™è‡³æœ€ä½ã€‚Â Â 
è¿˜æœ‰é¢å¤–çš„å¥½å¤„ï¼šé€Ÿåº¦ï¼ˆå› ä¸ºä¸€å¼€å§‹å°±é¢„å…ˆè®¡ç®—å¥½äº†ï¼‰ã€‚Â Â 
ä¸€ä¸ªåœ¨**init**æœŸé—´ç”Ÿæˆè´­ä¹°ä¿¡å·çš„å®Œæ•´ç¤ºä¾‹ï¼š

```
class MyStrategy(bt.Strategy): 
	def __init__(self): 
		sma1 = btind.SimpleMovingAverage(self.data) 
		ema1 = btind.ExponentialMovingAverage() 
		close_over_sma = self.data.close > sma1 
		close_over_ema = self.data.close > ema1 
		sma_ema_diff = sma1 - ema1 
		buy_sig = bt.And(close_over_sma, close_over_ema, sma_ema_diff > 0) 
		
	def next(self): 
		if buy_sig: 
		self.buy()
```

æ³¨æ„Â Â 
æ— æ³•è¦†ç›–Pythonçš„andè¿ç®—ç¬¦ï¼Œæ‰€ä»¥ä½¿ç”¨backtraderè‡ªå®šä¹‰çš„Andï¼Œç±»ä¼¼çš„å‡½æ•°è¿˜æœ‰Orå’ŒIfã€‚Â Â 
æ˜¾è€Œæ˜“è§ï¼Œåœ¨**init**æœŸé—´ä½¿ç”¨â€œå£°æ˜å¼â€æ–¹æ³•å¯ä»¥å°†nextæ–¹æ³•ä¸­ï¼ˆå®é™…ç­–ç•¥è§¦å‘çš„åœ°æ–¹ï¼‰çš„cpuä½¿ç”¨é™è‡³æœ€ä½ã€‚

æ³¨æ„Â Â 
å½“é€»è¾‘å˜å¾—éå¸¸å¤æ‚å¹¶æ¶‰åŠå¤šä¸ªæ“ä½œæ—¶ï¼Œé€šå¸¸æœ€å¥½å°†å…¶å°è£…åœ¨ä¸€ä¸ªæŒ‡æ ‡ç±»ä¸­ã€‚

### 8.1.2. ä¸€äº›æ³¨æ„äº‹é¡¹

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œä¸å…¶ä»–å¹³å°ç›¸æ¯”ï¼Œbacktraderç®€åŒ–äº†ä¸¤ä»¶äº‹ï¼š

- å£°æ˜çš„æŒ‡æ ‡æ—¢æ²¡æœ‰è·å–çˆ¶å‚æ•°ï¼ˆä¾‹å¦‚åˆ›å»ºå®ƒä»¬çš„ç­–ç•¥ï¼‰ä¹Ÿæ²¡æœ‰è°ƒç”¨ä»»ä½•ç±»å‹çš„â€œæ³¨å†Œâ€æ–¹æ³•/å‡½æ•°ã€‚Â Â 
å°½ç®¡è¯¥ç­–ç•¥æ²¡æœ‰å¯åŠ¨æŒ‡æ ‡è®¡ç®—ï¼Œä½†æ˜¯ç”±äºsma-emaçš„æ“ä½œï¼Œçº¿å¯¹è±¡ä¾ç„¶ä¼šç”Ÿæˆã€‚
- åœ¨æ²¡æœ‰self.dataçš„æƒ…å†µä¸‹å®ä¾‹åŒ–äº†ExponentialMovingAverage
å¦‚æœæœªä¼ é€’ä»»ä½•æ•°æ®ï¼Œåˆ™çˆ¶çº§ï¼ˆç­–ç•¥ï¼‰çš„ç¬¬1ä¸ªæ•°æ®å°†è¢«è‡ªåŠ¨ä¼ é€’ã€‚

### 8.1.3. æŒ‡æ ‡ç»˜å›¾

é¦–å…ˆï¼Œæœ€é‡è¦çš„æ˜¯ï¼š

- å£°æ˜çš„æŒ‡æ ‡ä¼šè‡ªåŠ¨è¢«ç»˜åˆ¶ï¼ˆå¦‚æœè°ƒç”¨cerebro.plotï¼‰
- ä¸ä¼šç»˜åˆ¶æ“ä½œçš„çº¿æ¡å¯¹è±¡ï¼ˆä¾‹å¦‚close_over_sma = self.data.close> self.smaï¼‰Â Â 
å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä½¿ç”¨LinePlotterIndicatoræ–¹æ³•æ¥è¾…åŠ©ç»˜åˆ¶ï¼š

```
close_over_sma = self.data.close> self.sma 
LinePlotterIndicatorï¼ˆclose_over_sma,name ='Close_over_SMA'ï¼‰Â Â 
# nameå‚æ•°å°†åç§°æŒ‡å®šç»™æ­¤æŒ‡æ ‡
```

## 8.2. æŒ‡æ ‡å¼€å‘

å¦‚æœå¿…é¡»å®šåˆ¶ä»»ä½•å†…å®¹ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªè·èƒœç­–ç•¥é™¤å¤–ï¼‰ï¼Œè¿™ä¸€å®šæ˜¯è‡ªå®šä¹‰æŒ‡æ ‡ã€‚Â Â 
backtraderä¸‹è‡ªå®šä¹‰æŒ‡æ ‡éå¸¸å®¹æ˜“ã€‚Â Â 
å¿…è¦æµç¨‹å¦‚ä¸‹ï¼š

- ä»æŒ‡æ ‡ï¼ˆç›´æ¥æˆ–ä»å·²ç»å­˜åœ¨çš„å­ç±»ï¼‰æ´¾ç”Ÿçš„ç±»ï¼›
- å®šä¹‰å°†éœ€è¦ä¿å­˜æˆ–ä½¿ç”¨çš„çº¿å¯¹è±¡ï¼›
- æŒ‡æ ‡å¿…é¡»è‡³å°‘æœ‰1æ¡çº¿ï¼Œå¦‚æœç»§æ‰¿äº†ä¸€ä¸ªæŒ‡æ ‡ï¼Œåˆ™çº¿å¯¹è±¡å·²ç»è¢«å®šä¹‰è¿‡äº†ï¼›
- ï¼ˆå¯é€‰ï¼‰å®šä¹‰å¯ä»¥æ›´æ”¹è¡Œä¸ºçš„å‚æ•°ï¼›
- ï¼ˆå¯é€‰ï¼‰æä¾›/å®šåˆ¶ä¸€äº›å…ƒç´ ï¼Œä»¥å®ç°å¯¹æŒ‡æ ‡çš„åˆç†ç»˜åˆ¶ï¼›
- åœ¨**init**ä¸­æä¾›ä¸€ä¸ªå®Œæ•´å®šä¹‰çš„æ“ä½œï¼Œå¹¶ç»‘å®šï¼ˆåˆ†é…ï¼‰åˆ°æŒ‡æ ‡çš„çº¿ï¼Œæˆ–è€…æä¾›next å’Œï¼ˆå¯é€‰ï¼‰onceæ–¹æ³•ä½¿ç”¨ï¼›Â Â 
å¦‚æœåœ¨åˆå§‹åŒ–æœŸé—´ä½¿ç”¨é€»è¾‘/ç®—æœ¯è¿ç®—å®Œå…¨å®šä¹‰ä¸€ä¸ªæŒ‡æ ‡ï¼Œå¹¶ä¸”ç»“æœåˆ†é…ç»™è¯¥çº¿ã€‚Â Â 
å¦‚æœä¸æ˜¯å¦‚æ­¤ï¼Œè‡³å°‘å¿…é¡»æä¸‹ä¸€ä¸ªæŒ‡æ ‡ï¼Œè¯¥æŒ‡æ ‡å¿…é¡»ä¸ºç´¢å¼•ä¸º0çš„çº¿åˆ†é…ä¸€ä¸ªå€¼ï¼Œå¯ä»¥é€šè¿‡onceæ–¹æ³•æ¥å®ç°Runonceæ¨¡å¼ï¼ˆæ‰¹å¤„ç†æ“ä½œï¼‰çš„Â è®¡ç®—ä¼˜åŒ–ã€‚

### 8.2.1. é‡è¦è¯´æ˜ï¼šå¹‚ç­‰æ€§

æŒ‡æ ‡ä¸ºæ”¶åˆ°çš„æ¯ä¸ªæŸ±çº¿äº§ç”Ÿè¾“å‡ºã€‚ ä¸å¿…å‡è®¾åŒä¸€æŸ±å°†è¢«å‘é€å¤šå°‘æ¬¡ï¼Œæ“ä½œå¿…é¡»æ˜¯å¹‚ç­‰çš„ã€‚Â Â 
å…¶åŸºæœ¬åŸç†ï¼š

- ç›¸åŒçš„æŸ±çº¿ï¼ˆä»¥ç´¢å¼•ä¸ºå•ä½ï¼‰å¯ä»¥é€šè¿‡æ›´æ”¹å€¼ï¼ˆå³ï¼Œæ›´æ”¹å€¼æ˜¯æ”¶ç›˜ä»·ï¼‰å¤šæ¬¡å‘é€ã€‚

ä¾‹å¦‚ï¼Œâ€œé‡æ’­â€æ¯æ—¥ä¼šè¯ï¼Œå¯ä»¥ä½¿ç”¨ç”±5åˆ†é’ŸæŸ±ç»„æˆçš„æ—¥å†…æ•°æ®ã€‚

backtraderå…è®¸ä½¿ç”¨å®æ—¶äº¤æ˜“æ•°æ®ã€‚

#### 8.2.1.1. ä¸€ä¸ªè™šæ‹Ÿï¼ˆä½†åŠŸèƒ½æ­£å¸¸ï¼‰æŒ‡æ ‡

```
class DummyInd(bt.Indicator): 
	lines = ('dummyline',) 
	params = (('value', 5),) 
	
	def __init__(self): 
		self.lines.dummyline = bt.Max(0.0, self.params.value)
```

æŒ‡æ ‡å°†å§‹ç»ˆè¾“å‡ºç›¸åŒçš„å€¼ï¼š0.0æˆ–self.params.valueï¼ˆå¦‚æœæ°å¥½å¤§äº0.0ï¼‰ã€‚Â Â 
ç›¸åŒçš„æŒ‡æ ‡ï¼Œä½†ä½¿ç”¨nextæ–¹æ³•ï¼š

```
class DummyInd(bt.Indicator): 
	lines = ('dummyline',) 
	params = (('value', 5),) 
	
	def next(self): 
		self.lines.dummyline[0] = max(0.0, self.params.value)
```

æ³¨æ„ åœ¨**init**ç‰ˆæœ¬ä¸­ï¼Œä½¿ç”¨bt.Maxåˆ†é…Lineå¯¹è±¡ç»™self.lines.dummylineã€‚

bt.Maxè¿”å›ä¸€ä¸ªlineå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¼šé’ˆå¯¹ä¼ é€’åˆ°æŒ‡æ ‡çš„æ¯ä¸ªæŸ±çº¿è‡ªåŠ¨è¿›è¡Œè¿­ä»£ã€‚Â Â 
å¦‚æœä½¿ç”¨maxä»£æ›¿ï¼Œåˆ™åˆ†é…å°†æ˜¯æ¯«æ— æ„ä¹‰çš„ï¼Œå› ä¸ºæŒ‡æ ‡å¾—åˆ°ä¸€ä¸ªå›ºå®šå€¼ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªçº¿å¯¹è±¡ã€‚ åœ¨ nextæ–¹æ³•ä¸­ï¼Œå°†ç›´æ¥ä½¿ç”¨æµ®ç‚¹å€¼å®Œæˆå·¥ä½œï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨å†…ç½®æ ‡å‡†çš„maxå‡½æ•°ã€‚

è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ï¼Œself.lines.dummylineæ˜¯é•¿ç¬¦å·ï¼Œå¯ä»¥å°†å…¶ç¼©çŸ­ä¸ºï¼š

- self.l.dummyline
ç”šè‡³
- self.dummyline
åè€…åªæœ‰åœ¨ä»£ç æœªä½¿ç”¨memberå±æ€§æ‰æœ‰èƒ½ä½¿ç”¨ã€‚ ç¬¬ä¸‰ä¸ªä¹Ÿæ˜¯æœ€åä¸€ä¸ªç‰ˆæœ¬æä¾›äº†ä¸€ç§é¢å¤–çš„ onceæ–¹æ³•æ¥ä¼˜åŒ–è®¡ç®—ï¼š

```
class DummyInd(bt.Indicator): 
	lines = ('dummyline',) 
	params = (('value', 5),) 
	
	def next(self): 
		self.lines.dummyline[0] = max(0.0, self.params.value) 
		
	def once(self, start, end): 
		dummy_array = self.lines.dummyline.array 
		
		for i in xrange(start, end): 
			dummy_array[i] = max(0.0, self.params.value)
```

æ— è®ºå¦‚ä½•**init**ç‰ˆæœ¬æ˜¯æœ€å¥½çš„ï¼š

- ä¸€åˆ‡éƒ½é™äºåˆå§‹åŒ–
- nextå’Œonceï¼ˆå‡å·²ä¼˜åŒ–ï¼Œå› ä¸ºbt.Maxå·²ç»æ‹¥æœ‰å®ƒä»¬ï¼‰ï¼Œè‡ªåŠ¨æä¾›è€Œæ— éœ€ä½¿ç”¨ç´¢å¼•å’Œ/æˆ–å…¬å¼Â Â 
å¦‚æœéœ€è¦å¼€å‘ï¼Œè¯¥æŒ‡æ ‡è¿˜å¯ä»¥è¦†ç›–ä¸nextå’Œonceç›¸å…³çš„æ–¹æ³•ï¼š
- prenextå’Œnexstart
- reonceå’Œoncestart

#### 8.2.1.2. æ‰‹åŠ¨/è‡ªåŠ¨æœ€çŸ­æ—¶é—´

å¦‚æœå¯èƒ½ï¼Œbacktraderå°†å¯¹å…¶è¿›è¡Œè®¡ç®—ï¼Œä½†å¯èƒ½éœ€è¦æ‰‹åŠ¨æ“ä½œã€‚ è¿™æ˜¯ç®€å•ç§»åŠ¨å¹³å‡çº¿çš„æ½œåœ¨å®ç°ï¼š

```
class SimpleMovingAverage1(Indicator): 
	lines = ('sma',) 
	params = (('period', 20),) 
	
	def next(self): 
		datasum = math.fsum(self.data.get(size=self.p.period)) 
		self.lines.sma[0] = datasum / self.p.period
```

å°½ç®¡å¬èµ·æ¥ä¸é”™ï¼Œä½†backtraderä¸çŸ¥é“æœ€å°å‘¨æœŸæ˜¯å¤šå°‘ï¼Œå³ä½¿è¯¥å‚æ•°è¢«å‘½åä¸ºâ€œperiodâ€ï¼ˆåç§°å¯èƒ½ä¼šå¼•èµ·è¯¯è§£ï¼Œå¹¶ä¸”æŸäº›æŒ‡æ ‡ä¼šæ”¶åˆ°å‡ ç§ç”¨æ³•ä¸åŒçš„â€œperiodâ€ï¼‰

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†å·²ç»ä¸ºç¬¬ä¸€ä¸ªæ•°æ®æŸ±è°ƒç”¨äº†nextæ–¹æ³•ï¼Œå› ä¸ºgetæ–¹æ³•æ— æ³•è¿”å›æ‰€éœ€çš„self.p.periodï¼Œå°†ä¼šå¯¼è‡´ä¸€ç³»åˆ—çš„å¼‚å¸¸ã€‚åœ¨è§£å†³é—®é¢˜ä¹‹å‰ï¼Œå¿…é¡»è€ƒè™‘ä»¥ä¸‹äº‹é¡¹ï¼š

- ä¼ é€’ç»™æŒ‡æ ‡çš„äº¤æ˜“æ•°æ®å¯èƒ½å·²ç»å­˜åœ¨æœ€çŸ­æ—¶é—´ æ ·ä¾‹ SimpleMovingAverageå¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®è¿›è¡Œï¼š
- å¸¸è§„äº¤æ˜“æ•°æ®ï¼šé»˜è®¤æœ€å°å‘¨æœŸä¸º1ï¼ˆåªéœ€ç­‰å¾…è¿›å…¥ç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªæŸ±ï¼‰
- å¦ä¸€ä¸ªç§»åŠ¨å¹³å‡çº¿...è¿™å·²ç»æœ‰ä¸€ä¸ªå‘¨æœŸÂ Â  å¦‚æœè¿™æ˜¯20ï¼Œè€Œæˆ‘ä»¬çš„æ ·æœ¬ç§»åŠ¨å¹³å‡çº¿ä¹Ÿä¸º20ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„æœ€å°å‘¨æœŸä¸º40æ¡Â Â  å®é™…ä¸Šï¼Œå†…éƒ¨è®¡ç®—ç»“æœä¸º39...å› ä¸ºç¬¬ä¸€ä¸ªç§»åŠ¨å¹³å‡çº¿ä¸€æ—¦äº§ç”Ÿä¸€ä¸ªæŸ±çº¿ï¼Œä¾¿ä¼šè®¡å…¥ä¸‹ä¸€ä¸ªç§»åŠ¨å¹³å‡çº¿ï¼Œè¿™ä¼šäº§ç”Ÿé‡å çš„æŸ±çº¿ï¼Œå› æ­¤éœ€è¦39ã€‚
- å…¶ä»–å¸¦æœ‰æœŸé—´çš„æŒ‡æ ‡/ç›®æ ‡Â Â 
æ›¿ä»£æ–¹æ³•å¦‚ä¸‹ï¼š

```
class SimpleMovingAverage1(Indicator): 
	lines = ('sma',) 
	params = (('period', 20),) 
	
	def __init__(self): 
		self.addminperiod(self.params.period) 
		
	def next(self): 
		datasum = math.fsum(self.data.get(size=self.p.period)) 
		self.lines.sma[0] = datasum / self.p.period
```

addminperiodæ–¹æ³•æ˜¯è®©ç³»ç»Ÿè€ƒè™‘è¯¥æŒ‡æ ‡æ‰€éœ€çš„é¢å¤–å‘¨æœŸæ¡ï¼Œä»¥è€ƒè™‘å¯èƒ½å­˜åœ¨çš„ä»»ä½•æœ€å°å‘¨æœŸã€‚ å¦‚æœæ‰€æœ‰è®¡ç®—éƒ½æ˜¯ä½¿ç”¨å·²ç»å°†å…¶å‘¨æœŸéœ€æ±‚ä¼ è¾¾ç»™ç³»ç»Ÿçš„å¯¹è±¡å®Œæˆçš„ï¼Œåˆ™æœ‰æ—¶ç»å¯¹ä¸éœ€è¦ã€‚Â Â 
å¿«é€Ÿå®ç°å¸¦æœ‰ç›´æ–¹å›¾çš„MACDæŒ‡æ ‡ï¼š

```
from backtrader.indicators import EMA 
class MACD(Indicator): 
	lines = ('macd', 'signal', 'histo',) 
	params = (('period_me1', 12), ('period_me2', 26), ('period_signal', 9),) 
	
	def __init__(self): 
		me1 = EMA(self.data, period=self.p.period_me1) 
		me2 = EMA(self.data, period=self.p.period_me2) 
		self.l.macd = me1 - me2 
		self.l.signal = EMA(self.l.macd, period=self.p.period_signal) 
		self.l.histo = self.l.macd - self.l.signal
```

å®Œæˆï¼Œæ— éœ€è€ƒè™‘æœ€å°å‘¨æœŸé—®é¢˜ï¼š

- EMAä»£è¡¨æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿ï¼ˆç³»ç»Ÿå†…ç½®åˆ«åï¼‰
- æŒ‡æ ‡â€œmacdâ€å’Œâ€œsignalâ€çš„ä¸­è¢«å‘½åä¸ºlinesçš„å¯¹è±¡å·²ç»åˆ†é…äº†periodså‘¨æœŸå¯¹è±¡ 
   - macdå–è‡ªè¿ç®—â€œme1-me2â€çš„periodsï¼Œè€Œè¿ç®—â€œme1-me2â€åˆå–me1å’Œme2çš„periodsçš„æœ€å¤§å€¼ï¼ˆå®ƒä»¬æ˜¯ä¸åŒå‘¨æœŸçš„æŒ‡æ•°ç§»åŠ¨å¹³å‡å€¼ï¼‰
   - signalç›´æ¥é‡‡ç”¨macdä¸Šçš„æŒ‡æ•°ç§»åŠ¨å¹³å‡çº¿çš„periodsã€‚è¯¥EMAè¿˜è€ƒè™‘äº†å·²ç»å­˜åœ¨çš„macdå‘¨æœŸå’Œæ‰€éœ€çš„æ ·æœ¬é‡ï¼ˆperiod_signalï¼‰æ¥è¿›è¡Œè‡ªÂ Â 
èº«è®¡ç®—
   - histoå–ä¸¤ä¸ªæ“ä½œæ•°â€œsignal-macdâ€ä¸­çš„æœ€å¤§å€¼ã€‚ä¸€æ—¦ä¸¤è€…éƒ½å‡†å¤‡å¥½ï¼Œhistoä¾¿æœ‰äº†å…·ä½“çš„å€¼

### 8.2.2. ä¸€ä¸ªå®Œæ•´çš„è‡ªå®šä¹‰æŒ‡æ ‡

è®©æˆ‘ä»¬å¼€å‘ä¸€ä¸ªç®€å•çš„è‡ªå®šä¹‰æŒ‡æ ‡ï¼Œè¯¥æŒ‡æ ‡çš„ç§»åŠ¨å¹³å‡å€¼å¯ä»¥ç”¨å‚æ•°ä¿®æ”¹ï¼š

```
import backtrader as bt 
import backtrader.indicators as btind 
class OverUnderMovAv(bt.Indicator): 
	lines = ('overunder',) 
	params = dict(period=20, movav=btind.MovAv.Simple) 
	
	def __init__(self): 
		movav = self.p.movav(self.data, period=self.p.period) 
		self.l.overunder = bt.Cmp(movav, self.data)
```

å®Œæˆï¼Œå¦‚æœå¹³å‡å€¼é«˜äºæ•°æ®ï¼Œåˆ™æŒ‡æ ‡çš„å€¼ä¸ºâ€œ1â€ï¼Œå¦‚æœä½äºæ•°æ®ï¼Œåˆ™æŒ‡æ ‡çš„å€¼ä¸ºâ€œ-1â€ã€‚å¦‚æœæ•°æ®æ˜¯å¸¸è§„æ•°æ®ï¼Œåˆ™ä¸æ”¶ç›˜ä»·ç›¸æ¯”ä¼šäº§ç”Ÿ1å’Œ-1ã€‚ä¸ºäº†è®©æŒ‡æ ‡å¯ä»¥ä¼˜é›…çš„ç»˜å›¾ï¼ˆæ›´å¤šå†…å®¹å¯ä»¥å‚è€ƒç»˜å›¾éƒ¨åˆ†ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä»¥ä¸‹å‡ ç‚¹ï¼š

```
import backtrader as bt 
import backtrader.indicators as btind 

class OverUnderMovAv(bt.Indicator): 
	lines = ('overunder',) 
	params = dict(period=20, movav=bt.ind.MovAv.Simple) 
	
	plotinfo = dict( 
		# 1så’Œ-1sçš„ä¸Šæ–¹å’Œä¸‹æ–¹æ·»åŠ é¢å¤–çš„è¾¹è·Â Â 
		plotymargin=0.15, 
		# åœ¨1.0å’Œ-1.0å¤„ç»˜åˆ¶å‚è€ƒæ°´å¹³çº¿Â Â 
		plothlines=[1.0, -1.0], 
		# å°†yçš„èŒƒå›´è®¾ç½®ä¸º1.0å’Œ-1.0ä¹‹é—´Â Â 
		plotyticks=[1.0, -1.0]) 
		
	# ç”¨ç ´æŠ˜å·æ ·å¼ç»˜åˆ¶â€œoverunderâ€çº¿ï¼Œlsä»£è¡¨çº¿çš„æ ·å¼ï¼Œå¹¶ç›´æ¥ä¼ é€’ç»™matplotlib 
	plotlines = dict(overunder=dict(ls='--')) 
	
	def _plotlabel(self): 
		# æ­¤æ–¹æ³•è¿”å›å°†æ˜¾ç¤ºçš„æ ‡ç­¾åˆ—è¡¨ï¼ŒæŒ‡æ ‡åç§°è·Ÿåœ¨ç»˜å›¾ç‚¹åé¢Â Â 
		# period å¿…é¡»è¦æœ‰Â Â 
		plabels = [self.p.period] 
		# å¦‚æœä¸æ˜¯é»˜è®¤å€¼ï¼Œåˆ™ä»…æ”¾ç½®ç§»åŠ¨å¹³å‡çº¿Â Â 
		plabels += [self.p.movav] * self.p.notdefault('movav') 
		return plabels 
		
	def __init__(self): 
		movav = self.p.movav(self.data, period=self.p.period) 
		self.l.overunder = bt.Cmp(movav, self.data)
```

# ä¹. åˆ†æå™¨

## 9.1. åˆ†æå™¨

æ— è®ºæ˜¯å›æµ‹è¿˜æ˜¯äº¤æ˜“ï¼Œèƒ½å¤Ÿåˆ†æäº¤æ˜“ç³»ç»Ÿçš„æ€§èƒ½æ˜¯éå¸¸é‡è¦çš„ã€‚å› ä¸ºä¸ä»…äº†è§£è·å¾—åˆ©æ¶¦ï¼Œè€Œä¸”è¿˜è¦äº†è§£é£é™©ã€‚å¦‚æœé£é™©å¤ªå¤§æˆ‘ä»¬å°±è¦æ˜¯å¦å€¼å¾—ä¸ºè¿™æ ·çš„èµ„äº§ä»˜å‡ºåŠªåŠ›ã€‚å‚è€ƒèµ„äº§ï¼ˆæˆ–æ— é£é™©èµ„äº§ï¼‰ã€‚Â Â 
è¿™å°±æ˜¯Analyzerå¯¹è±¡å®¶æ—çš„ç”¨æ­¦ä¹‹åœ°ï¼šæä¾›å¯¹å‘ç”Ÿçš„äº‹ä»¶ç”šè‡³å®é™…å‘ç”Ÿçš„äº‹ä»¶çš„åˆ†æã€‚

### 9.1.1. åˆ†æå™¨çš„æ€§è´¨

è¯¥æ¥å£æ˜¯æŒ‰ç…§Lineså¯¹è±¡çš„æ¥å£å»ºæ¨¡çš„ï¼Œç‰¹å¾æœ‰ç‚¹åƒnextæ–¹æ³•ï¼Œä½†æœ‰ä¸€ä¸ªä¸»è¦åŒºåˆ«ï¼š

- Analyzerä¸æŒæœ‰Lineså¯¹è±¡Â Â 
è¿™æ„å‘³ç€å®ƒä»¬åœ¨å†…å­˜æ–¹é¢å¼€é”€ä¸å¤§ï¼Œå› ä¸ºå³ä½¿åœ¨åˆ†æäº†æ•°åƒä¸ªä»·æ ¼æŸ±ä¹‹åï¼Œå®ƒä»¬åªéœ€å°†å•ä¸ªç»“æœä¿å­˜åœ¨å†…å­˜ä¸­ã€‚

### 9.1.2. åœ¨ç”Ÿæ€ç³»ç»Ÿä¸­çš„ä½ç½®

é€šè¿‡cerebroå®ä¾‹å°†Analyzerå¯¹è±¡ï¼ˆä¸ç­–ç•¥ï¼Œè§‚å¯Ÿè€…å’Œæ•°æ®æ–¹å¼é›·åŒï¼‰æ·»åŠ åˆ°ç³»ç»Ÿä¸­ï¼š

- addanalyzer(ancls, args, * kwargs)

å½“åœ¨cerebro.runä¸­è¿è¡Œæ—¶ï¼Œç³»ç»Ÿä¸­å­˜åœ¨çš„æ¯ç§ç­–ç•¥éƒ½ä¼šå‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š

- åœ¨cerebroä¸­è¿è¡Œæ—¶ï¼Œanclsä¼šç”¨ argså’Œ* kwargsè¿›è¡Œå®ä¾‹åŒ–ã€‚
- anclså®ä¾‹å°†æ·»åŠ ç»™è¯¥ç­–ç•¥Â Â 
è¿™æ„å‘³ç€ï¼š
- å¦‚æœå›æµ‹è¿è¡ŒåŒ…å«ä¾‹å¦‚3ä¸ªç­–ç•¥ï¼Œåˆ™å°†åˆ›å»º3ä¸ªanclså®ä¾‹ï¼Œå¹¶å°†æ¯ä¸ªå®ä¾‹é™„åŠ åˆ°ä¸åŒçš„ç­–ç•¥ä¸Šã€‚åº•çº¿ï¼šanalyzeråˆ†æçš„æ˜¯å•ä¸ªç­–ç•¥çš„æ€§èƒ½ï¼Œè€Œä¸æ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½ã€‚

#### 9.1.2.1. é™„åŠ ä½ç½®

æŸäº›åˆ†æå™¨å¯¹è±¡å®é™…ä¸Šå¯èƒ½ä¼šä½¿ç”¨å…¶ä»–åˆ†æå™¨æ¥å®Œæˆå…¶å·¥ä½œã€‚ ä¾‹å¦‚ï¼š SharpeRatioä½¿ç”¨TimeReturnçš„è¾“å‡ºè¿›è¡Œè®¡ç®—ã€‚
è¿™äº›å­åˆ†æå™¨æˆ–ä»å±åˆ†æå™¨ä¹Ÿå°†è¢«æ’å…¥åˆ°åˆ›å»ºå®ƒä»¬çš„ç­–ç•¥ä¸­ï¼Œä½†æ˜¯å®ƒä»¬å¯¹äºç”¨æˆ·æ˜¯å®Œå…¨ä¸å¯è§çš„ã€‚

### 9.1.3. å±æ€§

ä¸ºäº†æ‰§è¡Œé¢„æœŸçš„å·¥ä½œï¼ŒAnalyzerå¯¹è±¡æä¾›äº†ä¸€äº›é»˜è®¤å±æ€§ï¼Œè¿™äº›å±æ€§ä¼šè‡ªåŠ¨ä¼ é€’å¹¶åœ¨å®ä¾‹ä¸­è¿›è¡Œè®¾ç½®ï¼Œä»¥ä¾¿äºä½¿ç”¨ï¼š

- self.strategyï¼šç­–ç•¥å­ç±»çš„è®¿é—®å¼•ç”¨ï¼Œç­–ç•¥å¯ä»¥è®¿é—®çš„åˆ†æå™¨çš„ä»»ä½•å†…å®¹ä¹Ÿå¯ä»¥è¢«åˆ†æå™¨è®¿é—®ã€‚
- self.datas[x]ï¼šè¯¥ç­–ç•¥ä¸­å­˜åœ¨çš„äº¤æ˜“æ•°æ®ï¼Œå°½ç®¡å¯ä»¥åœ¨ç­–ç•¥ä¸­è¿›è¡Œè®¿é—®ï¼Œä½†æ˜¯è¯¥å¿«æ·æ–¹å¼è®¿é—®å¯ä»¥æ›´åŠ èˆ’é€‚ã€‚
- self.dataï¼šself.datas[0]çš„å¿«æ·æ–¹å¼ï¼Œå¸¦æ¥æ›´å¤šèˆ’é€‚æ„Ÿã€‚
- self.dataXï¼šä¸åŒself.datas[x]çš„å¿«æ·è®¿é—®æ–¹å¼ã€‚

å¯ä»¥ä½¿ç”¨å…¶ä»–ä¸€äº›åˆ«åï¼Œå°½ç®¡å®ƒä»¬å¯èƒ½æœ‰ç‚¹è¿‡å¤´äº†ï¼š

- self.dataX_Y ï¼ŒæŒ‡å‘ï¼š self.datas[X].lines[Y]

å¦‚æœè¯¥è¡Œå…·æœ‰åç§°ï¼Œåˆ™ä»¥ä¸‹å†…å®¹ä¹Ÿå¯ç”¨ï¼š

- self.dataX_Name è§£æä¸º self.datas[X].Name è¿”å›æŒ‰åç§°è€Œä¸æ˜¯æŒ‰ç´¢å¼•çš„line

å¯¹äºç¬¬ä¸€ä¸ªæ•°æ®ï¼Œæ²¡æœ‰åˆå§‹Xçš„æƒ…å†µä¸‹ï¼Œæœ€åçš„å¿«æ·æ–¹å¼å¯ç”¨çš„ã€‚ä¾‹å¦‚ï¼š

- self.data_2 æŒ‡çš„æ˜¯ self.datas[0].lines[2]
- self.data_close æŒ‡çš„æ˜¯ self.datas[0] .close

#### 9.1.3.1. è¿”å›åˆ†æ

AnalyzeråŸºç±»åˆ›å»ºä¸€ä¸ªself.retsï¼ˆç±»å‹ä¸ºcollections.OrderedDictï¼‰æˆå‘˜å±æ€§ä»¥è¿”å›åˆ†æç»“æœã€‚è¿™æ˜¯åœ¨create_analysisæ–¹æ³•ä¸­å®Œæˆçš„ï¼Œå¦‚æœåˆ›å»ºè‡ªå®šä¹‰Analyzerï¼Œåˆ™å­ç±»å¯ä»¥è¦†ç›–è¯¥æ–¹æ³•ã€‚

### 9.1.4. æ“ä½œæ–¹å¼

å°½ç®¡Analyzerå¯¹è±¡ä¸æ˜¯â€œçº¿â€å¯¹è±¡ï¼Œå› æ­¤ä¸ä¼šåœ¨çº¿ä¸Šè¿›è¡Œè¿­ä»£ï¼Œä½†å®ƒä»¬è¢«è®¾è®¡ä¸ºéµå¾ªç›¸åŒçš„æ“ä½œæ¨¡å¼ã€‚

- åœ¨ç³»ç»ŸæŠ•å…¥è¿è¡Œä¹‹å‰å®ä¾‹åŒ–ï¼ˆå› æ­¤è°ƒç”¨**init**ï¼‰ï¼›
- ä»startæ“ä½œä¸­å‘å‡ºå¼€å§‹ä¿¡å·ï¼›
- prenext/nextstart/nextå°†åœ¨æŒ‡æ ‡æ‰€æ‰§è¡Œçš„ç­–ç•¥æœ€çŸ­å‘¨æœŸä¹‹å†…è¢«è°ƒç”¨ï¼ŒÂ Â 
prenextå’Œnextstartçš„é»˜è®¤è¡Œä¸ºæ˜¯è°ƒç”¨nextï¼Œå› ä¸ºåˆ†æå™¨å¯èƒ½ä»ç³»ç»Ÿè¿è¡Œçš„ç¬¬ä¸€åˆ»å¼€å§‹å°±è¿›è¡Œåˆ†æï¼›
- é€šå¸¸å¯èƒ½ä¼šåœ¨Lineså¯¹è±¡ä¸­è°ƒç”¨len(self)æ¥æ£€æŸ¥æŸ±çš„å®é™…æ•°é‡ï¼ŒåŒæ ·ï¼Œåœ¨Analyzersä¸­é€šè¿‡è¿”å›self.strategyæ¥è®¿é—®Lineså¯¹è±¡çš„len()æ–¹æ³•ï¼›
- è®¢å•å’Œäº¤æ˜“å°†é€šè¿‡notify_orderå’Œnotify_tradeæ”¶åˆ°ä¸ç­–ç•¥ä¸€æ ·çš„é€šçŸ¥ï¼›
- ç°é‡‘å’Œæ•°å€¼é€šè¿‡notify_cashvalueæ–¹æ³•é€šçŸ¥ï¼›
- ç°é‡‘ï¼Œæ•°å€¼ï¼ŒåŸºé‡‘ä»·å€¼å’ŒåŸºé‡‘ä»½é¢ä¹Ÿå°†é€šè¿‡notify_fundå¾—åˆ°é€šçŸ¥ï¼›
- stopå°†è¢«è°ƒç”¨æ ‡å¿—ç€æ“ä½œç»“æŸã€‚

ä¸€æ—¦å®Œæˆæ­£å¸¸çš„æ“ä½œå‘¨æœŸï¼ŒAnalyzersä¾¿å¯ä½¿ç”¨ç”¨äºæå–/è¾“å‡ºä¿¡æ¯çš„æ–¹æ³•ï¼š

- get_analysisï¼šç†æƒ³æƒ…å†µä¸‹ï¼ˆä¸å¼ºåˆ¶æ‰§è¡Œï¼‰è¿”å›åŒ…å«åˆ†æç»“æœçš„ç±»ä¼¼dictçš„å¯¹è±¡;
- printä½¿ç”¨æ ‡å‡†çš„backtrader.WriterFileï¼ˆé™¤éoverridenï¼‰æ¥å†™å…¥get_analysisçš„åˆ†æç»“æœ;
- pprintï¼ˆæ¼‚äº®æ‰“å°ï¼‰ä½¿ç”¨Python pprintæ¨¡å—æ‰“å°get_analysisçš„ç»“æœ;

æœ€åï¼š

- get_analysisåˆ›å»ºä¸€ä¸ªæˆå‘˜å±æ€§self.retï¼ˆç±»å‹ä¸ºcollections.OrderedDictï¼‰ï¼ŒAnalyzersç”¨æ¥ä¿å­˜åˆ†æç»“æœã€‚
- Analyzerçš„å­ç±»å¯ä»¥é‡å†™æ­¤æ–¹æ³•æ¥æ›´æ”¹é»˜è®¤è¡Œä¸ºã€‚

### 9.1.5. Analyzeræ¨¡å¼

åœ¨backtraderå¹³å°ä¸­Analyzerå¯¹è±¡çš„å¼€å‘æ­ç¤ºäº†ä¸¤ç§ä¸åŒæ¨¡å¼æ¥äº§ç”Ÿæˆåˆ†æç»“æœï¼š

- åœ¨æ‰§è¡ŒæœŸé—´ï¼Œé€šè¿‡notify_xxxå’Œnextæ–¹æ³•æ”¶é›†ä¿¡æ¯ï¼Œå¹¶åœ¨nextä¸­ç”Ÿæˆåˆ†ææ•°æ®Â Â 
ä¾‹å¦‚ï¼ŒTradeAnalyzerä»…ä½¿ç”¨notify_tradeæ–¹æ³•æ¥ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯ã€‚
- æ”¶é›†ï¼ˆæˆ–ä¸æ”¶é›†ï¼‰ä¸Šè¿°ä¿¡æ¯ï¼Œåœ¨stopæ–¹æ³•ä¸€æ¬¡æ€§ç”Ÿæˆåˆ†ææ•°æ®Â Â 
SQNï¼ˆç³»ç»Ÿè´¨é‡ç¼–å·ï¼‰åœ¨notify_tradeæœŸé—´æ”¶é›†äº¤æ˜“ä¿¡æ¯ï¼Œåœ¨stopæ–¹æ³•ä¸­ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯

### 9.1.6. ä¸€ä¸ªå°½å¯èƒ½ç®€å•çš„ä¾‹å­

```python
from __future__ import (absolute_import, division, print_function, 
unicode_literals) 
import datetime 

import backtrader as bt 
import backtrader.analyzers as btanalyzers 
import backtrader.feeds as btfeeds 
import backtrader.strategies as btstrats 

cerebro = bt.Cerebro() 

# data 
dataname = '2005-2006-day-001.txt' 
data = btfeeds.BacktraderCSVData(dataname=dataname) 
cerebro.adddata(data) 

# strategy 
cerebro.addstrategy(btstrats.SMA_CrossOver) 

# Analyzer 
cerebro.addanalyzer(btanalyzers.SharpeRatio, _name='mysharpe') 
thestrats = cerebro.run() 
thestrat = thestrats[0] 

print('å¤æ™®æ¯”ç‡:', thestrat.analyzers.mysharpe.get_analysis())
```

```
å¤æ™®æ¯”ç‡: OrderedDict([('sharperatio', 11.647332609673251)])
```

æ‰§è¡Œå®ƒï¼ˆå·²å°†å…¶å­˜å‚¨åœ¨analyzer-test.pyä¸­ï¼‰ï¼š

```
$ ./analyzer-test.py 
Sharpe Ratio: {'sharperatio': 11.647332609673256}
```

è¿™é‡Œæ²¡æœ‰ç»˜å›¾ï¼Œå› ä¸ºSharpeRatioåœ¨è®¡ç®—ç»“æŸæ—¶æ˜¯å•ä¸ªå€¼ã€‚

## 9.2. PyFolioæ¦‚è¿°

> æ³¨æ„
ä»ï¼ˆè‡³å°‘ï¼‰2017å¹´7æœˆ25æ—¥èµ·ï¼Œpyfolio APIå·²æ›´æ”¹ï¼Œå¹¶ä¸”create_full_tear_sheetä¸å†æœ‰Gross_levä½œä¸ºå‘½åå‚æ•°ã€‚å› æ­¤ï¼Œé›†æˆç¤ºä¾‹ä¸èµ·ä½œç”¨ã€‚


ä»¥ä¸‹å¼•ç”¨æ¥è‡ªpyfolioä¸»é¡µ([http://quantopian.github.io/pyfolio/](http://quantopian.github.io/pyfolio/))

pyfolioæ˜¯ä¸€ä¸ªPythonåº“ï¼Œç”¨äºæŠ•èµ„ç»„åˆçš„è´¢åŠ¡ç»©æ•ˆå’Œé£é™©åˆ†æï¼Œç”±Quantopianå…¬å¸å¼€å‘ã€‚å¯ä»¥å¾ˆå¥½çš„é…åˆZiplineæ¡†æ¶ï¼Œè¿›è¡Œå›æµ‹ã€‚

ç°åœ¨ï¼Œä¹Ÿå¯ä»¥ä¸backtraderä¸€èµ·ä½¿ç”¨ã€‚éœ€è¦æ”¯æŒåº“ï¼š

- pyfolio
- åŠå…¶ä¾èµ–åº“ï¼ˆpandas, seabornç­‰ï¼‰

> æ³¨æ„Â Â 
åœ¨ä¸ç‰ˆæœ¬0.5.1é›†æˆæœŸé—´ï¼Œéœ€è¦æ›´æ–°ä¾èµ–åº“çš„æœ€æ–°è½¯ä»¶åŒ…ã€‚ä¾‹å¦‚å°†seabornä»å…ˆå‰å®‰è£…çš„0.7.0-devå‡çº§åˆ°0.7.1ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºç¼ºå°‘æ–¹æ³•Â Â 
swarmploté€ æˆçš„ã€‚


### 9.2.1. ç”¨æ³•

- æ·»åŠ PyFolioåˆ†æå™¨åˆ°cerebroä¸­

```
cerebro.addanalyzerï¼ˆbt.analyzers.PyFolioï¼‰
```

- è¿è¡Œå¹¶è·å¾—ç¬¬ä¸€ä¸ªç­–ç•¥çš„è¿”å›ï¼š

```
strats = cerebro.run() 
strat0 = strats[0]
```

- ä½¿ç”¨æ‚¨æä¾›çš„åç§°æˆ–é»˜è®¤åç§°ï¼ˆpyfolioï¼‰æ£€ç´¢åˆ†æå™¨ã€‚ä¾‹å¦‚ï¼š

```
pyfolio = strats.analyzers.getbynameï¼ˆ'pyfolio'ï¼‰
```

- ä½¿ç”¨analyzersçš„get_pf_itemsæ–¹æ³•æ£€ç´¢pyfolioä»¥åéœ€è¦ç”¨åˆ°çš„4ä¸ªæ•°æ®ï¼š

```
returns, positions, transactions, gross_lev = pyfoliozer.get_pf_items()
```

- ä¸pyfolioä¸€èµ·ä½¿ç”¨ï¼ˆè¿™å·²ç»åœ¨backtraderç³»ç»Ÿä¹‹å¤–ï¼‰

ä¸€äº›ä¸backtraderæ²¡æœ‰ç›´æ¥å…³ç³»çš„ä½¿ç”¨è¯´æ˜

- pyfolioè‡ªåŠ¨ç»˜å›¾å¯åœ¨Jupyter Notebookå¤–éƒ¨ä½¿ç”¨ï¼Œä½†åœ¨å†…éƒ¨ä½¿ç”¨æ•ˆæœæœ€ä½³ã€‚
- pyfolioæ•°æ®è¡¨çš„è¾“å‡ºä¼¼ä¹æ— æ³•åœ¨Jupyter Notebookä¹‹å¤–è¿è¡Œï¼Œåªèƒ½åœ¨Notebookå†…éƒ¨å·¥ä½œã€‚Â Â 
å¦‚æœå¸Œæœ›ä½¿ç”¨pyfolioï¼Œæœ€å¥½è¿˜æ˜¯åœ¨Jupyter Notebookä¸­è¿è¡Œã€‚

### 9.2.2. ç®€å•ä»£ç 

```
... 
cerebro.addanalyzer(bt.analyzers.PyFolio, _name='pyfolio') 
... 
results = cerebro.run() 
strat = results[0] 
pyfoliozer = strat.analyzers.getbyname('pyfolio') 
returns, positions, transactions, gross_lev = pyfoliozer.get_pf_items() 
... 
... 
# pyfolio showtime 
import pyfolio as pf 
pf.create_full_tear_sheet( 
	returns, 
	positions=positions, 
	transactions=transactions, 
	gross_lev=gross_lev, 
	live_start_date='2005-05-01', # æŒ‡å®šæ—¥æœŸÂ Â 
	round_trips=True) 
# å½“å‰èŠ‚ç‚¹çš„å›¾è¡¨å°†å±•ç°
```

#### 9.2.2.1. ç›¸å…³å†…å®¹

æŸ¥çœ‹PyFolio analyzerçš„å†…éƒ¨ä½¿ç”¨çš„ç›¸å…³å‚è€ƒå†…å®¹ã€‚

## 9.3. Pyfolioé›†æˆ

Ticket #08ä¸­æå‡ºäº†å¯¹æŠ•èµ„ç»„åˆå·¥å…·pyfolioçš„é›†æˆã€‚

é‰´äºziplineå’Œpyfolioä¹‹é—´çš„ç´§å¯†é›†æˆï¼Œè¯¥æ•™ç¨‹çš„åˆå­¦è€…è®¤ä¸ºè¿™å¾ˆéš¾ï¼Œä½†æ˜¯å…¶å®pyfolioå¯ä»¥ç”¨äºå…¶ä»–ç¤ºä¾‹ã€‚

ä¸€éƒ¨åˆ†ç”¨ä¾‹å·²ç»é›†æˆåˆ°backtraderä¸­ï¼š

- AnalyzeråŸºç¡€ç»“æ„
- å­Analyzer
- TimeReturn Analyzer

åªéœ€ä¸€ä¸ªä¸»PyFolio Analyzerå’Œ3ä¸ªç®€æ˜“çš„å­Analyzerï¼ŒåŠ ä¸Šä¸€ä¸ªpyfolioæ–¹æ³•ï¼Œä»¥åŠå®ƒçš„ä¾èµ–åº“pandasã€‚

é¦–å…ˆæ›´æ–°æ‰€æœ‰ä¾èµ–é¡¹ï¼š

- æ›´æ–°pandas
- æ›´æ–°numpy
- æ›´æ–°scikit-lean
- æ›´æ–°seaborn

åœ¨ç±»Unixç¯å¢ƒä¸‹ï¼Œæ—¶é—´å®Œå…¨å–å†³äºCç¼–è¯‘å™¨ã€‚ åœ¨Windowsä¸‹ï¼Œç”šè‡³å®‰è£…äº†ç‰¹å®šçš„Microsoftç¼–è¯‘å™¨ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºPython 2.7ï¼‰å¯èƒ½ä¼šå¤±è´¥ã€‚ ä½†æ˜¯:ä¸€ä¸ªçŸ¥åç«™ç‚¹æ”¶é›†äº†Windowsçš„æœ€æ–°è½¯ä»¶åŒ…ã€‚ å¦‚æœéœ€è¦ï¼Œè¯·è®¿é—®å®ƒï¼š [http://www.lfd.uci.edu/~gohlke/pythonlibs/](http://www.lfd.uci.edu/~gohlke/pythonlibs/)

å¦‚æœæµ‹è¯•ä¸é€šè¿‡ï¼Œé›†æˆå°†æ— æ³•å®Œæˆï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆé€šå¸¸æ ·ä¾‹éƒ½é€‰æ‹©æœ€æ–°çš„ã€‚

### 9.3.1. ä¸ä½¿ç”¨PyFolio

è¯¥ç¤ºä¾‹ä½¿ç”¨random.randintå†³å®šä½•æ—¶ä¹°å…¥/å–å‡ºï¼Œè¿™åªæ˜¯ä¸€ä¸ªç®€å•èƒ½è·‘èµ·æ¥çš„ä¾‹å­ï¼š

```
$ ./pyfoliotest.py --printout --no-pyfolio --plot
```

è¾“å‡ºï¼š

```
Len,Datetime,Open,High,Low,Close,Volume,OpenInterest 
0001,2005-01-03T23:59:59,38.36,38.90,37.65,38.18,25482800.00,0.00 
ä¹°å…¥ 1000 @%23.58 
0002,2005-01-04T23:59:59,38.45,38.54,36.46,36.58,26625300.00,0.00 
ä¹°å…¥ 1000 @%36.58 
å–å‡º 500 @%22.47 
0003,2005-01-05T23:59:59,36.69,36.98,36.06,36.13,18469100.00,0.00 
... 
å–å‡º 500 @%37.51 
0502,2006-12-28T23:59:59,25.62,25.72,25.30,25.36,11908400.00,0.00 
0503,2006-12-29T23:59:59,25.42,25.82,25.33,25.54,16297800.00,0.00 
å–å‡º 250 @%17.14 
å–å‡º 250 @%37.01
```

åœ¨2å¹´çš„é»˜è®¤æ—¶é—´å‘¨æœŸå†…ï¼Œéšæœºé€‰æ‹©äº†3ä¸ªæ•°æ®å’Œå‡ ä¸ªä¹°å…¥å’Œå–å‡ºæ“ä½œã€‚

### 9.3.2. ä½¿ç”¨PyFolio

å½“åœ¨Jupyter Notebookå†…è¿è¡Œï¼ˆåŒ…æ‹¬å†…è”ç»˜å›¾ï¼‰æ—¶ï¼Œpyfolioæ•ˆæœå¾ˆå¥½ã€‚Â Â 
æ³¨æ„ï¼šrunstratä½œä¸ºå‚æ•°ä¸æ­¤å¤„[]ä¸€èµ·ä½¿ç”¨ï¼Œåˆ™è·³è¿‡ä¼ é€’çš„å‚æ•°ï¼Œä½¿ç”¨é»˜è®¤å‚æ•°è¿è¡Œã€‚

```python
!pip install pyfolio -i https://mirrors.cloud.tencent.com/pypi/simple
```

```
Looking in indexes: https://mirrors.cloud.tencent.com/pypi/simple
Requirement already satisfied: pyfolio in /opt/conda/lib/python3.6/site-packages (0.9.2)
Requirement already satisfied: scipy>=0.14.0 in /opt/conda/lib/python3.6/site-packages (from pyfolio) (1.2.0)
Requirement already satisfied: numpy>=1.11.1 in /opt/conda/lib/python3.6/site-packages (from pyfolio) (1.16.3)
Requirement already satisfied: empyrical>=0.5.0 in /opt/conda/lib/python3.6/site-packages (from pyfolio) (0.5.5)
Requirement already satisfied: pytz>=2014.10 in /opt/conda/lib/python3.6/site-packages (from pyfolio) (2019.1)
Requirement already satisfied: scikit-learn>=0.16.1 in /opt/conda/lib/python3.6/site-packages (from pyfolio) (0.21.1)
Requirement already satisfied: seaborn>=0.7.1 in /opt/conda/lib/python3.6/site-packages (from pyfolio) (0.9.0)
Requirement already satisfied: pandas>=0.18.1 in /opt/conda/lib/python3.6/site-packages (from pyfolio) (0.24.2)
Requirement already satisfied: ipython>=3.2.3 in /opt/conda/lib/python3.6/site-packages (from pyfolio) (7.2.0)
Requirement already satisfied: matplotlib>=1.4.0 in /opt/conda/lib/python3.6/site-packages (from pyfolio) (3.1.1)
Requirement already satisfied: pandas-datareader>=0.2 in /opt/conda/lib/python3.6/site-packages (from empyrical>=0.5.0->pyfolio) (0.10.0)
Requirement already satisfied: setuptools>=18.5 in /opt/conda/lib/python3.6/site-packages (from ipython>=3.2.3->pyfolio) (49.2.0)
Requirement already satisfied: jedi>=0.10 in /opt/conda/lib/python3.6/site-packages (from ipython>=3.2.3->pyfolio) (0.13.2)
Requirement already satisfied: decorator in /opt/conda/lib/python3.6/site-packages (from ipython>=3.2.3->pyfolio) (4.4.2)
Requirement already satisfied: pickleshare in /opt/conda/lib/python3.6/site-packages (from ipython>=3.2.3->pyfolio) (0.7.5)
Requirement already satisfied: traitlets>=4.2 in /opt/conda/lib/python3.6/site-packages (from ipython>=3.2.3->pyfolio) (4.3.3)
Requirement already satisfied: prompt_toolkit<2.1.0,>=2.0.0 in /opt/conda/lib/python3.6/site-packages (from ipython>=3.2.3->pyfolio) (2.0.7)
Requirement already satisfied: pygments in /opt/conda/lib/python3.6/site-packages (from ipython>=3.2.3->pyfolio) (2.3.1)
Requirement already satisfied: backcall in /opt/conda/lib/python3.6/site-packages (from ipython>=3.2.3->pyfolio) (0.1.0)
Requirement already satisfied: pexpect in /opt/conda/lib/python3.6/site-packages (from ipython>=3.2.3->pyfolio) (4.6.0)
Requirement already satisfied: parso>=0.3.0 in /opt/conda/lib/python3.6/site-packages (from jedi>=0.10->ipython>=3.2.3->pyfolio) (0.3.1)
Requirement already satisfied: kiwisolver>=1.0.1 in /opt/conda/lib/python3.6/site-packages (from matplotlib>=1.4.0->pyfolio) (1.1.0)
Requirement already satisfied: python-dateutil>=2.1 in /opt/conda/lib/python3.6/site-packages (from matplotlib>=1.4.0->pyfolio) (2.8.1)
Requirement already satisfied: pyparsing!=2.0.4,!=2.1.2,!=2.1.6,>=2.0.1 in /opt/conda/lib/python3.6/site-packages (from matplotlib>=1.4.0->pyfolio) (2.1.10)
Requirement already satisfied: cycler>=0.10 in /opt/conda/lib/python3.6/site-packages (from matplotlib>=1.4.0->pyfolio) (0.10.0)
Requirement already satisfied: six in /opt/conda/lib/python3.6/site-packages (from cycler>=0.10->matplotlib>=1.4.0->pyfolio) (1.15.0)
Requirement already satisfied: requests>=2.19.0 in /opt/conda/lib/python3.6/site-packages (from pandas-datareader>=0.2->empyrical>=0.5.0->pyfolio) (2.26.0)
Requirement already satisfied: lxml in /opt/conda/lib/python3.6/site-packages (from pandas-datareader>=0.2->empyrical>=0.5.0->pyfolio) (4.2.1)
Requirement already satisfied: wcwidth in /opt/conda/lib/python3.6/site-packages (from prompt_toolkit<2.1.0,>=2.0.0->ipython>=3.2.3->pyfolio) (0.1.7)
Requirement already satisfied: urllib3<1.27,>=1.21.1 in /opt/conda/lib/python3.6/site-packages (from requests>=2.19.0->pandas-datareader>=0.2->empyrical>=0.5.0->pyfolio) (1.26.6)
Requirement already satisfied: charset-normalizer~=2.0.0 in /opt/conda/lib/python3.6/site-packages (from requests>=2.19.0->pandas-datareader>=0.2->empyrical>=0.5.0->pyfolio) (2.0.4)
Requirement already satisfied: certifi>=2017.4.17 in /opt/conda/lib/python3.6/site-packages (from requests>=2.19.0->pandas-datareader>=0.2->empyrical>=0.5.0->pyfolio) (2021.5.30)
Requirement already satisfied: idna<4,>=2.5 in /opt/conda/lib/python3.6/site-packages (from requests>=2.19.0->pandas-datareader>=0.2->empyrical>=0.5.0->pyfolio) (3.2)
Requirement already satisfied: joblib>=0.11 in /opt/conda/lib/python3.6/site-packages (from scikit-learn>=0.16.1->pyfolio) (0.13.2)
Requirement already satisfied: ipython-genutils in /opt/conda/lib/python3.6/site-packages (from traitlets>=4.2->ipython>=3.2.3->pyfolio) (0.2.0)
Requirement already satisfied: ptyprocess>=0.5 in /opt/conda/lib/python3.6/site-packages (from pexpect->ipython>=3.2.3->pyfolio) (0.6.0)
[33mWARNING: You are using pip version 20.3.3; however, version 21.3.1 is available.
You should consider upgrading via the '/opt/conda/bin/python -m pip install --upgrade pip' command.[0m
```

```python
%matplotlib inline
```

```python
from __future__ import (absolute_import, division, print_function,
                        unicode_literals)


import argparse
import datetime
import random

import backtrader as bt


class St(bt.Strategy):
    params = (
        ('printout', False),
        ('stake', 1000),
    )

    def __init__(self):
        pass

    def start(self):
        if self.p.printout:
            txtfields = list()
            txtfields.append('Len')
            txtfields.append('Datetime')
            txtfields.append('Open')
            txtfields.append('High')
            txtfields.append('Low')
            txtfields.append('Close')
            txtfields.append('Volume')
            txtfields.append('OpenInterest')
            print(','.join(txtfields))

    def next(self):
        if self.p.printout:
            # Print only 1st data ... is just a check that things are running
            txtfields = list()
            txtfields.append('%04d' % len(self))
            txtfields.append(self.data.datetime.datetime(0).isoformat())
            txtfields.append('%.2f' % self.data0.open[0])
            txtfields.append('%.2f' % self.data0.high[0])
            txtfields.append('%.2f' % self.data0.low[0])
            txtfields.append('%.2f' % self.data0.close[0])
            txtfields.append('%.2f' % self.data0.volume[0])
            txtfields.append('%.2f' % self.data0.openinterest[0])
            print(','.join(txtfields))

        # Data 0
        for data in self.datas:
            toss = random.randint(1, 10)
            curpos = self.getposition(data)
            if curpos.size:
                if toss > 5:
                    size = curpos.size // 2
                    self.sell(data=data, size=size)
                    if self.p.printout:
                        print('SELL {} @%{}'.format(size, data.close[0]))

            elif toss < 5:
                self.buy(data=data, size=self.p.stake)
                if self.p.printout:
                    print('BUY  {} @%{}'.format(self.p.stake, data.close[0]))


def runstrat(args=None):
    args = parse_args(args)

    cerebro = bt.Cerebro()
    cerebro.broker.set_cash(args.cash)

    dkwargs = dict()
    if args.fromdate:
        fromdate = datetime.datetime.strptime(args.fromdate, '%Y-%m-%d')
        dkwargs['fromdate'] = fromdate

    if args.todate:
        todate = datetime.datetime.strptime(args.todate, '%Y-%m-%d')
        dkwargs['todate'] = todate

    data0 = bt.feeds.BacktraderCSVData(dataname=args.data0, **dkwargs)
    cerebro.adddata(data0, name='Data0')

    data1 = bt.feeds.BacktraderCSVData(dataname=args.data1, **dkwargs)
    cerebro.adddata(data1, name='Data1')

    data2 = bt.feeds.BacktraderCSVData(dataname=args.data2, **dkwargs)
    cerebro.adddata(data2, name='Data2')

    cerebro.addstrategy(St, printout=args.printout)
    if not args.no_pyfolio:
        cerebro.addanalyzer(bt.analyzers.PyFolio, _name='pyfolio')

    results = cerebro.run()
    if not args.no_pyfolio:
        strat = results[0]
        pyfoliozer = strat.analyzers.getbyname('pyfolio')

        returns, positions, transactions, gross_lev = pyfoliozer.get_pf_items()
        if args.printout:
            print('-- RETURNS')
            print(returns)
            print('-- POSITIONS')
            print(positions)
            print('-- TRANSACTIONS')
            print(transactions)
            print('-- GROSS LEVERAGE')
            print(gross_lev)

        import pyfolio as pf
        pf.create_full_tear_sheet(
            returns,
            positions=positions,
            transactions=transactions,
            live_start_date='2005-05-01')

    if args.plot:
        cerebro.plot(style=args.plot_style)


def parse_args(args=None):

    parser = argparse.ArgumentParser(
        formatter_class=argparse.ArgumentDefaultsHelpFormatter,
        description='Sample for pivot point and cross plotting')

    parser.add_argument('--data0', required=False,
                        default='yhoo-1996-2015.txt',
                        help='Data to be read in')

    parser.add_argument('--data1', required=False,
                        default='orcl-1995-2014.txt',
                        help='Data to be read in')

    parser.add_argument('--data2', required=False,
                        default='nvda-1999-2014.txt',
                        help='Data to be read in')

    parser.add_argument('--fromdate', required=False,
                        default='2005-01-01',
                        help='Starting date in YYYY-MM-DD format')

    parser.add_argument('--todate', required=False,
                        default='2006-12-31',
                        help='Ending date in YYYY-MM-DD format')

    parser.add_argument('--printout', required=False, action='store_true',
                        help=('Print data lines'))

    parser.add_argument('--cash', required=False, action='store',
                        type=float, default=50000,
                        help=('Cash to start with'))

    parser.add_argument('--plot', required=False, action='store_true',
                        help=('Plot the result'))

    parser.add_argument('--plot-style', required=False, action='store',
                        default='bar', choices=['bar', 'candle', 'line'],
                        help=('Plot style'))

    parser.add_argument('--no-pyfolio', required=False, action='store_true',
                        help=('Do not do pyfolio things'))

    import sys
    aargs = args if args is not None else sys.argv[1:]
    return parser.parse_args(aargs)
```

```python
runstrat([])
```
| Start date | 2005-01-03 |  |  |  |
| --- | --- | --- | --- | --- |
| End date | 2006-12-29 |  |  |  |
| In-sample months | 3 |  |  |  |
| Out-of-sample months | 20 |  |  |  |
|  | All | In-sample | Out-of-sample |  |
| Annual return | -1.7% | -10.0% | 0.0% |  |
| Cumulative returns | -3.3% | -3.4% | 0.0% |  |
| Annual volatility | 2.8% | 6.9% | 0.0% |  |
| Sharpe ratio | -0.60 | -1.49 | 0.54 |  |
| Calmar ratio | -0.39 | -2.31 | 0.48 |  |
| Stability | 0.00 | 0.00 | 0.37 |  |
| Max drawdown | -4.3% | -4.3% | -0.0% |  |
| Omega ratio | 0.44 | 0.41 | 1.10 |  |
| Sortino ratio | -0.61 | -1.54 | 0.73 |  |
| Skew | -18.98 | -7.52 | -0.93 |  |
| Kurtosis | 403.13 | 61.80 | 5.91 |  |
| Tail ratio | 1.17 | 0.60 | 0.93 |  |
| Daily value at risk | -0.4% | -0.9% | -0.0% |  |
| Gross leverage | 0.00 | 0.01 | 0.00 |  |
| Daily turnover | inf% | inf% | 0.0% |  |


```
/opt/conda/lib/python3.6/site-packages/numpy/core/fromnumeric.py:56: FutureWarning: 
The current behaviour of 'Series.argmin' is deprecated, use 'idxmin'
instead.
The behavior of 'argmin' will be corrected to return the positional
minimum in the future. For now, use 'series.values.argmin' or
'np.argmin(np.array(values))' to get the position of the minimum
row.
  return getattr(obj, method)(*args, **kwds)
```
| Worst drawdown periods | Net drawdown in % | Peak date | Valley date | Recovery date | Duration |
| --- | --- | --- | --- | --- | --- |
| 0 | 4.34 | 2005-01-03 | 2005-01-06 | NaT | NaN |
| 1 | 0.00 | 2005-01-03 | 2005-01-03 | 2005-01-03 | 1 |
| 2 | 0.00 | 2005-01-03 | 2005-01-03 | 2005-01-03 | 1 |
| 3 | 0.00 | 2005-01-03 | 2005-01-03 | 2005-01-03 | 1 |
| 4 | 0.00 | 2005-01-03 | 2005-01-03 | 2005-01-03 | 1 |


```
/opt/conda/lib/python3.6/site-packages/numpy/core/fromnumeric.py:56: FutureWarning: 
The current behaviour of 'Series.argmin' is deprecated, use 'idxmin'
instead.
The behavior of 'argmin' will be corrected to return the positional
minimum in the future. For now, use 'series.values.argmin' or
'np.argmin(np.array(values))' to get the position of the minimum
row.
  return getattr(obj, method)(*args, **kwds)
```
| Stress Events | mean | min | max |
| --- | --- | --- | --- |
| Low Volatility Bull Market | -0.01% | -3.74% | 0.65% |

| Top 10 long positions of all time | max |
| --- | --- |
| Data2 | 16.53% |

| Top 10 short positions of all time | max |
| --- | --- |

| Top 10 positions of all time | max |
| --- | --- |
| Data2 | 16.53% |


```
/opt/conda/lib/python3.6/site-packages/numpy/lib/function_base.py:3405: RuntimeWarning: All-NaN slice encountered
  r = func(a, **kwargs)
/opt/conda/lib/python3.6/site-packages/pyfolio/tears.py:779: UserWarning: Unable to generate turnover plot.
  warnings.warn('Unable to generate turnover plot.', UserWarning)
```

![](https://cdn.kesci.com/upload/rt/BE0D122401094CE18BE49F3858F7D33B/rm5p4pqzrv.png#crop=0&crop=0&crop=1&crop=1&id=Zt552&originHeight=3286&originWidth=937&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

![](https://cdn.kesci.com/upload/rt/BE0D122401094CE18BE49F3858F7D33B/rm5p4pt8jt.png#crop=0&crop=0&crop=1&crop=1&id=VXQli&originHeight=384&originWidth=398&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

![](https://cdn.kesci.com/upload/rt/BE0D122401094CE18BE49F3858F7D33B/rm5p4rwrsq.png#crop=0&crop=0&crop=1&crop=1&id=f6ArL&originHeight=1852&originWidth=870&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

![](https://cdn.kesci.com/upload/rt/BE0D122401094CE18BE49F3858F7D33B/rm5p4srtc6.png#crop=0&crop=0&crop=1&crop=1&id=IEy1G&originHeight=1237&originWidth=885&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

# å. è§‚å¯Ÿè€…ï¼ˆObserversï¼‰

## 10.1. è§‚å¯Ÿè€…ä¸ç»Ÿè®¡

backtraderå†…éƒ¨æ‰§è¡Œç­–ç•¥ï¼Œä¸»è¦å¤„ç†äº¤æ˜“æ•°æ®å’ŒæŒ‡æ ‡ã€‚ äº¤æ˜“æ•°æ®è¢«æ·»åŠ åˆ° Cerebroå®ä¾‹ä¸­ï¼Œå¹¶æœ€ç»ˆæˆä¸ºç­–ç•¥è¾“å…¥çš„ä¸€éƒ¨åˆ†ï¼ˆè¢«è§£æå¹¶åšä¸ºå®åŠ›çš„Â Â 
å±æ€§ä½¿ç”¨ï¼‰ï¼Œè€ŒæŒ‡æ ‡åˆ™ç”±ç­–ç•¥æœ¬èº«å£°æ˜å’Œç®¡ç†ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰€æœ‰backtraderæ ·æœ¬å›¾éƒ½ç»˜åˆ¶äº†3æ ·ä¸œè¥¿ï¼š

- ç°é‡‘å’Œä»·å€¼ï¼ˆç»çºªäººçš„é’±å˜åŠ¨æƒ…å†µï¼‰
- äº¤æ˜“ï¼ˆåˆåæ“ä½œï¼‰
- ä¹°å–ä¸‹å•

è§‚å¯Ÿè€…å­˜åœ¨äºå­æ¨¡å—backtrader.observersä¸­ã€‚ Cerebroæœ‰å‚æ•°æ”¯æŒè‡ªåŠ¨æ·»åŠ ï¼ˆæˆ–ä¸æ·»åŠ ï¼‰åˆ°ç­–ç•¥ä¸­ï¼š

- stdstatsï¼ˆé»˜è®¤å€¼ï¼šTrueï¼‰ å¦‚æœéµå®ˆé»˜è®¤è®¾ç½®ï¼Œåˆ™ Cerebroå°†æ‰§è¡Œä»¥ä¸‹ç­‰æ•ˆçš„ä»£ç ï¼š

```
import backtrader as bt 
... 
cerebro = bt.Cerebro() #é»˜è®¤å‚æ•°: stdstats=True 
cerebro.addobserver(bt.observers.Broker) 
cerebro.addobserver(bt.observers.Trades) 
cerebro.addobserver(bt.observers.BuySell)
```

æˆ‘ä»¬æ¥çœ‹çœ‹å¸¦æœ‰è¿™ä¸‰ä¸ªé»˜è®¤è§‚å¯Ÿè€…çš„å¸¸è§„å›¾è¡¨ï¼ˆå³ä½¿æ²¡æœ‰å‘å‡ºä»»ä½•è®¢å•ï¼Œå› æ­¤ä¹Ÿæ²¡æœ‰äº¤æ˜“å‘ç”Ÿï¼Œç°é‡‘å’ŒæŠ•èµ„ç»„åˆä»·å€¼ä¹Ÿæ²¡æœ‰å˜åŒ–ï¼‰

```
import backtrader as bt import backtrader.feeds as btfeeds
if name == 'main': cerebro = bt.Cerebro(stdstats=False) cerebro.addstrategy(bt.Strategy) data = 
bt.feeds.BacktraderCSVData(dataname='../../datas/2006-day-001.txt') cerebro.adddata(data)
```

```
cerebro.run() 
cerebro.plot()
```

```
![](http://stoi.jusiu.com/bt/observers-default.png) 
ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨åˆ›å»ºCerebroå®ä¾‹æ—¶å°†stdstatsçš„å€¼æ›´æ”¹ä¸ºFalseï¼ˆä¹Ÿå¯ä»¥åœ¨è°ƒç”¨runæ—¶å®Œæˆï¼‰ï¼šÂ Â 
```python 
cerebro = bt.Cerebro(stdstats=False)
```

å›¾è¡¨ç°åœ¨æœ‰æ‰€ä¸åŒã€‚

---

